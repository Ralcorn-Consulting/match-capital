<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Match Capital — Find the right investors. Skip the noise.</title>
<meta name="description" content="The most comprehensive investor intelligence tool for founders. Search 150+ investors by stage, sector, check size, geography, and more. Free and open.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://hq.ralcorporation.com">
<meta property="og:title" content="Match Capital — Find the right investors. Skip the noise.">
<meta property="og:description" content="Search 150+ investors by stage, sector, check size, and more. The smartest way to find your next funding partner.">
<meta property="og:image" content="https://hq.ralcorporation.com/og-image.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Match Capital — Investor Discovery for Founders">
<meta name="twitter:description" content="Search 150+ investors by stage, sector, check size, and more. Free investor intelligence.">
<meta name="twitter:image" content="https://hq.ralcorporation.com/og-image.png">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#6366f1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Match Capital">
<link rel="apple-touch-icon" href="/icon-192.png">
<script>
// Prevent FOUC: apply theme before render
(function(){var t=localStorage.getItem('mc_theme')||(window.matchMedia('(prefers-color-scheme:light)').matches?'light':'dark');document.documentElement.setAttribute('data-theme',t)})();
</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07070a;--bg-subtle:#0c0c10;--card:#101014;--card-hover:#16161c;
  --border:rgba(255,255,255,0.05);--border-hover:rgba(255,255,255,0.1);
  --text:#ededf0;--text-muted:#8b8b9a;--text-dim:#5a5a6e;
  --accent:#6366f1;--accent-light:#818cf8;--accent2:#a855f7;--accent2-light:#c084fc;
  --green:#10b981;--green-bg:rgba(16,185,129,0.08);
  --radius:14px;--radius-sm:10px;
  --font-mono:'JetBrains Mono',monospace;
  --transition-base:0.2s cubic-bezier(0.4,0,0.2,1);
  --transition-spring:0.4s cubic-bezier(0.16,1,0.3,1);
  --shadow-card:0 1px 2px rgba(0,0,0,0.3),0 4px 16px rgba(0,0,0,0.2);
  --shadow-card-hover:0 8px 40px rgba(0,0,0,0.4),0 0 24px rgba(99,102,241,0.08);
}
/* Light theme */
[data-theme="light"]{
  --bg:#f8f8fa;--bg-subtle:#f0f0f4;--card:#ffffff;--card-hover:#f5f5fa;
  --border:rgba(0,0,0,0.08);--border-hover:rgba(0,0,0,0.15);
  --text:#1a1a2e;--text-muted:#5a5a72;--text-dim:#8888a0;
  --accent:#4f46e5;--accent-light:#6366f1;--accent2:#9333ea;--accent2-light:#a855f7;
  --green:#059669;--green-bg:rgba(5,150,105,0.08);
  --shadow-card:0 1px 3px rgba(0,0,0,0.06),0 2px 8px rgba(0,0,0,0.04);
  --shadow-card-hover:0 8px 30px rgba(0,0,0,0.1),0 0 20px rgba(79,70,229,0.06);
}
[data-theme="light"] body{-webkit-font-smoothing:auto}
[data-theme="light"] nav{background:rgba(248,248,250,0.85)}
[data-theme="light"] .filter-bar{background:rgba(248,248,250,0.92)}
[data-theme="light"] .modal-overlay.open.animate-in{background:rgba(0,0,0,0.4)}
[data-theme="light"] .compare-bar{background:rgba(248,248,250,0.95)}
[data-theme="light"] .investor-card .avatar,
[data-theme="light"] .modal-avatar,
[data-theme="light"] .similar-card .sim-avatar,
[data-theme="light"] .compare-bar .mini-avatar{background:linear-gradient(135deg,#4f46e5,#9333ea,#db2777)}
[data-theme="light"] .gradient-text{background:linear-gradient(135deg,#4f46e5,#9333ea,#db2777);-webkit-background-clip:text;background-clip:text}
[data-theme="light"] .skeleton-line{background:linear-gradient(90deg,rgba(0,0,0,0.04) 25%,rgba(0,0,0,0.08) 50%,rgba(0,0,0,0.04) 75%);background-size:800px;animation:shimmer 1.5s infinite linear}
[data-theme="light"] .skeleton-circle{background:linear-gradient(90deg,rgba(0,0,0,0.04) 25%,rgba(0,0,0,0.08) 50%,rgba(0,0,0,0.04) 75%);background-size:800px;animation:shimmer 1.5s infinite linear}
[data-theme="light"] ::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.15)}
[data-theme="light"] ::selection{background:rgba(79,70,229,0.2)}
[data-theme="light"] #hero::before{background:radial-gradient(ellipse at center,rgba(79,70,229,0.08) 0%,rgba(147,51,234,0.04) 40%,transparent 70%)}
[data-theme="light"] .tag{background:rgba(0,0,0,0.03)}
[data-theme="light"] .tag-stage{background:rgba(79,70,229,0.06);color:#4338ca}
[data-theme="light"] .tag-sector,.sector-tags .tag-sector{background:rgba(147,51,234,0.06);color:#7e22ce}
[data-theme="light"] .type-vc{background:rgba(79,70,229,0.08);color:#4338ca}
[data-theme="light"] .type-angel{background:rgba(234,179,8,0.1);color:#a16207}
[data-theme="light"] .type-family-office{background:rgba(5,150,105,0.08);color:#047857}
[data-theme="light"] .type-corp-vc{background:rgba(147,51,234,0.08);color:#7e22ce}
[data-theme="light"] .type-angel-group{background:rgba(234,88,12,0.08);color:#c2410c}
[data-theme="light"] .chip.active{background:rgba(79,70,229,0.08);border-color:rgba(79,70,229,0.3);color:#4338ca}
[data-theme="light"] .active-chip{background:rgba(79,70,229,0.08);border-color:rgba(79,70,229,0.2);color:#4338ca}
[data-theme="light"] .social-proof{background:rgba(0,0,0,0.02);border-color:rgba(0,0,0,0.06)}
[data-theme="light"] .fund-info-item{background:rgba(0,0,0,0.02)}
[data-theme="light"] .similar-card{background:rgba(0,0,0,0.02);border-color:rgba(0,0,0,0.06)}
[data-theme="light"] .btn-primary{box-shadow:0 0 20px rgba(79,70,229,0.2),0 1px 2px rgba(0,0,0,0.1)}
[data-theme="light"] footer{background:var(--bg-subtle)}
/* Theme toggle button */
.theme-toggle{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.1rem;transition:all var(--transition-base);background:rgba(255,255,255,0.04);border:1px solid var(--border)}
.theme-toggle:hover{background:rgba(255,255,255,0.08);border-color:var(--border-hover);transform:scale(1.1)}
[data-theme="light"] .theme-toggle{background:rgba(0,0,0,0.04)}
[data-theme="light"] .theme-toggle:hover{background:rgba(0,0,0,0.08)}
#helpBtn{font-weight:700;font-size:1rem;font-family:var(--font-mono,monospace)}
.shortcuts-overlay{position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;opacity:0;transition:opacity .2s}
.shortcuts-overlay.open{display:flex;opacity:1}
.shortcuts-modal{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px 32px;max-width:520px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,0.4);animation:modalIn .25s ease}
.shortcuts-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.shortcuts-header h2{margin:0;font-size:1.25rem;color:var(--text)}
.shortcuts-close{background:none;border:none;color:var(--text-muted);font-size:1.5rem;cursor:pointer;padding:4px 8px;border-radius:6px}
.shortcuts-close:hover{background:rgba(255,255,255,0.1);color:var(--text)}
.shortcuts-group{margin-bottom:20px}
.shortcuts-group h3{font-size:.85rem;text-transform:uppercase;letter-spacing:.08em;color:var(--accent,#6c63ff);margin:0 0 10px}
.shortcut-row{display:flex;align-items:center;gap:8px;padding:6px 0;color:var(--text-muted);font-size:.9rem}
.shortcut-row kbd{display:inline-block;min-width:28px;text-align:center;padding:3px 8px;background:rgba(255,255,255,0.08);border:1px solid var(--border);border-radius:6px;font-family:var(--font-mono,monospace);font-size:.8rem;color:var(--text);box-shadow:0 1px 2px rgba(0,0,0,0.2)}
[data-theme="light"] .shortcut-row kbd{background:rgba(0,0,0,0.06);box-shadow:0 1px 2px rgba(0,0,0,0.1)}
.shortcut-row code{padding:2px 6px;background:rgba(108,99,255,0.15);border-radius:4px;font-size:.8rem;color:var(--accent,#6c63ff)}

html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;letter-spacing:-0.01em}
a{color:var(--accent-light);text-decoration:none;transition:color var(--transition-base)}
a:hover{color:var(--accent2-light)}
button{font-family:inherit;cursor:pointer;border:none;background:none;color:inherit;transition:all var(--transition-base)}
input{font-family:inherit;color:inherit}
::selection{background:rgba(99,102,241,0.3)}

/* Gradient text */
.gradient-text{background:linear-gradient(135deg,var(--accent-light),var(--accent2),#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

/* Container */
.container{max-width:1200px;margin:0 auto;padding:0 24px}

/* ===== NAV ===== */
nav{position:fixed;top:0;left:0;right:0;z-index:100;background:rgba(7,7,10,0.75);backdrop-filter:blur(24px) saturate(1.5);border-bottom:1px solid var(--border)}
nav .inner{display:flex;align-items:center;justify-content:space-between;height:60px;max-width:1200px;margin:0 auto;padding:0 24px}
.logo{font-weight:900;font-size:1.15rem;letter-spacing:-0.03em}
.nav-links{display:flex;gap:4px;align-items:center}
.nav-links a,.nav-links button{padding:7px 14px;border-radius:var(--radius-sm);font-size:0.84rem;font-weight:500;color:var(--text-dim);transition:all var(--transition-base);letter-spacing:-0.01em}
.nav-links a:hover,.nav-links button:hover{color:var(--text);background:rgba(255,255,255,0.04)}
.nav-links .saved-count{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:0.65rem;border-radius:50%;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;margin-left:4px;font-weight:700}

/* ===== HERO ===== */
#hero{padding:180px 0 120px;text-align:center;position:relative;overflow:hidden}
#hero::before{content:'';position:absolute;top:-300px;left:50%;transform:translateX(-50%);width:1000px;height:1000px;background:radial-gradient(ellipse at center,rgba(99,102,241,0.12) 0%,rgba(168,85,247,0.06) 40%,transparent 70%);pointer-events:none;animation:heroGlow 8s ease-in-out infinite alternate}
#hero::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:radial-gradient(ellipse at 20% 50%,rgba(236,72,153,0.04),transparent 50%),radial-gradient(ellipse at 80% 50%,rgba(99,102,241,0.04),transparent 50%);pointer-events:none}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes heroGlow{0%{opacity:0.7;transform:translateX(-50%) scale(1)}100%{opacity:1;transform:translateX(-50%) scale(1.05)}}
#hero h1{font-size:clamp(2.8rem,6.5vw,4.5rem);font-weight:900;letter-spacing:-0.04em;line-height:1.05;margin-bottom:20px;position:relative}
#hero .tagline{font-size:clamp(1rem,2vw,1.2rem);color:var(--text-muted);max-width:560px;margin:0 auto 44px;line-height:1.7;letter-spacing:0}
.hero-ctas{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;position:relative}
.btn-primary{padding:12px 28px;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:600;font-size:0.9rem;transition:all var(--transition-spring);box-shadow:0 0 24px rgba(99,102,241,0.25),0 1px 2px rgba(0,0,0,0.3);letter-spacing:-0.01em}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 0 40px rgba(99,102,241,0.35),0 4px 16px rgba(0,0,0,0.3)}
.btn-primary:active{transform:translateY(0);box-shadow:0 0 16px rgba(99,102,241,0.2);transition-duration:0.1s}
.btn-secondary{padding:12px 28px;border-radius:var(--radius-sm);border:1px solid var(--border);color:var(--text-muted);font-weight:500;font-size:0.9rem;transition:all var(--transition-base);letter-spacing:-0.01em}
.btn-secondary:hover{border-color:rgba(99,102,241,0.3);color:var(--text);background:rgba(99,102,241,0.04)}
.btn-secondary:active{transform:scale(0.98);transition-duration:0.1s}

/* Browse All link */
.hero-browse{margin-top:20px;font-size:0.85rem;color:var(--text-dim)}
.hero-browse a{color:var(--accent-light);font-weight:500}
.hero-browse a:hover{color:var(--accent2-light)}

/* ===== SEARCH SECTION ===== */
#search-section{padding:60px 0 40px}
.search-header{margin-bottom:32px}
.search-bar{position:relative;margin-bottom:24px}
.search-bar input{width:100%;padding:16px 20px 16px 48px;border-radius:var(--radius);border:1px solid var(--border);background:var(--card);font-size:0.95rem;outline:none;transition:all var(--transition-base);letter-spacing:-0.005em}
.search-bar input:focus{border-color:rgba(99,102,241,0.5);box-shadow:0 0 0 3px rgba(99,102,241,0.08)}
.search-bar svg{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--text-dim);transition:color var(--transition-base)}
.search-bar:focus-within svg{color:var(--accent-light)}
.search-bar .clear-btn{position:absolute;right:16px;top:50%;transform:translateY(-50%);color:var(--text-dim);font-size:1.2rem;display:none;transition:color var(--transition-base)}
.search-bar .clear-btn:hover{color:var(--text)}
.search-bar .clear-btn.show{display:flex;align-items:center;justify-content:center}

/* Search syntax help */
.search-syntax-help{position:absolute;top:100%;left:0;right:0;margin-top:6px;padding:14px 18px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);box-shadow:0 8px 30px rgba(0,0,0,0.3);z-index:20;display:none;animation:syntaxFadeIn 0.2s ease}
.search-bar:focus-within .search-syntax-help.show{display:block}
@keyframes syntaxFadeIn{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}
.syntax-title{font-size:0.75rem;font-weight:600;color:var(--text-muted);margin-bottom:8px;letter-spacing:0.03em}
.syntax-examples{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.syntax-examples code{padding:3px 10px;border-radius:6px;font-size:0.74rem;font-family:var(--font-mono);background:rgba(99,102,241,0.08);color:var(--accent-light);border:1px solid rgba(99,102,241,0.15);cursor:pointer;transition:all 0.15s}
.syntax-examples code:hover{background:rgba(99,102,241,0.15);border-color:rgba(99,102,241,0.3)}
.syntax-hint{font-size:0.72rem;color:var(--text-dim);line-height:1.5}
.syntax-hint code{padding:2px 6px;border-radius:4px;font-size:0.72rem;font-family:var(--font-mono);background:rgba(255,255,255,0.04);color:var(--text-muted)}
[data-theme="light"] .syntax-examples code{background:rgba(79,70,229,0.06);color:#4338ca;border-color:rgba(79,70,229,0.15)}
[data-theme="light"] .syntax-examples code:hover{background:rgba(79,70,229,0.12)}
[data-theme="light"] .syntax-hint code{background:rgba(0,0,0,0.04)}
/* Active search syntax indicator */
.search-bar .syntax-active{position:absolute;right:44px;top:50%;transform:translateY(-50%);display:none;gap:4px;align-items:center}
.search-bar .syntax-active.show{display:flex}
.syntax-badge{padding:2px 8px;border-radius:10px;font-size:0.65rem;font-weight:600;font-family:var(--font-mono);background:rgba(99,102,241,0.1);color:var(--accent-light);border:1px solid rgba(99,102,241,0.2);white-space:nowrap}
[data-theme="light"] .syntax-badge{background:rgba(79,70,229,0.08);color:#4338ca;border-color:rgba(79,70,229,0.2)}

/* Filter Presets */
.preset-row{display:flex;gap:8px;padding:12px 0 4px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none}
.preset-row::-webkit-scrollbar{display:none}
.preset-btn{flex-shrink:0;padding:7px 16px;border-radius:20px;border:1px solid var(--border);background:rgba(255,255,255,0.02);font-size:0.78rem;font-weight:500;color:var(--text-muted);white-space:nowrap;transition:all var(--transition-spring);cursor:pointer}
.preset-btn:hover{border-color:rgba(99,102,241,0.3);color:var(--text);background:rgba(99,102,241,0.04)}
.preset-btn:active{transform:scale(0.95);transition-duration:0.1s}
.preset-btn.active{background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(168,85,247,0.1));border-color:rgba(99,102,241,0.4);color:var(--accent-light);box-shadow:0 0 16px rgba(99,102,241,0.1)}
[data-theme="light"] .preset-btn{background:rgba(0,0,0,0.02)}
[data-theme="light"] .preset-btn:hover{background:rgba(79,70,229,0.04)}
[data-theme="light"] .preset-btn.active{background:linear-gradient(135deg,rgba(79,70,229,0.1),rgba(147,51,234,0.08));border-color:rgba(79,70,229,0.3);color:#4338ca}
@media(max-width:600px){
  .preset-row{padding:10px 0 2px;gap:6px}
  .preset-btn{padding:8px 14px;font-size:0.76rem;min-height:36px}
}

/* Filters — sticky bar */
.filter-bar{position:sticky;top:60px;z-index:90;background:rgba(7,7,10,0.92);backdrop-filter:blur(16px);margin:0 -24px;padding:0 24px;border-bottom:1px solid transparent;transition:border-color 0.3s,box-shadow 0.3s}
.filter-bar.stuck{border-bottom-color:var(--border);box-shadow:0 4px 24px rgba(0,0,0,0.3)}
.filter-bar-header{display:flex;align-items:center;gap:12px;padding:12px 0;cursor:pointer;user-select:none}
.filter-bar-header h3{font-size:0.85rem;font-weight:600;color:var(--text-muted);display:flex;align-items:center;gap:8px;margin:0}
.filter-bar-toggle{font-size:0.65rem;color:var(--text-dim);transition:transform 0.3s}
.filter-bar-toggle.open{transform:rotate(90deg)}
.filter-count-badge{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;padding:0 6px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:0.65rem;font-weight:700;transition:all var(--transition-spring)}
.filter-count-badge.hidden{display:none}
.filter-bar-clear{font-size:0.72rem;color:#f87171;padding:4px 12px;border-radius:16px;border:1px solid rgba(239,68,68,0.2);background:rgba(239,68,68,0.05);transition:all var(--transition-base);margin-left:auto}
.filter-bar-clear:hover{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.4)}
.filter-bar-clear.hidden{display:none}
/* Active filter chips summary */
.active-chips{display:flex;flex-wrap:wrap;gap:6px;padding:0 0 10px}
.active-chips:empty{display:none}
.active-chip{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;border-radius:16px;font-size:0.72rem;font-weight:500;background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.25);color:var(--accent-light);transition:all var(--transition-base);cursor:default}
.active-chip .chip-x{cursor:pointer;color:var(--text-dim);font-size:0.8rem;margin-left:2px;transition:color 0.15s;line-height:1}
.active-chip .chip-x:hover{color:#f87171}
/* Expand/collapse animation */
.filters-collapsible{overflow:hidden;transition:max-height 0.35s cubic-bezier(0.4,0,0.2,1),opacity 0.25s ease;max-height:600px;opacity:1}
.filters-collapsible.collapsed{max-height:0;opacity:0}
.filters{display:flex;flex-direction:column;gap:14px;padding:4px 0 16px}
.filter-row{display:flex;flex-wrap:wrap;gap:7px;align-items:center}
.filter-label{font-size:0.7rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em;min-width:80px;flex-shrink:0;font-family:var(--font-mono)}
.chip{padding:6px 14px;border-radius:20px;border:1px solid var(--border);font-size:0.78rem;font-weight:500;color:var(--text-muted);transition:all var(--transition-spring);white-space:nowrap}
.chip:hover{border-color:rgba(99,102,241,0.25);color:var(--text);background:rgba(99,102,241,0.03)}
.chip:active{transform:scale(0.95);transition-duration:0.1s}
.chip.active{background:rgba(99,102,241,0.1);border-color:rgba(99,102,241,0.35);color:var(--accent-light);box-shadow:0 0 12px rgba(99,102,241,0.06)}
.chip .chip-count{font-size:0.65rem;color:var(--text-dim);margin-left:2px;font-family:var(--font-mono)}
.chip.active .chip-count{color:rgba(129,140,248,0.7)}
.filter-row select{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:var(--card);font-size:0.78rem;color:var(--text-muted);outline:none;transition:border-color var(--transition-base);cursor:pointer}
.filter-row select:hover{border-color:var(--border-hover)}
.filter-row select:focus{border-color:rgba(99,102,241,0.4)}
.filter-row input[type=range]{width:120px;accent-color:var(--accent)}
.range-display{font-size:0.78rem;color:var(--text-muted);min-width:100px;font-family:var(--font-mono)}

/* Match Panel */
.match-panel{margin:16px 0;border:1px solid var(--border);border-radius:var(--radius);background:var(--card);overflow:hidden}
.match-panel-header{display:flex;align-items:center;gap:10px;padding:14px 18px;cursor:pointer;transition:background var(--transition-base)}
.match-panel-header:hover{background:var(--card-hover)}
.match-panel-header h3{font-size:0.9rem;font-weight:600;margin:0}
.match-panel-toggle{font-size:0.65rem;color:var(--text-muted);transition:transform 0.2s}
.match-panel-toggle.open{transform:rotate(90deg)}
.match-panel-status{margin-left:auto;font-size:0.78rem;color:var(--accent-light);font-weight:500}
.match-panel-body{padding:0 18px 18px}
.match-hint{font-size:0.82rem;color:var(--text-muted);margin-bottom:14px}
.match-fields{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
/* match-fields mobile handled in main mobile block */
.match-field label{display:block;font-size:0.78rem;font-weight:600;color:var(--text-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.04em}
.match-field select{width:100%;padding:8px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:0.85rem}
.match-sector-chips{display:flex;flex-wrap:wrap;gap:6px}
.match-actions{margin-top:12px;display:flex;gap:8px}
/* Match score badge on cards */
.match-score-badge{position:absolute;top:10px;left:10px;padding:4px 10px;border-radius:20px;font-size:0.72rem;font-weight:700;letter-spacing:0.02em;z-index:2;backdrop-filter:blur(8px)}
.match-score-badge.score-high{background:rgba(16,185,129,0.15);color:#10b981;border:1px solid rgba(16,185,129,0.3)}
.match-score-badge.score-med{background:rgba(234,179,8,0.12);color:#eab308;border:1px solid rgba(234,179,8,0.25)}
.match-score-badge.score-low{background:rgba(239,68,68,0.1);color:#f87171;border:1px solid rgba(239,68,68,0.2)}
[data-theme="light"] .match-score-badge.score-high{background:rgba(5,150,105,0.1);color:#047857}
[data-theme="light"] .match-score-badge.score-med{background:rgba(202,138,4,0.1);color:#a16207}
[data-theme="light"] .match-score-badge.score-low{background:rgba(220,38,38,0.08);color:#dc2626}
/* Match score in modal */
.match-score-modal{display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:var(--radius-sm);margin-bottom:16px}
.match-score-modal.score-high{background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2)}
.match-score-modal.score-med{background:rgba(234,179,8,0.06);border:1px solid rgba(234,179,8,0.15)}
.match-score-modal.score-low{background:rgba(239,68,68,0.05);border:1px solid rgba(239,68,68,0.12)}
.match-score-number{font-size:1.6rem;font-weight:800;font-family:var(--font-mono)}
.match-score-details{font-size:0.82rem;color:var(--text-muted)}
.match-score-details strong{color:var(--text);font-weight:600}
.match-score-bar{height:4px;border-radius:2px;background:var(--border);margin-top:6px;overflow:hidden}
.match-score-bar-fill{height:100%;border-radius:2px;transition:width 0.4s ease}

/* View Switcher */
.view-switcher{display:flex;gap:2px;background:var(--border);border-radius:8px;padding:2px;margin-left:8px}
.view-switcher button{padding:5px 10px;border:none;background:transparent;color:var(--text-dim);cursor:pointer;border-radius:6px;font-size:0.78rem;transition:all var(--transition-base);display:flex;align-items:center;gap:4px}
.view-switcher button.active{background:var(--card);color:var(--text);box-shadow:0 1px 3px rgba(0,0,0,0.15)}
.view-switcher button:hover:not(.active){color:var(--text-muted)}
.view-switcher button svg{width:14px;height:14px}

/* Map View */
.map-container{display:none;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px;position:relative;overflow:hidden}
.map-container.active{display:block}
.map-svg-wrap{position:relative;width:100%;max-width:900px;margin:0 auto}
.map-svg-wrap svg{width:100%;height:auto}
.map-cluster{cursor:pointer;transition:transform 0.2s ease}
.map-cluster:hover{transform:scale(1.15)}
.map-cluster circle{transition:all 0.2s ease}
.map-cluster:hover circle{filter:brightness(1.2)}
.map-cluster text{font-family:'Inter',sans-serif;font-weight:700;fill:#fff;pointer-events:none;text-anchor:middle;dominant-baseline:central}
.map-tooltip{position:absolute;background:var(--card);border:1px solid var(--border-hover);border-radius:var(--radius-sm);padding:10px 14px;font-size:0.78rem;color:var(--text);pointer-events:none;opacity:0;transition:opacity 0.15s ease;z-index:100;max-width:240px;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.map-tooltip.visible{opacity:1}
.map-tooltip .tt-city{font-weight:700;margin-bottom:4px;font-size:0.82rem}
.map-tooltip .tt-count{color:var(--text-muted);margin-bottom:6px;font-size:0.72rem}
.map-tooltip .tt-names{color:var(--text-dim);font-size:0.72rem;line-height:1.4}
.map-legend{display:flex;gap:16px;justify-content:center;margin-top:12px;font-size:0.72rem;color:var(--text-muted)}
.map-legend-item{display:flex;align-items:center;gap:5px}
.map-legend-dot{width:10px;height:10px;border-radius:50%}
.map-hint{text-align:center;font-size:0.72rem;color:var(--text-dim);margin-top:6px}
[data-theme="light"] .map-container{box-shadow:var(--shadow-card)}
[data-theme="light"] .map-tooltip{box-shadow:0 8px 24px rgba(0,0,0,0.1)}
@media(max-width:768px){.map-container{padding:12px}.map-legend{gap:10px;flex-wrap:wrap}}

/* Results */
.results-info{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;font-size:0.82rem;color:var(--text-muted);letter-spacing:-0.005em}
.results-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:900px){.results-grid{grid-template-columns:repeat(2,1fr)}}
/* results-grid & filter-bar mobile handled in main mobile block */

/* Clear Filters */
.clear-filters-btn{padding:4px 12px;border-radius:20px;border:1px solid rgba(239,68,68,0.2);font-size:0.78rem;font-weight:500;color:#f87171;background:rgba(239,68,68,0.05);transition:all var(--transition-base);margin-left:8px}
.clear-filters-btn:hover{background:rgba(239,68,68,0.1);border-color:rgba(239,68,68,0.4)}
.clear-filters-btn:active{transform:scale(0.95)}
.filter-badge{color:var(--accent-light);font-weight:500}

/* Export buttons */
.export-controls{display:flex;gap:6px}
.btn-export{padding:5px 12px;border-radius:16px;border:1px solid var(--border);font-size:0.72rem;font-weight:500;color:var(--text-dim);background:transparent;transition:all var(--transition-base);white-space:nowrap;cursor:pointer}
.btn-export:hover{border-color:rgba(99,102,241,0.3);color:var(--text-muted);background:rgba(99,102,241,0.04)}
.btn-export:active{transform:scale(0.95)}

/* Investor Card */
.investor-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;cursor:pointer;transition:all var(--transition-spring);position:relative;overflow:hidden;box-shadow:var(--shadow-card)}
.investor-card:hover{border-color:rgba(99,102,241,0.25);background:var(--card-hover);transform:translateY(-3px);box-shadow:var(--shadow-card-hover)}
.investor-card:active{transform:translateY(-1px);transition-duration:0.1s}
.investor-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent 10%,var(--accent) 40%,var(--accent2) 60%,transparent 90%);opacity:0;transition:opacity 0.4s}
.investor-card:hover::before{opacity:0.8}
.investor-card .card-thesis{font-size:0.8rem;color:var(--text-dim);line-height:1.55;margin-bottom:10px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;letter-spacing:0}
.investor-card .sector-tags{display:flex;gap:4px;margin-bottom:10px;align-items:center}
.sector-tags .tag-sector{padding:3px 8px;border-radius:6px;font-size:0.68rem;font-weight:500;background:rgba(168,85,247,0.07);color:#c4b5fd;letter-spacing:0.01em}
.sector-tags .tag-overflow{font-size:0.68rem;color:var(--text-dim);padding:3px 6px}

/* Section transitions */
.section-transitioning{animation:sectionFadeIn 0.35s cubic-bezier(0.16,1,0.3,1) both}
@keyframes sectionFadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.section-fade-out{animation:sectionFadeOut 0.18s ease-out both}
@keyframes sectionFadeOut{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(-8px)}}
/* Card staggered animation */
@keyframes cardFadeIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.investor-card{animation:cardFadeIn 0.3s ease both}

/* Virtual scroll container */
.virtual-scroll-container{position:relative;overflow:visible}
.virtual-scroll-spacer{pointer-events:none}
.virtual-scroll-window{position:relative}
.results-grid .virtual-placeholder{visibility:hidden;pointer-events:none;min-height:0;padding:0;margin:0;border:none;box-shadow:none}
.investor-card .card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.investor-card .avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),#ec4899);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.95rem;color:#fff;flex-shrink:0;letter-spacing:-0.02em;overflow:hidden}
.avatar-img,.modal-avatar-img,.sim-avatar-img,.mini-avatar-img,.rv-avatar-img{width:100%;height:100%;object-fit:cover;border-radius:inherit}
.investor-card .active-badge{display:flex;align-items:center;gap:4px;font-size:0.7rem;color:var(--green);background:var(--green-bg);padding:4px 10px;border-radius:20px;font-weight:600}
.investor-card .active-badge .dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.investor-card .name{font-weight:700;font-size:0.95rem;margin-bottom:2px;letter-spacing:-0.02em}
.investor-card .firm{font-size:0.82rem;color:var(--text-muted);margin-bottom:12px}
.investor-card .type-badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:0.68rem;font-weight:600;margin-bottom:12px;letter-spacing:0.01em}
.type-vc{background:rgba(99,102,241,0.1);color:var(--accent-light)}
.type-angel{background:rgba(250,204,21,0.1);color:#fbbf24}
.type-family-office{background:rgba(16,185,129,0.1);color:#34d399}
.type-corp-vc{background:rgba(168,85,247,0.1);color:var(--accent2-light)}
.type-angel-group{background:rgba(251,146,60,0.1);color:#fb923c}
/* Org avatar */
.avatar-org{border-radius:var(--radius-sm) !important;background:linear-gradient(135deg,#6366f1,#8b5cf6) !important;font-size:0.7rem !important}
.member-count-badge{display:inline-flex;align-items:center;gap:3px;font-size:0.7rem;color:var(--accent);background:rgba(59,130,246,0.08);padding:3px 8px;border-radius:12px;font-weight:600}
.key-people-list{list-style:none;padding:0}
.key-people-list li{padding:4px 0;font-size:0.85rem;color:var(--text-muted)}
.investor-card .tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px}
.tag{padding:3px 8px;border-radius:6px;font-size:0.68rem;font-weight:500;background:rgba(255,255,255,0.03);color:var(--text-dim);letter-spacing:0.01em}
.tag-stage{background:rgba(99,102,241,0.07);color:#a5b4fc}
.tag-sector{background:rgba(168,85,247,0.07);color:#c4b5fd}
.investor-card .check-size{font-size:0.78rem;color:var(--text-muted);margin-bottom:4px;font-family:var(--font-mono);font-weight:500}
.portfolio-match-badge{font-size:0.74rem;color:#a78bfa;background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.2);padding:4px 10px;border-radius:14px;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.investor-card .location{font-size:0.78rem;color:var(--text-dim)}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0);backdrop-filter:blur(0px);display:none;align-items:center;justify-content:center;padding:24px;transition:background 0.4s cubic-bezier(0.4,0,0.2,1),backdrop-filter 0.4s cubic-bezier(0.4,0,0.2,1)}
.modal-overlay.open{display:flex}
.modal-overlay.open.animate-in{background:rgba(0,0,0,0.75);backdrop-filter:blur(12px)}
.modal{background:var(--bg);border:1px solid var(--border);border-radius:16px;width:100%;max-width:820px;max-height:90vh;overflow-y:auto;position:relative;opacity:0;transform:translateY(30px) scale(0.97);transition:opacity 0.4s cubic-bezier(0.4,0,0.2,1),transform 0.4s cubic-bezier(0.4,0,0.2,1)}
.modal-overlay.open.animate-in .modal{opacity:1;transform:translateY(0) scale(1)}
.modal-overlay.animate-out .modal{opacity:0;transform:translateY(20px) scale(0.97);transition:opacity 0.25s cubic-bezier(0.4,0,0.2,1),transform 0.25s cubic-bezier(0.4,0,0.2,1)}
.modal-overlay.animate-out{background:rgba(0,0,0,0);backdrop-filter:blur(0px);transition:background 0.25s cubic-bezier(0.4,0,0.2,1),backdrop-filter 0.25s cubic-bezier(0.4,0,0.2,1)}
.modal-close{position:absolute;top:16px;right:16px;font-size:1.5rem;color:var(--text-dim);z-index:1;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background 0.2s}
.modal-close:hover{background:rgba(255,255,255,0.05)}
.modal-header{padding:32px 32px 0;display:flex;gap:20px;align-items:flex-start}
.modal-avatar{width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),#ec4899);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.5rem;color:#fff;flex-shrink:0;overflow:hidden}
.modal-header-info{flex:1}
.modal-header-info h2{font-size:1.5rem;font-weight:700;margin-bottom:2px;display:flex;align-items:center;gap:8px}
.modal-header-info .firm{font-size:1rem;color:var(--text-muted);margin-bottom:8px}
.modal-header-info .badges{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.modal-body{padding:24px 32px 32px}
.modal-section{margin-bottom:24px}
.modal-section h3{font-size:0.7rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:12px;display:flex;align-items:center;gap:8px;font-family:var(--font-mono)}
.modal-section h3::after{content:'';flex:1;height:1px;background:var(--border);opacity:0.6}
.modal-section p{color:var(--text-muted);font-size:0.9rem;line-height:1.7}
.modal-tags{display:flex;flex-wrap:wrap;gap:6px}
.modal-tags .tag{padding:5px 12px;font-size:0.8rem}
.investment-list{list-style:none}
.investment-list li{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:0.9rem}
.investment-list li:last-child{border:none}
.investment-list .company{font-weight:600}
.investment-list .round-year{color:var(--text-muted)}
/* Activity Timeline */
.activity-timeline{position:relative;padding-left:28px}
.activity-timeline::before{content:'';position:absolute;left:8px;top:4px;bottom:4px;width:2px;background:linear-gradient(180deg,var(--accent),var(--accent2),var(--text-dim));border-radius:2px;opacity:0.4}
.timeline-item{position:relative;padding:10px 0 16px;opacity:0;transform:translateX(-10px);animation:timelineIn 0.4s forwards}
.timeline-item:last-child{padding-bottom:0}
@keyframes timelineIn{to{opacity:1;transform:translateX(0)}}
.timeline-dot{position:absolute;left:-24px;top:14px;width:12px;height:12px;border-radius:50%;border:2px solid var(--accent);background:var(--bg);z-index:1;transition:all 0.2s}
.timeline-item:hover .timeline-dot{background:var(--accent);box-shadow:0 0 8px rgba(99,102,241,0.5);transform:scale(1.3)}
.timeline-item.year-seed .timeline-dot{border-color:#10b981}
.timeline-item.year-seed:hover .timeline-dot{background:#10b981;box-shadow:0 0 8px rgba(16,185,129,0.5)}
.timeline-item.year-series-a .timeline-dot{border-color:var(--accent)}
.timeline-item.year-series-b .timeline-dot{border-color:var(--accent2)}
.timeline-item.year-series-b:hover .timeline-dot{background:var(--accent2);box-shadow:0 0 8px rgba(168,85,247,0.5)}
.timeline-item.year-growth .timeline-dot{border-color:#ec4899}
.timeline-item.year-growth:hover .timeline-dot{background:#ec4899;box-shadow:0 0 8px rgba(236,72,153,0.5)}
.timeline-year-label{font-size:0.7rem;font-weight:700;color:var(--accent-light);font-family:var(--font-mono);margin-bottom:6px;letter-spacing:0.05em}
.timeline-card{padding:10px 14px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.03);border:1px solid var(--border);transition:all 0.2s;cursor:default}
.timeline-item:hover .timeline-card{border-color:rgba(99,102,241,0.3);background:rgba(99,102,241,0.04)}
[data-theme="light"] .timeline-card{background:rgba(0,0,0,0.02)}
[data-theme="light"] .timeline-item:hover .timeline-card{background:rgba(79,70,229,0.04);border-color:rgba(79,70,229,0.2)}
.timeline-company{font-weight:600;font-size:0.88rem;color:var(--text)}
.timeline-round{display:inline-block;padding:2px 8px;border-radius:12px;font-size:0.7rem;font-weight:600;margin-left:8px;background:rgba(99,102,241,0.1);color:var(--accent-light)}
.timeline-round.round-seed{background:rgba(16,185,129,0.1);color:#34d399}
.timeline-round.round-series-a{background:rgba(99,102,241,0.1);color:var(--accent-light)}
.timeline-round.round-series-b{background:rgba(168,85,247,0.1);color:var(--accent2-light)}
.timeline-round.round-growth,.timeline-round.round-series-c{background:rgba(236,72,153,0.1);color:#f472b6}
[data-theme="light"] .timeline-round.round-seed{background:rgba(5,150,105,0.08);color:#047857}
[data-theme="light"] .timeline-round.round-series-a{background:rgba(79,70,229,0.08);color:#4338ca}
[data-theme="light"] .timeline-round.round-series-b{background:rgba(147,51,234,0.08);color:#7e22ce}
[data-theme="light"] .timeline-round.round-growth,[data-theme="light"] .timeline-round.round-series-c{background:rgba(219,39,119,0.08);color:#be185d}
.timeline-summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;padding:8px 12px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.02);border:1px solid var(--border);font-size:0.78rem}
[data-theme="light"] .timeline-summary{background:rgba(0,0,0,0.02)}
.timeline-stat{display:flex;align-items:center;gap:5px;color:var(--text-muted)}
.timeline-stat .stat-val{font-weight:700;color:var(--text);font-family:var(--font-mono)}
.modal-links-row{display:flex;gap:8px}
.modal-links-row a{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:1.1rem;color:var(--text-muted);transition:all 0.2s;text-decoration:none}
.modal-links-row a:hover{border-color:var(--accent);color:var(--text);background:rgba(59,130,246,0.08)}
.modal-actions{display:flex;gap:12px;margin-top:24px;padding-top:24px;border-top:1px solid var(--border)}
.btn-save{padding:10px 24px;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:600;font-size:0.9rem;transition:all 0.2s}
.btn-save:hover{box-shadow:0 0 20px rgba(59,130,246,0.3)}
.btn-save.saved{background:rgba(255,255,255,0.06);color:var(--text-muted)}
.fund-info{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.fund-info-item{background:rgba(255,255,255,0.02);border-radius:var(--radius-sm);padding:12px 16px}
.fund-info-item .label{font-size:0.75rem;color:var(--text-dim);margin-bottom:4px}
.fund-info-item .value{font-weight:600;font-size:0.9rem}
/* Profile two-column grid */
.profile-grid{display:grid;grid-template-columns:1fr 1fr;gap:0 32px}
.profile-grid .full-width{grid-column:1/-1}
.profile-col{display:flex;flex-direction:column;gap:0}
.profile-col .modal-section:last-child{margin-bottom:0}
.modal-divider{border:none;border-top:1px solid var(--border);margin:4px 0 20px;opacity:0.5}
/* Outreach CTA */
.outreach-cta{display:flex;align-items:center;gap:10px;padding:14px 18px;border-radius:var(--radius-sm);background:linear-gradient(135deg,rgba(99,102,241,0.1),rgba(168,85,247,0.08));border:1px solid rgba(99,102,241,0.2);margin-bottom:20px;cursor:pointer;transition:all var(--transition-base)}
.outreach-cta:hover{background:linear-gradient(135deg,rgba(99,102,241,0.15),rgba(168,85,247,0.12));border-color:rgba(99,102,241,0.35);transform:translateY(-1px)}
.outreach-cta .cta-icon{font-size:1.4rem;flex-shrink:0}
.outreach-cta .cta-text{flex:1}
.outreach-cta .cta-text strong{display:block;font-size:0.9rem;color:var(--text);margin-bottom:2px}
.outreach-cta .cta-text span{font-size:0.8rem;color:var(--text-muted)}
.outreach-cta .cta-arrow{font-size:1rem;color:var(--text-dim);transition:transform var(--transition-base)}
.outreach-cta.open .cta-arrow{transform:rotate(90deg)}
.outreach-panel{max-height:0;overflow:hidden;transition:max-height 0.4s cubic-bezier(0.4,0,0.2,1);margin-bottom:0}
.outreach-panel.open{max-height:1200px;margin-bottom:20px}
.outreach-inner{padding:18px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.02);border:1px solid var(--border)}
[data-theme="light"] .outreach-inner{background:rgba(0,0,0,0.02)}
[data-theme="light"] .outreach-cta{background:linear-gradient(135deg,rgba(79,70,229,0.08),rgba(147,51,234,0.06));border-color:rgba(79,70,229,0.2)}
[data-theme="light"] .outreach-cta:hover{background:linear-gradient(135deg,rgba(79,70,229,0.12),rgba(147,51,234,0.1));border-color:rgba(79,70,229,0.3)}
.outreach-form label{display:block;font-size:0.75rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:6px;font-family:var(--font-mono)}
.outreach-form input,.outreach-form textarea,.outreach-form select{width:100%;padding:10px 14px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.04);border:1px solid var(--border);color:var(--text);font-size:0.85rem;font-family:inherit;transition:border-color var(--transition-base);margin-bottom:14px;resize:vertical}
[data-theme="light"] .outreach-form input,[data-theme="light"] .outreach-form textarea,[data-theme="light"] .outreach-form select{background:rgba(0,0,0,0.03)}
.outreach-form input:focus,.outreach-form textarea:focus,.outreach-form select:focus{outline:none;border-color:var(--accent)}
.outreach-form textarea{min-height:60px}
.outreach-output{margin-top:16px;padding:16px;border-radius:var(--radius-sm);background:rgba(255,255,255,0.03);border:1px solid var(--border);font-size:0.85rem;line-height:1.7;color:var(--text-muted);white-space:pre-wrap;position:relative}
[data-theme="light"] .outreach-output{background:rgba(0,0,0,0.02)}
.outreach-output .copy-email-btn{position:absolute;top:8px;right:8px;padding:6px 12px;border-radius:6px;font-size:0.75rem;font-weight:600;background:var(--accent);color:#fff;cursor:pointer;border:none;transition:all var(--transition-base)}
.outreach-output .copy-email-btn:hover{background:var(--accent-light);transform:scale(1.05)}
.outreach-actions{display:flex;gap:8px;flex-wrap:wrap}
.outreach-actions .btn-generate{padding:10px 20px;border-radius:var(--radius-sm);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:600;font-size:0.85rem;border:none;cursor:pointer;transition:all var(--transition-base)}
.outreach-actions .btn-generate:hover{box-shadow:0 0 20px rgba(99,102,241,0.3);transform:translateY(-1px)}
.outreach-tone-chips{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px}
.outreach-tone-chips .tone-chip{padding:5px 12px;border-radius:20px;font-size:0.78rem;font-weight:500;border:1px solid var(--border);cursor:pointer;transition:all var(--transition-base)}
.outreach-tone-chips .tone-chip.active{background:rgba(99,102,241,0.1);border-color:var(--accent);color:var(--accent-light)}
.outreach-tone-chips .tone-chip:hover{border-color:var(--border-hover)}
/* Social proof */
.social-proof{display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px;padding:12px 16px;background:rgba(255,255,255,0.02);border-radius:var(--radius-sm);border:1px solid var(--border)}
.proof-item{display:flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--text-muted)}
.proof-item .proof-val{font-weight:700;color:var(--text)}
.verified-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:0.7rem;font-weight:600;background:rgba(59,130,246,0.1);color:#60a5fa}
.activity-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.activity-dot.green{background:var(--green)}
.activity-dot.yellow{background:#eab308}
.activity-dot.gray{background:#52525b}
/* Similar investors */
.similar-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
.similar-card{background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;text-align:center;transition:all 0.25s ease;cursor:pointer;position:relative;overflow:hidden}
.similar-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent);opacity:0;transition:opacity 0.3s}
.similar-card:hover{border-color:rgba(99,102,241,0.4);background:var(--card-hover);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.2)}
.similar-card:hover::before{opacity:1}
.similar-card .sim-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),#ec4899);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.8rem;color:#fff;margin:0 auto 10px;overflow:hidden}
.similar-card .sim-name{font-weight:600;font-size:0.85rem;margin-bottom:2px}
.similar-card .sim-firm{font-size:0.75rem;color:var(--text-muted);margin-bottom:4px}
.similar-card .sim-overlap{font-size:0.7rem;color:var(--text-dim);margin-bottom:8px}
.similar-card .sim-link{font-size:0.75rem;color:var(--accent);font-weight:500;transition:color 0.2s}
.similar-card:hover .sim-link{color:var(--accent2)}
.similar-card .sim-card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.similar-card .sim-card-top .sim-avatar{margin:0}
.sim-score-pill{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-size:0.7rem;font-weight:700;padding:2px 8px;border-radius:20px;white-space:nowrap}

/* Find Similar button on cards */
.find-similar-btn{display:block;width:100%;margin-top:10px;padding:6px 0;background:transparent;border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-muted);font-size:0.75rem;cursor:pointer;transition:all 0.2s;opacity:0;pointer-events:none}
.investor-card:hover .find-similar-btn,.investor-card:focus-within .find-similar-btn{opacity:1;pointer-events:auto}
.find-similar-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(99,102,241,0.05)}

/* Similar Panel (full-screen overlay) */
#similarPanel{display:none;position:fixed;top:0;left:0;right:0;bottom:0;z-index:10000}
#similarPanel.open{display:flex;align-items:center;justify-content:center}
.similar-panel-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px)}
.similar-panel-content{position:relative;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);width:90%;max-width:600px;max-height:85vh;overflow-y:auto;padding:28px;z-index:1;box-shadow:0 20px 60px rgba(0,0,0,0.4)}
.similar-panel-header h2{font-size:1.2rem;margin:0}
.similar-panel-list{margin-top:16px;display:flex;flex-direction:column;gap:8px}
.similar-panel-item{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all 0.2s}
.similar-panel-item:hover{border-color:rgba(99,102,241,0.4);background:var(--card-hover);transform:translateX(4px)}
.sim-panel-left{display:flex;align-items:center;gap:12px;flex:1;min-width:0}
.sim-panel-left .sim-avatar{flex-shrink:0}
.sim-panel-left .sim-name{font-weight:600;font-size:0.9rem}
.sim-panel-left .sim-firm{font-size:0.78rem;color:var(--text-muted)}
.sim-reasons{font-size:0.72rem;color:var(--text-dim);margin-top:2px}
.sim-score-badge{display:flex;align-items:baseline;gap:2px;font-size:1.3rem;font-weight:800;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;flex-shrink:0}
.sim-score-label{font-size:0.65rem;font-weight:500;opacity:0.7}
/* Add to list dropdown in modal header */
.modal-list-dropdown{position:relative;display:inline-block}
.modal-list-dd-content{position:absolute;top:100%;left:0;margin-top:4px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px;z-index:10;box-shadow:0 8px 30px rgba(0,0,0,0.4);min-width:200px;max-height:240px;overflow-y:auto;display:none}
.modal-list-dd-content.show{display:block}
.modal-list-dd-item{padding:8px 12px;border-radius:6px;font-size:0.82rem;color:var(--text-muted);cursor:pointer;transition:background 0.15s;display:flex;align-items:center;gap:8px}
.modal-list-dd-item:hover{background:rgba(255,255,255,0.05);color:var(--text)}
.modal-list-dd-item input[type=checkbox]{accent-color:var(--accent)}

/* ===== SAVED SECTION ===== */
#saved-section{padding:60px 0;display:none}
#saved-section h2{font-size:1.5rem;font-weight:700;margin-bottom:8px}
#saved-section .subtitle{color:var(--text-muted);margin-bottom:24px;font-size:0.9rem}
.saved-actions{display:flex;gap:12px;margin-bottom:24px}
.saved-empty{text-align:center;padding:60px 0;color:var(--text-dim)}

/* Bulk actions */
.bulk-bar{display:none;align-items:center;gap:12px;padding:10px 16px;margin-bottom:16px;background:var(--card);border:1px solid var(--accent);border-radius:var(--radius-sm);flex-wrap:wrap;animation:fadeIn 0.2s ease}
.bulk-bar.visible{display:flex}
.bulk-bar .bulk-count{font-size:0.82rem;font-weight:600;color:var(--accent-light);min-width:100px}
.bulk-bar .bulk-actions{display:flex;gap:8px;flex-wrap:wrap}
.bulk-bar .bulk-btn{padding:6px 14px;font-size:0.78rem;border-radius:8px;border:1px solid var(--border);background:var(--bg-subtle);color:var(--text-muted);font-weight:500;transition:all 0.15s}
.bulk-bar .bulk-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--card-hover)}
.bulk-bar .bulk-btn.danger:hover{border-color:#ef4444;color:#ef4444}
.bulk-select-all{display:flex;align-items:center;gap:6px;font-size:0.8rem;color:var(--text-muted);cursor:pointer;user-select:none}
.bulk-select-all input[type=checkbox]{accent-color:var(--accent);width:16px;height:16px;cursor:pointer}
.investor-card .bulk-checkbox{position:absolute;top:10px;left:10px;width:20px;height:20px;accent-color:var(--accent);cursor:pointer;z-index:5;opacity:0;transition:opacity 0.15s}
.bulk-mode .investor-card .bulk-checkbox{opacity:1}
.investor-card:hover .bulk-checkbox{opacity:0.6}
.bulk-mode .investor-card:hover .bulk-checkbox{opacity:1}
.investor-card.bulk-selected{border-color:var(--accent)!important;box-shadow:0 0 0 1px var(--accent),var(--shadow-card)!important}
.bulk-move-dropdown{position:relative;display:inline-block}
.bulk-move-menu{position:absolute;top:100%;left:0;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px 0;min-width:160px;z-index:100;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
.bulk-move-menu-item{padding:8px 14px;font-size:0.8rem;cursor:pointer;transition:background 0.1s}
.bulk-move-menu-item:hover{background:var(--card-hover)}

/* Nav active underline */
.nav-links a.nav-active,.nav-links button.nav-active{color:var(--text);position:relative}
.nav-links a.nav-active::after,.nav-links button.nav-active::after{content:'';position:absolute;bottom:-2px;left:8px;right:8px;height:2px;background:linear-gradient(90deg,var(--accent),var(--accent2),#ec4899);border-radius:2px}

/* ===== FOOTER ===== */
footer{padding:60px 0 40px;border-top:1px solid var(--border);margin-top:100px;background:var(--bg-subtle)}
footer .inner{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:16px;max-width:1200px;margin:0 auto;padding:0 24px}
footer .left{font-size:0.72rem;color:var(--text-dim);letter-spacing:0}
footer .links{display:flex;gap:20px}
footer .links a{font-size:0.72rem;color:var(--text-dim);transition:color var(--transition-base)}
footer .links a:hover{color:var(--text)}

/* Scrollbar */
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}

/* Load More */
.load-more-container{text-align:center;padding:32px 0 16px;display:flex;flex-direction:column;align-items:center;gap:12px}
.showing-count{font-size:0.82rem;color:var(--text-muted);font-family:var(--font-mono)}
.btn-load-more{padding:12px 32px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--card);color:var(--text);font-weight:600;font-size:0.9rem;transition:all var(--transition-spring);cursor:pointer}
.btn-load-more:hover{border-color:rgba(99,102,241,0.4);background:rgba(99,102,241,0.06);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.2)}
.btn-load-more:active{transform:translateY(0);transition-duration:0.1s}
@media(min-width:769px){.load-more-container{display:none !important}}

/* No results */
.no-results{grid-column:1/-1;text-align:center;padding:60px 0;color:var(--text-dim)}
.no-results .no-results-icon{font-size:3rem;margin-bottom:16px;opacity:0.5}
.no-results .no-results-hint{font-size:0.85rem;color:var(--text-dim);margin-top:8px}

/* Loading skeleton */
@keyframes shimmer{0%{background-position:-400px 0}100%{background-position:400px 0}}
.skeleton-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;min-height:240px}
.skeleton-line{height:12px;border-radius:6px;background:linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 75%);background-size:800px;animation:shimmer 1.5s infinite linear;margin-bottom:12px}
.skeleton-line.w60{width:60%}
.skeleton-line.w40{width:40%}
.skeleton-line.w80{width:80%}
.skeleton-circle{width:44px;height:44px;border-radius:50%;background:linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 75%);background-size:800px;animation:shimmer 1.5s infinite linear;margin-bottom:12px}

/* ===== MOBILE OPTIMIZATION PASS (Iteration 24) ===== */

/* Tablet breakpoint */
@media(max-width:768px){
  #helpBtn{display:none !important}
  .container{padding:0 16px}
  nav .inner{padding:0 12px}
  .nav-links a,.nav-links button{padding:7px 10px;font-size:0.8rem}
  .filter-bar{margin:0 -16px;padding:0 16px}
  .compare-bar-inner{padding:12px 16px;gap:10px}
  .compare-bar .mini-name{max-width:70px}
  .compare-modal{padding:20px;max-width:100%;margin:8px;border-radius:12px}
  .compare-table th{width:100px;padding:10px 12px;font-size:0.7rem}
  .compare-table td{padding:10px 12px;font-size:0.82rem}
  .shortcuts-modal{padding:24px 20px;max-width:95%;width:95%}
  footer .inner{flex-direction:column;text-align:center;gap:8px}
}

/* Mobile breakpoint */
@media(max-width:600px){
  /* === Base & Typography === */
  html,body{overflow-x:hidden}
  .container{padding:0 14px}
  body{font-size:0.95rem}

  /* === Nav === */
  nav .inner{padding:0 10px;height:56px}
  .logo{font-size:1rem}
  .nav-links{gap:2px}
  .nav-links a,.nav-links button{padding:8px 8px;font-size:0.76rem;min-height:44px;display:inline-flex;align-items:center}
  .theme-toggle{width:40px;height:40px;min-width:40px;min-height:40px}
  #helpBtn{width:40px;height:40px;min-width:40px;min-height:40px}
  .nav-links .saved-count{width:16px;height:16px;font-size:0.6rem;margin-left:2px}

  /* === Hero === */
  #hero{padding:100px 0 50px}
  #hero h1{font-size:1.8rem;line-height:1.1;margin-bottom:16px}
  #hero .tagline{font-size:0.92rem;margin-bottom:32px;line-height:1.6}
  .hero-ctas{flex-direction:column;align-items:stretch;gap:10px;padding:0 20px}
  .hero-ctas .btn-primary,.hero-ctas .btn-secondary{width:100%;text-align:center;padding:14px 24px;font-size:0.95rem;min-height:48px}
  .hero-browse{margin-top:16px}

  /* === Search === */
  #search-section{padding:48px 0 32px}
  .search-bar input{padding:14px 16px 14px 42px;font-size:0.95rem;min-height:48px}
  .search-bar svg{left:14px}
  .search-bar .clear-btn{right:12px;font-size:1.4rem;min-width:44px;min-height:44px;display:flex;align-items:center;justify-content:center}
  .search-syntax-help{padding:12px 14px}
  .syntax-examples{gap:5px}
  .syntax-examples code{padding:4px 10px;font-size:0.72rem;min-height:32px;display:inline-flex;align-items:center}

  /* === Filter Bar === */
  .filter-bar{margin:0 -14px;padding:0 14px;top:56px}
  .filter-bar-header{padding:10px 0}
  .filter-bar-header h3{font-size:0.82rem}
  .filter-bar-clear{min-height:36px;padding:6px 12px}
  .filter-row{gap:5px;flex-wrap:wrap;padding:4px 0}
  .filter-label{min-width:56px;font-size:0.72rem}
  .chip{padding:8px 14px;font-size:0.8rem;min-height:40px;display:inline-flex;align-items:center}
  .active-chips{gap:6px;flex-wrap:wrap}
  .active-chip{padding:5px 10px;font-size:0.76rem;min-height:32px;display:inline-flex;align-items:center}
  .filter-row select{min-height:44px;font-size:0.88rem;padding:10px 12px}
  .filter-row input[type=range]{height:44px}

  /* === Match Scoring Panel === */
  .match-panel{margin:12px -14px;border-left:none;border-right:none;border-radius:0;padding:0}
  .match-panel-header{padding:10px 14px;min-height:44px}
  .match-panel-header h3{font-size:0.82rem}
  .match-panel-body{padding:0 14px 14px}
  .match-fields{grid-template-columns:1fr !important;gap:12px}
  .match-field select{min-height:44px;font-size:0.88rem;padding:10px 12px}
  .match-sector-chips{gap:6px}
  .match-sector-chips .chip{padding:8px 12px;min-height:38px}
  .match-actions{flex-direction:column}
  .match-actions button{width:100%;min-height:44px}
  .match-hint{font-size:0.82rem;line-height:1.5}
  .match-score-modal{padding:12px 14px;flex-wrap:wrap}
  .match-score-number{font-size:1.4rem}
  .match-score-details{font-size:0.8rem}

  /* === Results Grid === */
  .results-grid{grid-template-columns:1fr;gap:12px}
  .results-info{font-size:0.8rem;flex-wrap:wrap;gap:8px}
  .investor-card{padding:16px}
  .investor-card .card-header{margin-bottom:10px}
  .investor-card .card-thesis{font-size:0.78rem;-webkit-line-clamp:3}
  .investor-card .avatar{width:42px;height:42px;font-size:0.88rem}
  .investor-card .active-badge{padding:3px 8px;font-size:0.68rem}
  .compare-btn{width:44px;height:44px;min-width:44px;min-height:44px;top:8px;right:8px;font-size:0.9rem}
  .card-move-btn{opacity:1;padding:5px 10px;font-size:0.72rem;min-height:30px}
  .match-score-badge{padding:3px 8px;font-size:0.7rem}
  .card-notes-bar{padding:6px 10px 4px}
  .card-note-preview{font-size:0.7rem}

  /* === Bulk Actions (touch-friendly) === */
  .bulk-bar{padding:10px 12px;gap:8px}
  .bulk-bar .bulk-count{font-size:0.78rem;min-width:auto}
  .bulk-bar .bulk-actions{gap:6px;width:100%}
  .bulk-bar .bulk-btn{padding:8px 12px;font-size:0.78rem;min-height:40px;flex:1;text-align:center;justify-content:center}
  .bulk-select-all{min-height:44px;display:flex;align-items:center}
  .bulk-select-all input[type=checkbox]{width:20px;height:20px}
  .investor-card .bulk-checkbox{width:24px;height:24px;opacity:1}
  .saved-actions{gap:6px;flex-wrap:wrap}
  .saved-actions button,.saved-actions label{min-height:40px;display:inline-flex;align-items:center}

  /* === Recently Viewed === */
  .rv-card{width:130px;padding:12px}
  .rv-card .rv-name{font-size:0.78rem}
  .rv-card .rv-remove{width:24px;height:24px;opacity:1;font-size:0.72rem}
  .rv-clear{min-height:36px;padding:6px 12px;display:inline-flex;align-items:center}

  /* === Analytics Panel === */
  .analytics-toggle{min-height:44px;font-size:0.82rem}
  .stats-counters{grid-template-columns:repeat(2,1fr);gap:8px}
  .stat-card{padding:12px 10px}
  .stat-card .stat-value{font-size:1.3rem}
  .stat-card .stat-label{font-size:0.65rem}
  .analytics-grid{grid-template-columns:1fr}
  .analytics-card{padding:14px}
  .analytics-card h4{font-size:0.7rem}
  .bar-row{font-size:0.76rem}
  .bar-label{min-width:65px;font-size:0.74rem}

  /* === Profile Modal — full-height bottom sheet === */
  .modal-overlay{padding:0 !important}
  .modal-overlay.open{align-items:flex-end}
  .modal{max-height:92vh;max-height:92dvh;min-height:70vh;border-radius:16px 16px 0 0;width:100%;margin:0;position:fixed;bottom:0;left:0;right:0}
  .modal::before{content:'';display:block;width:36px;height:4px;background:var(--text-dim);border-radius:4px;margin:10px auto 0;opacity:0.4;flex-shrink:0}
  .modal-close{top:12px;right:12px;width:40px;height:40px;font-size:1.6rem;min-width:40px;min-height:40px}
  .modal-header{padding:20px 16px 0;flex-direction:column;align-items:center;text-align:center;gap:12px}
  .modal-avatar{width:56px;height:56px;font-size:1.3rem}
  .modal-header-info h2{font-size:1.25rem;justify-content:center;flex-wrap:wrap}
  .modal-header-info .firm{font-size:0.9rem}
  .modal-header-info .badges{justify-content:center}
  .modal-body{padding:16px}
  .profile-grid{grid-template-columns:1fr !important;gap:0}
  .profile-col{gap:0}
  .fund-info{grid-template-columns:1fr;gap:8px}
  .fund-info-item{padding:10px 14px}
  .fund-info-item .value{font-size:0.85rem}
  .modal-section h3{font-size:0.88rem}
  .modal-actions{flex-direction:column;gap:8px;padding-top:16px}
  .modal-actions button{width:100%;min-height:48px;font-size:0.9rem;text-align:center;justify-content:center}
  .btn-save{min-height:48px}
  .modal-links-row{gap:6px;justify-content:center}
  .modal-links-row a{width:44px;height:44px;font-size:1.15rem}
  .share-buttons{justify-content:center}
  .share-btn{min-height:40px;padding:8px 14px;font-size:0.78rem}

  /* === Activity Timeline in Modal === */
  .activity-timeline{padding-left:24px}
  .timeline-card{padding:8px 12px}
  .timeline-company{font-size:0.84rem}
  .timeline-round{font-size:0.68rem;padding:2px 7px}
  .timeline-summary{gap:8px;padding:6px 10px;flex-direction:column}
  .timeline-stat{font-size:0.76rem}

  /* === Outreach Email Generator === */
  .outreach-cta{padding:12px 14px;gap:8px}
  .outreach-cta .cta-text strong{font-size:0.85rem}
  .outreach-cta .cta-text span{font-size:0.78rem}
  .outreach-inner{padding:14px}
  .outreach-form input,.outreach-form textarea,.outreach-form select{padding:12px 14px;font-size:0.88rem;min-height:44px}
  .outreach-form textarea{min-height:80px}
  .outreach-form label{font-size:0.72rem}
  .outreach-tone-chips{gap:6px}
  .outreach-tone-chips .tone-chip{padding:8px 14px;font-size:0.78rem;min-height:38px}
  .outreach-actions{flex-direction:column}
  .outreach-actions .btn-generate{width:100%;min-height:48px;font-size:0.88rem;text-align:center}
  .outreach-output{padding:14px;font-size:0.82rem;line-height:1.65}
  .outreach-output .copy-email-btn{padding:8px 14px;font-size:0.76rem;min-height:36px}

  /* === Similar Investors === */
  .similar-grid{grid-template-columns:1fr 1fr;gap:8px}
  .similar-card{padding:12px}

  /* === Compare View === */
  .compare-bar-inner{flex-direction:column;gap:8px;padding:10px 14px;padding-bottom:max(10px,env(safe-area-inset-bottom))}
  .compare-bar .avatars{flex-wrap:wrap;justify-content:center}
  .compare-bar .mini-chip{padding:5px 10px 5px 5px;margin-left:4px}
  .compare-bar .mini-name{max-width:60px;font-size:0.75rem}
  .compare-bar .bar-actions{width:100%;justify-content:center;gap:8px}
  .compare-bar .bar-actions button{min-height:44px;flex:1}
  .compare-modal{padding:16px;border-radius:16px 16px 0 0;max-height:95vh;max-height:95dvh;margin:0;width:100%}
  #compareOverlay.open{align-items:flex-end}
  .compare-table{font-size:0.78rem;display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
  .compare-table th{padding:8px 10px;font-size:0.68rem;min-width:90px}
  .compare-table td{padding:8px 10px;font-size:0.8rem;min-width:120px}
  .compare-table .header-cell{padding:16px 10px}
  .compare-table .header-cell .name{font-size:0.92rem}
  .compare-table .header-cell .compare-remove{min-height:32px;padding:6px 14px}
  .compare-export{justify-content:center}
  .compare-export button{min-height:40px;padding:8px 14px;flex:1}

  /* === Saved Lists === */
  .list-tabs{gap:6px;padding-bottom:4px;overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch}
  .list-tab{padding:8px 14px;font-size:0.78rem;white-space:nowrap;min-height:40px;flex-shrink:0}
  .list-tab-menu{min-width:160px}
  .list-tab-menu-item{padding:10px 14px;min-height:40px;font-size:0.82rem}
  .saved-header-row{flex-direction:column;align-items:stretch;gap:8px}
  .saved-tag-filter{gap:6px;overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;padding-bottom:4px}
  .saved-tag-filter .user-tag{min-height:32px;display:inline-flex;align-items:center;white-space:nowrap}

  /* === Notes & Tags in Modal === */
  .notes-section{padding:14px}
  .note-textarea{font-size:0.85rem;min-height:80px;padding:12px}
  .tag-editor-list{gap:6px}
  .tag-editor-list .user-tag{padding:6px 12px;font-size:0.74rem;min-height:32px;display:inline-flex;align-items:center}
  .tag-color-dot{width:24px;height:24px}
  .tag-add-input{padding:8px 12px;font-size:0.8rem;min-height:40px;width:100%}
  .tag-add-row{flex-wrap:wrap;gap:8px}
  .tag-add-btn{min-height:36px;padding:6px 14px}
  .tag-color-picker{gap:6px}

  /* === Keyboard Shortcuts Modal === */
  .shortcuts-overlay.open{align-items:flex-end}
  .shortcuts-modal{width:96%;max-width:100%;padding:20px 16px;max-height:90vh;max-height:90dvh;border-radius:16px 16px 0 0}
  .shortcuts-header h2{font-size:1.1rem}
  .shortcuts-close{min-width:40px;min-height:40px;font-size:1.6rem;display:flex;align-items:center;justify-content:center}
  .shortcut-row{font-size:0.82rem;padding:8px 0}
  .shortcut-row kbd{min-width:32px;padding:4px 10px;font-size:0.76rem}

  /* === Onboarding === */
  .onboarding-banner{padding:16px;margin-bottom:20px}
  .onboarding-body{grid-template-columns:1fr;gap:10px}
  .onboarding-step{padding:12px;text-align:left;display:flex;flex-direction:row;align-items:flex-start;gap:10px}
  .onboarding-step .step-icon{font-size:1.3rem;flex-shrink:0}
  .onboarding-step .step-title{font-size:0.85rem}
  .onboarding-step .step-desc{font-size:0.78rem;line-height:1.5}
  .onboarding-step{padding:10px 8px}
  .onboarding-step .step-icon{font-size:1.5rem}
  .onboarding-step .step-title{font-size:0.82rem}
  .onboarding-step .step-desc{font-size:0.76rem}
  .onboarding-dismiss{min-height:36px;padding:6px 12px}

  /* === Social Proof === */
  .social-proof{gap:10px;padding:10px 12px;flex-direction:column}

  /* === Footer === */
  footer{padding:40px 0 30px;margin-top:60px}
  footer .inner{flex-direction:column;text-align:center;gap:8px;padding:0 16px}
  footer .left{font-size:0.7rem}

  /* === Dark Mode Mobile Fixes === */
  .save-dropdown{max-height:200px;border-radius:12px}
  .save-dropdown-item{padding:10px 14px;min-height:40px}
  .card-move-menu{min-width:180px}
  .card-move-menu-item{padding:10px 14px;min-height:40px}

  /* === PWA Install Banner Mobile === */
  #pwa-install-banner{bottom:0 !important;left:0 !important;right:0 !important;transform:none !important;border-radius:16px 16px 0 0 !important;width:100% !important;max-width:100% !important;padding:16px !important;padding-bottom:max(16px,env(safe-area-inset-bottom)) !important;z-index:100 !important}
  /* Hide PWA banner when modal is open */
  .modal-overlay.open ~ #pwa-install-banner{display:none !important}

  /* === Touch-friendly interactions === */
  /* Ensure minimum 44px tap targets everywhere */
  .investor-card .sector-tags .tag-sector{min-height:28px;display:inline-flex;align-items:center}
  .delete-list-btn{min-height:36px;min-width:36px;padding:6px 10px}
  .rv-card{min-height:44px}
  .analytics-toggle .chevron{padding:4px}

  /* Disable hover-only effects on touch */
  .investor-card:hover{transform:none;box-shadow:var(--shadow-card)}
  .investor-card:active{transform:scale(0.98);transition-duration:0.1s}
  .similar-card:hover{transform:none}
  .similar-card:active{transform:scale(0.98)}
  .find-similar-btn{opacity:1 !important;pointer-events:auto !important}
  .similar-panel-content{width:95%;padding:20px;max-height:90vh}
  .similar-panel-item{padding:12px}
  .similar-panel-item:hover{transform:none}
  .sim-score-badge{font-size:1.1rem}
}

/* Small phone (375px and below) */
@media(max-width:380px){
  #hero h1{font-size:1.6rem}
  #hero .tagline{font-size:0.85rem}
  .nav-links a,.nav-links button{padding:8px 6px;font-size:0.72rem}
  .chip{padding:7px 10px;font-size:0.76rem}
  .investor-card{padding:14px}
  .investor-card .avatar{width:38px;height:38px;font-size:0.82rem}
  .modal-header-info h2{font-size:1.15rem}
  .modal-body{padding:14px}
  .compare-bar .mini-chip{padding:4px 8px 4px 4px}
  .compare-bar .mini-avatar{width:24px;height:24px;font-size:0.55rem}
  .stat-card .stat-value{font-size:1.1rem}
  .shortcuts-modal{padding:16px 12px}
}

/* ===== COMPARE ===== */
.compare-btn{position:absolute;top:12px;right:12px;width:28px;height:28px;border-radius:50%;border:2px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:center;font-size:0.75rem;color:var(--text-dim);transition:all 0.2s;z-index:2}
.compare-btn:hover{border-color:var(--accent);color:var(--accent)}
.compare-btn.selected{background:var(--accent);border-color:var(--accent);color:#fff}
/* Sticky compare bar */
.compare-bar{position:fixed;bottom:0;left:0;right:0;z-index:150;background:rgba(9,9,11,0.92);backdrop-filter:blur(24px);border-top:1px solid rgba(59,130,246,0.2);padding:0;display:none;flex-direction:column;align-items:center;box-shadow:0 -8px 32px rgba(0,0,0,0.4),0 -2px 16px rgba(59,130,246,0.08);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1)}
.compare-bar::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent)}
.compare-bar.show{display:flex}
.compare-bar-inner{display:flex;align-items:center;justify-content:center;gap:16px;padding:14px 24px;width:100%;max-width:1200px}
.compare-bar .avatars{display:flex;align-items:center}
.compare-bar .mini-chip{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:24px;padding:6px 14px 6px 6px;margin-left:8px;transition:all 0.2s}
.compare-bar .mini-chip:first-child{margin-left:0}
.compare-bar .mini-chip:hover{border-color:rgba(239,68,68,0.4)}
.compare-bar .mini-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),#ec4899);display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:#fff;flex-shrink:0;overflow:hidden}
.compare-bar .mini-name{font-size:0.8rem;font-weight:500;color:var(--text);max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.compare-bar .mini-remove{font-size:0.7rem;color:var(--text-dim);cursor:pointer;margin-left:4px;transition:color 0.2s}
.compare-bar .mini-remove:hover{color:#f87171}
.compare-bar .bar-actions{display:flex;gap:8px;align-items:center}
.compare-bar .compare-count{font-size:0.75rem;color:var(--text-dim);margin-right:4px}
.compare-modal{background:var(--bg);border:1px solid var(--border);border-radius:16px;width:100%;max-width:1100px;max-height:90vh;overflow-y:auto;position:relative;animation:modalIn 0.25s ease;padding:32px}
@keyframes modalIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
/* Compare table */
.compare-table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.compare-table th,.compare-table td{padding:14px 16px;text-align:left;border-bottom:1px solid var(--border);font-size:0.85rem;vertical-align:top}
.compare-table th{background:var(--card);font-weight:600;color:var(--text-dim);font-size:0.72rem;text-transform:uppercase;letter-spacing:0.06em;width:140px;white-space:nowrap}
.compare-table td{color:var(--text-muted);transition:background 0.2s}
.compare-table tr:last-child th,.compare-table tr:last-child td{border-bottom:none}
.compare-table td.match{background:rgba(34,197,94,0.06);color:var(--text)}
.compare-table td.match .match-icon{color:var(--green);font-size:0.7rem;margin-right:4px}
.compare-table .header-cell{text-align:center;padding:24px 16px;background:var(--card);border-bottom:1px solid var(--border)}
.compare-table .header-cell .name{font-weight:700;font-size:1.05rem;color:var(--text);margin-top:10px}
.compare-table .header-cell .firm{font-size:0.82rem;color:var(--text-muted);margin-top:2px}
.compare-table .header-cell .compare-remove{margin-top:8px;font-size:0.75rem;color:var(--text-dim);padding:4px 12px;border-radius:20px;border:1px solid var(--border);transition:all 0.2s;display:inline-block}
.compare-table .header-cell .compare-remove:hover{border-color:rgba(239,68,68,0.5);color:#f87171}
/* Compare export bar */
.compare-export{display:flex;gap:8px;margin-top:20px;justify-content:flex-end;flex-wrap:wrap}
.compare-export button{padding:8px 16px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:0.8rem;font-weight:500;color:var(--text-muted);transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.compare-export button:hover{border-color:var(--border-hover);color:var(--text);background:rgba(255,255,255,0.03)}
.compare-export button.copied{border-color:var(--green);color:var(--green)}

/* ===== NAMED LISTS ===== */
.list-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px}
.list-tab{padding:8px 16px;border-radius:20px;border:1px solid var(--border);font-size:0.8rem;font-weight:500;color:var(--text-muted);transition:all 0.2s;display:flex;align-items:center;gap:6px}
.list-tab:hover{border-color:var(--border-hover);color:var(--text)}
.list-tab.active{background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(139,92,246,0.15));border-color:rgba(59,130,246,0.4);color:var(--text)}
.list-tab .count{background:rgba(255,255,255,0.08);padding:2px 7px;border-radius:10px;font-size:0.7rem}
.list-tab.active .count{background:rgba(59,130,246,0.3)}
.save-dropdown{position:absolute;bottom:100%;left:0;right:0;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px;z-index:10;box-shadow:0 -8px 30px rgba(0,0,0,0.4);margin-bottom:4px;max-height:240px;overflow-y:auto}
.save-dropdown-item{padding:8px 12px;border-radius:6px;font-size:0.85rem;color:var(--text-muted);cursor:pointer;transition:background 0.15s;display:flex;align-items:center;gap:8px}
.save-dropdown-item:hover{background:rgba(255,255,255,0.05);color:var(--text)}
.save-dropdown-item.in-list{color:var(--accent)}
.save-dropdown-item.create{color:var(--accent);border-top:1px solid var(--border);margin-top:4px;padding-top:12px}
.save-dropdown .new-list-input{width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg);font-size:0.85rem;outline:none;margin-top:4px}
.save-dropdown .new-list-input:focus{border-color:var(--accent)}
.save-wrap{position:relative;display:inline-block}
.delete-list-btn{font-size:0.75rem;color:var(--text-dim);padding:4px 8px;border-radius:4px;transition:all 0.2s;margin-left:auto}
.delete-list-btn:hover{color:#f87171;background:rgba(239,68,68,0.1)}

/* List tab context menu */
.list-tab-menu{position:absolute;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px;z-index:300;box-shadow:0 8px 30px rgba(0,0,0,0.5);min-width:140px}
.list-tab-menu-item{padding:8px 12px;border-radius:6px;font-size:0.82rem;color:var(--text-muted);cursor:pointer;transition:background 0.15s;display:flex;align-items:center;gap:8px}
.list-tab-menu-item:hover{background:rgba(255,255,255,0.05);color:var(--text)}
.list-tab-menu-item.danger{color:#f87171}
.list-tab-menu-item.danger:hover{background:rgba(239,68,68,0.1)}

/* Move to list dropdown on cards in saved view */
.card-move-btn{position:absolute;top:12px;left:12px;padding:4px 10px;border-radius:16px;border:1px solid var(--border);background:var(--card);font-size:0.7rem;color:var(--text-dim);z-index:2;transition:all 0.2s;opacity:0}
.investor-card:hover .card-move-btn{opacity:1}
.card-move-btn:hover{border-color:var(--accent);color:var(--accent-light);background:rgba(99,102,241,0.08)}
.card-move-menu{position:absolute;top:100%;left:0;margin-top:4px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:4px;z-index:10;box-shadow:0 8px 30px rgba(0,0,0,0.4);min-width:160px}
.card-move-menu-item{padding:7px 12px;border-radius:6px;font-size:0.8rem;color:var(--text-muted);cursor:pointer;transition:background 0.15s;display:flex;align-items:center;gap:6px}
.card-move-menu-item:hover{background:rgba(255,255,255,0.05);color:var(--text)}
.card-move-menu-item.in-list{color:var(--accent)}
.card-move-menu-item.remove{color:#f87171}
.card-move-menu-item.remove:hover{background:rgba(239,68,68,0.08)}

/* ===== RECENTLY VIEWED ===== */
.recently-viewed{margin-bottom:24px;display:none}
.recently-viewed.show{display:block}
.rv-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.rv-header h3{font-size:0.82rem;font-weight:600;color:var(--text-muted);display:flex;align-items:center;gap:8px}
.rv-header h3 .rv-count{font-weight:400;color:var(--text-dim)}
.rv-clear{font-size:0.72rem;color:var(--text-dim);padding:4px 10px;border-radius:16px;border:1px solid var(--border);transition:all var(--transition-base)}
.rv-clear:hover{color:var(--text);border-color:var(--border-hover)}
.rv-scroll{display:flex;gap:12px;overflow-x:auto;padding:4px 0 8px;scrollbar-width:thin;-webkit-overflow-scrolling:touch}
.rv-scroll::-webkit-scrollbar{height:4px}
.rv-scroll::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:2px}
.rv-card{flex-shrink:0;width:160px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;cursor:pointer;transition:all var(--transition-spring);text-align:center;position:relative;overflow:hidden}
.rv-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),transparent);opacity:0;transition:opacity 0.3s}
.rv-card:hover{border-color:rgba(99,102,241,0.3);background:var(--card-hover);transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,0.2)}
.rv-card:hover::before{opacity:1}
.rv-card .rv-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2),#ec4899);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.75rem;color:#fff;margin:0 auto 8px;overflow:hidden}
.rv-card .rv-name{font-weight:600;font-size:0.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px}
.rv-card .rv-firm{font-size:0.7rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}
.rv-card .rv-time{font-size:0.65rem;color:var(--text-dim);font-family:var(--font-mono)}
.rv-card .rv-remove{position:absolute;top:6px;right:6px;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.65rem;color:var(--text-dim);opacity:0;transition:all 0.2s;background:var(--bg)}
.rv-card:hover .rv-remove{opacity:1}
.rv-card .rv-remove:hover{color:#f87171;background:rgba(239,68,68,0.1)}
[data-theme="light"] .rv-card .rv-avatar{background:linear-gradient(135deg,#4f46e5,#9333ea,#db2777)}
/* rv-card mobile handled in main mobile block */

/* Inline rename input in tabs */
.list-tab-rename{padding:6px 12px;border-radius:20px;border:1px solid var(--accent);background:var(--bg);font-size:0.8rem;color:var(--text);outline:none;font-family:inherit;width:140px}

/* ===== QUICK NOTES & TAGS ===== */
.card-notes-bar{padding:8px 12px 4px;border-top:1px solid var(--border);margin-top:auto}
.card-note-preview{font-size:0.72rem;color:var(--text-muted);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;margin-bottom:4px;font-style:italic;opacity:0.8}
.card-user-tags{display:flex;flex-wrap:wrap;gap:3px}
.user-tag{padding:2px 7px;border-radius:10px;font-size:0.62rem;font-weight:600;letter-spacing:0.02em;border:1px solid transparent}
.user-tag-red{background:rgba(239,68,68,0.12);color:#f87171;border-color:rgba(239,68,68,0.2)}
.user-tag-orange{background:rgba(249,115,22,0.12);color:#fb923c;border-color:rgba(249,115,22,0.2)}
.user-tag-yellow{background:rgba(234,179,8,0.12);color:#facc15;border-color:rgba(234,179,8,0.2)}
.user-tag-green{background:rgba(34,197,94,0.12);color:#4ade80;border-color:rgba(34,197,94,0.2)}
.user-tag-blue{background:rgba(59,130,246,0.12);color:#60a5fa;border-color:rgba(59,130,246,0.2)}
.user-tag-purple{background:rgba(168,85,247,0.12);color:#c084fc;border-color:rgba(168,85,247,0.2)}
.user-tag-pink{background:rgba(236,72,153,0.12);color:#f472b6;border-color:rgba(236,72,153,0.2)}
[data-theme="light"] .user-tag-red{background:rgba(239,68,68,0.08);color:#dc2626}
[data-theme="light"] .user-tag-orange{background:rgba(249,115,22,0.08);color:#ea580c}
[data-theme="light"] .user-tag-yellow{background:rgba(234,179,8,0.08);color:#a16207}
[data-theme="light"] .user-tag-green{background:rgba(34,197,94,0.08);color:#16a34a}
[data-theme="light"] .user-tag-blue{background:rgba(59,130,246,0.08);color:#2563eb}
[data-theme="light"] .user-tag-purple{background:rgba(168,85,247,0.08);color:#9333ea}
[data-theme="light"] .user-tag-pink{background:rgba(236,72,153,0.08);color:#db2777}

/* Notes editor in modal */
.notes-section{margin-top:16px;padding:16px;background:rgba(255,255,255,0.02);border:1px solid var(--border);border-radius:var(--radius-sm)}
[data-theme="light"] .notes-section{background:rgba(0,0,0,0.02)}
.notes-section h3{font-size:0.9rem;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.notes-section h3 .notes-icon{font-size:1rem}
.note-textarea{width:100%;min-height:70px;max-height:200px;padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:inherit;font-size:0.82rem;line-height:1.5;resize:vertical;transition:border-color var(--transition-base);outline:none}
.note-textarea:focus{border-color:var(--accent)}
.note-textarea::placeholder{color:var(--text-dim)}
.note-save-hint{font-size:0.68rem;color:var(--text-dim);margin-top:6px;opacity:0;transition:opacity 0.3s}
.note-save-hint.show{opacity:1}

/* Tag editor */
.tag-editor{margin-top:12px}
.tag-editor-label{font-size:0.78rem;color:var(--text-muted);margin-bottom:8px;font-weight:500}
.tag-editor-list{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.tag-editor-list .user-tag{cursor:pointer;transition:all 0.15s;padding:4px 10px;font-size:0.72rem}
.tag-editor-list .user-tag:hover{opacity:0.7}
.tag-editor-list .user-tag.selected{box-shadow:0 0 0 2px var(--accent);opacity:1}
.tag-editor-list .user-tag .tag-x{margin-left:4px;opacity:0.5;font-size:0.65rem}
.tag-editor-list .user-tag .tag-x:hover{opacity:1}
.tag-add-row{display:flex;gap:6px;align-items:center}
.tag-add-input{padding:6px 10px;border-radius:16px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:0.76rem;font-family:inherit;outline:none;width:120px;transition:border-color var(--transition-base)}
.tag-add-input:focus{border-color:var(--accent)}
.tag-color-picker{display:flex;gap:4px}
.tag-color-dot{width:18px;height:18px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all 0.15s}
.tag-color-dot:hover{transform:scale(1.2)}
.tag-color-dot.selected{border-color:var(--text);transform:scale(1.15)}
.tag-color-dot-red{background:#ef4444}
.tag-color-dot-orange{background:#f97316}
.tag-color-dot-yellow{background:#eab308}
.tag-color-dot-green{background:#22c55e}
.tag-color-dot-blue{background:#3b82f6}
.tag-color-dot-purple{background:#a855f7}
.tag-color-dot-pink{background:#ec4899}
.tag-add-btn{padding:5px 12px;border-radius:16px;border:1px solid var(--border);background:var(--bg);color:var(--text-muted);font-size:0.72rem;font-family:inherit;cursor:pointer;transition:all 0.15s}
.tag-add-btn:hover{border-color:var(--accent);color:var(--accent-light)}

/* Saved view tag filter */
.saved-tag-filter{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px;align-items:center}
.saved-tag-filter-label{font-size:0.76rem;color:var(--text-dim);margin-right:4px}
.saved-tag-filter .user-tag{cursor:pointer;transition:all 0.15s;padding:3px 9px;font-size:0.68rem}
.saved-tag-filter .user-tag:hover{opacity:0.8}
.saved-tag-filter .user-tag.filter-active{box-shadow:0 0 0 2px var(--accent)}

/* Saved section improvements */
.saved-header-row{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:8px}
.saved-list-info{font-size:0.82rem;color:var(--text-dim)}

/* ===== ANALYTICS PANEL ===== */
.analytics-toggle{display:flex;align-items:center;gap:8px;margin-bottom:16px;cursor:pointer;user-select:none;font-size:0.85rem;color:var(--text-muted);transition:color 0.2s}
.analytics-toggle:hover{color:var(--text)}
.analytics-toggle .chevron{transition:transform 0.3s;font-size:0.7rem}
.analytics-toggle .chevron.open{transform:rotate(90deg)}
.analytics-panel{overflow:hidden;max-height:0;opacity:0;transition:max-height 0.4s ease,opacity 0.3s ease,margin 0.3s ease;margin-bottom:0}
.analytics-panel.open{max-height:none;opacity:1;margin-bottom:24px}

/* Analytics Tabs */
.analytics-tabs{display:flex;gap:4px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:0}
.analytics-tab{padding:8px 16px;font-size:0.8rem;font-weight:600;color:var(--text-dim);border:none;background:none;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.2s}
.analytics-tab:hover{color:var(--text-muted)}
.analytics-tab.active{color:var(--accent-light);border-bottom-color:var(--accent)}
.analytics-tab-content{display:none}
.analytics-tab-content.active{display:block}

/* Visual Charts */
.viz-section{margin-top:20px}
.viz-section h3{font-size:0.78rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px}
.viz-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
@media(max-width:768px){.viz-grid{grid-template-columns:1fr}}
.viz-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;transition:border-color 0.2s}
.viz-card:hover{border-color:var(--border-hover)}
.viz-card h4{font-size:0.72rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:16px}
.viz-card.full-width{grid-column:1/-1}

/* Sector Heatmap */
.heatmap-grid{display:grid;gap:3px}
.heatmap-cell{border-radius:4px;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:600;color:transparent;min-height:32px;position:relative}
.heatmap-cell:hover{transform:scale(1.08);z-index:1;color:rgba(255,255,255,0.95);box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.heatmap-cell.active-filter{outline:2px solid var(--accent-light);outline-offset:1px}
.heatmap-labels{display:flex;flex-wrap:wrap;gap:4px;margin-top:10px}
.heatmap-legend{display:flex;align-items:center;gap:6px;margin-top:12px;font-size:0.68rem;color:var(--text-dim)}
.heatmap-legend-bar{width:120px;height:8px;border-radius:4px;background:linear-gradient(90deg,rgba(99,102,241,0.08),rgba(99,102,241,0.3),rgba(99,102,241,0.6),rgba(99,102,241,0.9))}
[data-theme="light"] .heatmap-cell:hover{color:rgba(255,255,255,0.95)}
[data-theme="light"] .heatmap-legend-bar{background:linear-gradient(90deg,rgba(79,70,229,0.06),rgba(79,70,229,0.25),rgba(79,70,229,0.5),rgba(79,70,229,0.85))}

/* Horizontal Bar Chart */
.hbar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;cursor:pointer;padding:3px 6px;border-radius:6px;transition:background 0.15s}
.hbar-row:hover{background:rgba(255,255,255,0.03)}
[data-theme="light"] .hbar-row:hover{background:rgba(0,0,0,0.02)}
.hbar-row.active-filter{background:rgba(99,102,241,0.08)}
.hbar-label{min-width:90px;font-size:0.78rem;color:var(--text-muted);flex-shrink:0;text-align:right;white-space:nowrap}
.hbar-track{flex:1;height:20px;background:rgba(255,255,255,0.03);border-radius:4px;overflow:hidden;position:relative}
[data-theme="light"] .hbar-track{background:rgba(0,0,0,0.03)}
.hbar-fill{height:100%;border-radius:4px;transition:width 0.5s cubic-bezier(0.16,1,0.3,1);display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:0.68rem;font-weight:700;color:rgba(255,255,255,0.9);min-width:24px}
.hbar-fill.fill-geo{background:linear-gradient(90deg,var(--accent2),#c4b5fd)}
.hbar-fill.fill-stage{background:linear-gradient(90deg,var(--accent),#93c5fd)}
.hbar-count{min-width:32px;font-size:0.72rem;color:var(--text-dim);font-weight:600;font-family:var(--font-mono)}
@media(max-width:768px){.hbar-label{min-width:70px;font-size:0.7rem}.heatmap-cell{min-height:26px;font-size:0.58rem}}
.stats-counters{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
@media(max-width:700px){.stats-counters{grid-template-columns:repeat(2,1fr)}}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;text-align:center;transition:border-color var(--transition-base)}
.stat-card:hover{border-color:var(--border-hover)}
.stat-card .stat-value{font-size:1.6rem;font-weight:800;background:linear-gradient(135deg,var(--accent-light),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;font-family:var(--font-mono);letter-spacing:-0.02em}
.stat-card .stat-label{font-size:0.68rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.06em;margin-top:4px;font-family:var(--font-mono)}
.analytics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
@media(max-width:900px){.analytics-grid{grid-template-columns:1fr 1fr}}
/* analytics-grid mobile handled in main mobile block */
.analytics-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px}
.analytics-card h4{font-size:0.72rem;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:12px}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:0.8rem}
.bar-row:last-child{margin-bottom:0}
.bar-label{min-width:80px;color:var(--text-muted);flex-shrink:0;text-align:right}
.bar-track{flex:1;height:8px;background:rgba(255,255,255,0.04);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease}
.bar-count{min-width:28px;font-size:0.75rem;color:var(--text-dim);font-weight:600}
.bar-fill.fill-vc{background:linear-gradient(90deg,#3b82f6,#60a5fa)}
.bar-fill.fill-angel{background:linear-gradient(90deg,#eab308,#fbbf24)}
.bar-fill.fill-family-office{background:linear-gradient(90deg,#22c55e,#4ade80)}
.bar-fill.fill-corp-vc{background:linear-gradient(90deg,#a855f7,#c084fc)}
.bar-fill.fill-angel-group{background:linear-gradient(90deg,#f97316,#fb923c)}
.bar-fill.fill-stage{background:linear-gradient(90deg,var(--accent),#93c5fd)}
.bar-fill.fill-geo{background:linear-gradient(90deg,var(--accent2),#c4b5fd)}

/* How it works / onboarding */
.onboarding-banner{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px 28px;margin-bottom:28px;position:relative;overflow:hidden}
.onboarding-banner::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),var(--accent2),#ec4899,transparent)}
.onboarding-header{display:flex;justify-content:space-between;align-items:center;cursor:pointer;user-select:none}
.onboarding-header h3{font-size:0.9rem;font-weight:600;color:var(--text);display:flex;align-items:center;gap:8px}
.onboarding-dismiss{color:var(--text-dim);font-size:0.8rem;padding:4px 10px;border-radius:20px;border:1px solid var(--border);transition:all 0.2s}
.onboarding-dismiss:hover{color:var(--text);border-color:var(--border-hover)}
.onboarding-body{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-top:20px}
.onboarding-step{text-align:center;padding:16px 12px}
.onboarding-step .step-icon{font-size:1.8rem;margin-bottom:8px}
.onboarding-step .step-title{font-weight:600;font-size:0.85rem;margin-bottom:4px}
.onboarding-step .step-desc{font-size:0.78rem;color:var(--text-muted);line-height:1.5}
/* onboarding mobile handled in main mobile block */
.onboarding-banner.collapsed .onboarding-body{display:none}

/* Share buttons in modal */
.share-buttons{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.share-btn{padding:8px 16px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:0.8rem;font-weight:500;color:var(--text-muted);transition:all 0.2s;display:inline-flex;align-items:center;gap:6px}
.share-btn:hover{border-color:var(--border-hover);color:var(--text);background:rgba(255,255,255,0.03)}
.share-btn.copied{border-color:var(--green);color:var(--green)}

/* ===== ACCESSIBILITY ===== */
/* Skip to content link */
.skip-link{position:absolute;top:-100%;left:16px;padding:12px 24px;background:var(--accent);color:#fff;border-radius:var(--radius-sm);font-weight:600;font-size:0.9rem;z-index:1000;transition:top 0.2s}
.skip-link:focus{top:8px}

/* Focus ring styling */
*:focus-visible{outline:2px solid var(--accent-light);outline-offset:2px;border-radius:4px}
.chip:focus-visible{outline-offset:0;box-shadow:0 0 0 2px var(--bg),0 0 0 4px var(--accent-light)}
.investor-card:focus-visible{outline:2px solid var(--accent-light);outline-offset:-2px;border-color:rgba(99,102,241,0.5);background:var(--card-hover);transform:translateY(-3px);box-shadow:var(--shadow-card-hover)}
.btn-primary:focus-visible,.btn-secondary:focus-visible{outline-offset:2px}
.search-bar input:focus-visible{outline:none}
.modal-close:focus-visible{outline-offset:-2px}
.compare-btn:focus-visible{outline-offset:-2px}
.similar-card:focus-visible{outline:2px solid var(--accent-light);outline-offset:-2px}
.nav-links a:focus-visible,.nav-links button:focus-visible{outline-offset:0}

/* Card keyboard focus indicator */
.investor-card.kb-focused{border-color:rgba(99,102,241,0.5);background:var(--card-hover);transform:translateY(-3px);box-shadow:var(--shadow-card-hover)}
.investor-card.kb-focused::before{opacity:0.8}

/* Reduced motion */
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important;scroll-behavior:auto !important}
  .investor-card{animation:none !important}
  .investor-card:hover,.investor-card.kb-focused,.investor-card:focus-visible{transform:none !important}
  .similar-card:hover{transform:none !important}
  .btn-primary:hover{transform:none !important}
  .modal{transition:none !important}
  .modal-overlay{transition:none !important}
  #hero::before{animation:none !important}
  .active-badge .dot{animation:none !important}
  .skeleton-line,.skeleton-circle{animation:none !important}
  html{scroll-behavior:auto !important}
  .filters-collapsible{transition:none !important}
  .filter-bar-toggle{transition:none !important}
}

/* Visually hidden (screen reader only) */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

/* Touch optimization — eliminate 300ms tap delay */
html{touch-action:manipulation}
button,a,.chip,.investor-card,.similar-card,.rv-card,.tone-chip,.compare-btn,.tag-color-dot,.user-tag,.list-tab,.share-btn,.outreach-cta{-webkit-tap-highlight-color:transparent}

/* ===== PWA SAFE AREAS & MOBILE POLISH ===== */
/* Safe area insets for notch/home indicator */
body{padding-top:env(safe-area-inset-top);padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right)}
nav{padding-top:env(safe-area-inset-top)}
footer{padding-bottom:max(40px,env(safe-area-inset-bottom))}
.modal{padding-bottom:env(safe-area-inset-bottom)}
.compare-bar{padding-bottom:env(safe-area-inset-bottom)}
/* Smooth momentum scrolling */
.modal,.shortcuts-modal,.compare-modal{-webkit-overflow-scrolling:touch;overscroll-behavior:contain}
.rv-scroll,.list-tabs,.saved-tag-filter{-webkit-overflow-scrolling:touch}
/* Modal actions safe area on mobile */
@media(max-width:600px){
  .modal-actions{padding-bottom:max(16px,env(safe-area-inset-bottom))}
  footer .inner{padding-bottom:max(16px,env(safe-area-inset-bottom))}
}
/* ===== Mobile Swipe Gestures ===== */
.investor-card{touch-action:pan-y}
.investor-card.swiping{transition:none!important;transform-origin:center bottom;z-index:10;user-select:none;-webkit-user-select:none}
.investor-card .swipe-indicator{position:absolute;top:0;left:0;right:0;bottom:0;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:800;pointer-events:none;opacity:0;transition:opacity 0.1s;z-index:5}
.investor-card .swipe-indicator.save{background:rgba(16,185,129,0.15);border:2px solid var(--green);color:var(--green)}
.investor-card .swipe-indicator.dismiss{background:rgba(239,68,68,0.15);border:2px solid #ef4444;color:#ef4444}
.investor-card.swipe-exit-right{transition:transform 0.3s ease-out,opacity 0.3s ease-out!important;transform:translateX(120%) rotate(15deg)!important;opacity:0!important}
.investor-card.swipe-exit-left{transition:transform 0.3s ease-out,opacity 0.3s ease-out!important;transform:translateX(-120%) rotate(-15deg)!important;opacity:0!important}
.swipe-undo-toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 20px;display:flex;align-items:center;gap:12px;font-size:0.85rem;color:var(--text);box-shadow:0 8px 32px rgba(0,0,0,0.3);z-index:9999;animation:toastIn 0.3s ease}
.swipe-undo-toast button{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 14px;font-weight:600;font-size:0.8rem;cursor:pointer}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.swipe-hint{display:none}
@media(max-width:768px){
  .swipe-hint{display:flex;align-items:center;justify-content:center;gap:8px;font-size:0.75rem;color:var(--text-dim);padding:4px 0 8px;letter-spacing:0.01em}
  .swipe-hint span{opacity:0.7}
}
</style>
</head>
<body>

<!-- Skip to content -->
<a href="#search-section" class="skip-link" onclick="showSection('search')">Skip to main content</a>

<!-- NAV -->
<nav aria-label="Main navigation">
  <div class="inner">
    <div class="logo"><span class="gradient-text">Match Capital</span></div>
    <div class="nav-links" role="menubar">
      <a href="#" onclick="showSection('hero')" role="menuitem">Home</a>
      <a href="#search" onclick="showSection('search')" role="menuitem">Search</a>
      <button onclick="showSection('saved')" role="menuitem">Saved <span class="saved-count" id="savedCount" aria-label="saved investors count">0</span></button>
      <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle light/dark mode" title="Toggle theme">🌙</button>
      <button class="theme-toggle" id="helpBtn" onclick="toggleShortcutsModal()" aria-label="Keyboard shortcuts" title="Keyboard shortcuts (?)">?</button>
    </div>
  </div>
</nav>

<!-- KEYBOARD SHORTCUTS MODAL -->
<div id="shortcutsOverlay" class="shortcuts-overlay" onclick="if(event.target===this)toggleShortcutsModal()" role="dialog" aria-label="Keyboard shortcuts">
  <div class="shortcuts-modal">
    <div class="shortcuts-header">
      <h2>⌨️ Keyboard Shortcuts</h2>
      <button onclick="toggleShortcutsModal()" aria-label="Close" class="shortcuts-close">&times;</button>
    </div>
    <div class="shortcuts-body">
      <div class="shortcuts-group">
        <h3>Navigation</h3>
        <div class="shortcut-row"><kbd>←</kbd> <kbd>↑</kbd> Previous card</div>
        <div class="shortcut-row"><kbd>→</kbd> <kbd>↓</kbd> Next card</div>
        <div class="shortcut-row"><kbd>Enter</kbd> <kbd>Space</kbd> Open selected card</div>
        <div class="shortcut-row"><kbd>Esc</kbd> Close modal / clear search</div>
      </div>
      <div class="shortcuts-group">
        <h3>Actions</h3>
        <div class="shortcut-row"><kbd>/</kbd> Focus search</div>
        <div class="shortcut-row"><kbd>C</kbd> Toggle compare (on focused card)</div>
        <div class="shortcut-row"><kbd>?</kbd> Toggle this help</div>
      </div>
      <div class="shortcuts-group">
        <h3>Search Syntax</h3>
        <div class="shortcut-row"><code>stage:seed</code> Filter by stage</div>
        <div class="shortcut-row"><code>type:vc</code> Filter by type</div>
        <div class="shortcut-row"><code>sector:fintech</code> Filter by sector</div>
        <div class="shortcut-row"><code>check:&gt;500k</code> Min check size</div>
        <div class="shortcut-row"><code>geo:nyc</code> Filter by geography</div>
      </div>
    </div>
  </div>
</div>

<!-- HERO -->
<section id="hero" aria-label="Hero">
  <div class="container">
    <h1>Find the right investors.<br><span class="gradient-text">Skip the noise.</span></h1>
    <p class="tagline">The most comprehensive investor intelligence tool for founders. Search <span id="investorCountHero">150+</span> investors by stage, sector, check size, and more.</p>
    <div class="hero-ctas">
      <button class="btn-primary" onclick="showSection('search')">Start Searching →</button>
    </div>
    <p class="hero-browse"><a href="#search" onclick="showSection('search');clearAllFilters()">Browse All Investors →</a></p>
  </div>
</section>

<!-- SEARCH -->
<main id="search-section" role="main" aria-label="Investor search">
  <div class="container">
    <div class="onboarding-banner" id="onboardingBanner">
      <div class="onboarding-header" onclick="toggleOnboarding()">
        <h3>💡 How it works</h3>
        <button class="onboarding-dismiss" onclick="event.stopPropagation();dismissOnboarding()">Dismiss ✕</button>
      </div>
      <div class="onboarding-body">
        <div class="onboarding-step"><div class="step-icon">🔍</div><div class="step-title">Search & Filter</div><div class="step-desc">Search by name, firm, sector, or thesis. Use filters to narrow by stage, check size, geography, and type.</div></div>
        <div class="onboarding-step"><div class="step-icon">📋</div><div class="step-title">Save & Organize</div><div class="step-desc">Save investors to named lists. Compare up to 3 side-by-side. Export your lists as CSV for outreach.</div></div>
        <div class="onboarding-step"><div class="step-icon">🤝</div><div class="step-title">Connect</div><div class="step-desc">View detailed profiles with thesis, portfolio, and links. Share profiles with your co-founders or advisors.</div></div>
      </div>
    </div>

    <div class="search-bar" role="search">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="search" id="searchInput" placeholder="Search investors... (try stage:seed sector:saas portfolio:stripe or check:>500k)" aria-label="Search investors" autocomplete="off">
      <div class="syntax-active" id="syntaxActive"></div>
      <button class="clear-btn" id="clearSearch" onclick="clearSearch()" aria-label="Clear search">×</button>
      <div class="search-syntax-help" id="searchSyntaxHelp">
        <div class="syntax-title">⚡ Advanced Search</div>
        <div class="syntax-examples">
          <code>stage:seed</code> <code>sector:ai</code> <code>type:vc</code> <code>geo:us</code> <code>check:&gt;500k</code> <code>check:&lt;5m</code> <code>active:yes</code> <code>portfolio:stripe</code>
        </div>
        <div class="syntax-hint">Combine with free text: <code>climate stage:seed check:&lt;2m</code></div>
      </div>
    </div>

    <div class="recently-viewed" id="recentlyViewed" aria-label="Recently viewed investors">
      <div class="rv-header">
        <h3>🕐 Recently Viewed <span class="rv-count" id="rvCount"></span></h3>
        <button class="rv-clear" onclick="clearRecentlyViewed()">Clear</button>
      </div>
      <div class="rv-scroll" id="rvScroll"></div>
    </div>

    <button class="analytics-toggle" onclick="toggleAnalytics()" aria-expanded="false" aria-controls="analyticsPanel">
      <span class="chevron" id="analyticsChevron" aria-hidden="true">▶</span>
      <span>📊 Database Analytics</span>
    </button>
    <div class="analytics-panel" id="analyticsPanel" role="region" aria-label="Database analytics">
      <div class="analytics-tabs">
        <button class="analytics-tab active" onclick="switchAnalyticsTab('summary',this)">📊 Summary</button>
        <button class="analytics-tab" onclick="switchAnalyticsTab('visual',this)">🗺 Visual Charts</button>
      </div>
      <div class="analytics-tab-content active" id="tabSummary">
        <div class="stats-counters" id="statsCounters"></div>
        <div class="analytics-grid" id="analyticsGrid"></div>
      </div>
      <div class="analytics-tab-content" id="tabVisual">
        <div class="stats-counters" id="vizStatsCounters"></div>
        <div class="viz-grid">
          <div class="viz-card full-width" id="vizSectorHeatmap"><h4>🔥 Sector Heatmap</h4><div id="heatmapContainer"></div></div>
          <div class="viz-card" id="vizGeoChart"><h4>🌎 Geographic Distribution</h4><div id="geoChartContainer"></div></div>
          <div class="viz-card" id="vizStageChart"><h4>📈 Stage Distribution</h4><div id="stageChartContainer"></div></div>
        </div>
      </div>
    </div>

    <div class="filter-bar" id="filterBar">
      <div class="preset-row" id="presetRow" role="group" aria-label="Filter presets">
        <button class="preset-btn" data-preset="dcSeed" onclick="togglePreset('dcSeed')">🏛 DC/DMV Seed</button>
        <button class="preset-btn" data-preset="nycSeriesA" onclick="togglePreset('nycSeriesA')">🗽 NYC Series A</button>
        <button class="preset-btn" data-preset="govtechImpact" onclick="togglePreset('govtechImpact')">🌍 GovTech / Impact</button>
        <button class="preset-btn" data-preset="earlyStage" onclick="togglePreset('earlyStage')">🌱 Early Stage</button>
        <button class="preset-btn" data-preset="growth" onclick="togglePreset('growth')">🚀 Growth</button>
        <button class="preset-btn" data-preset="westCoast" onclick="togglePreset('westCoast')">🌊 West Coast</button>
      </div>
      <div class="filter-bar-header" onclick="toggleFilterSection()">
        <span class="filter-bar-toggle open" id="filterToggleChevron" aria-hidden="true">▶</span>
        <h3>Filters <span class="filter-count-badge hidden" id="filterCountBadge">0</span></h3>
        <button class="filter-bar-clear hidden" id="filterBarClear" onclick="event.stopPropagation();clearAllFilters()" aria-label="Clear all filters">Clear All ✕</button>
      </div>
      <div class="active-chips" id="activeChips" aria-label="Active filters"></div>
      <div class="filters-collapsible" id="filtersCollapsible">
        <div class="filters" role="group" aria-label="Investor filters">
          <div class="filter-row" role="group" aria-label="Stage filter">
            <span class="filter-label" id="filter-label-stage">Stage</span>
            <button class="chip" data-filter="stage" data-value="Pre-Seed">Pre-Seed</button>
            <button class="chip" data-filter="stage" data-value="Seed">Seed</button>
            <button class="chip" data-filter="stage" data-value="Series A">Series A</button>
            <button class="chip" data-filter="stage" data-value="Series B">Series B</button>
            <button class="chip" data-filter="stage" data-value="Growth">Growth</button>
          </div>
          <div class="filter-row" role="group" aria-label="Sector filter">
            <span class="filter-label" id="filter-label-sector">Sector</span>
            <button class="chip" data-filter="sector" data-value="SaaS">SaaS</button>
            <button class="chip" data-filter="sector" data-value="Fintech">Fintech</button>
            <button class="chip" data-filter="sector" data-value="HealthTech">HealthTech</button>
            <button class="chip" data-filter="sector" data-value="AI/ML">AI/ML</button>
            <button class="chip" data-filter="sector" data-value="Consumer">Consumer</button>
            <button class="chip" data-filter="sector" data-value="Enterprise">Enterprise</button>
            <button class="chip" data-filter="sector" data-value="Climate">Climate</button>
            <button class="chip" data-filter="sector" data-value="Crypto">Crypto</button>
            <button class="chip" data-filter="sector" data-value="Biotech">Biotech</button>
            <button class="chip" data-filter="sector" data-value="DeepTech">DeepTech</button>
            <button class="chip" data-filter="sector" data-value="GovTech">GovTech</button>
            <button class="chip" data-filter="sector" data-value="Cybersecurity">Cybersecurity</button>
            <button class="chip" data-filter="sector" data-value="Cleantech">Cleantech</button>
            <button class="chip" data-filter="sector" data-value="PropTech">PropTech</button>
          </div>
          <div class="filter-row" role="group" aria-label="Check size filter">
            <span class="filter-label">Check Size</span>
            <input type="range" id="checkMin" min="0" max="25000000" step="100000" value="0" aria-label="Minimum check size">
            <input type="range" id="checkMax" min="0" max="25000000" step="100000" value="25000000" aria-label="Maximum check size">
            <span class="range-display" id="checkDisplay" aria-live="polite">$0 – $25M+</span>
          </div>
          <div class="filter-row" role="group" aria-label="Investor type filter">
            <span class="filter-label">Type</span>
            <button class="chip" data-filter="type" data-value="VC">VC</button>
            <button class="chip" data-filter="type" data-value="Angel">Angel</button>
            <button class="chip" data-filter="type" data-value="Family Office">Family Office</button>
            <button class="chip" data-filter="type" data-value="Corp VC">Corp VC</button>
            <button class="chip" data-filter="type" data-value="Angel Group">Angel Group</button>
          </div>
          <div class="filter-row" role="group" aria-label="Entity type filter">
            <span class="filter-label">Entity</span>
            <button class="chip" data-filter="entity" data-value="individual">Individuals</button>
            <button class="chip" data-filter="entity" data-value="organization">Organizations</button>
          </div>
          <div class="filter-row" role="group" aria-label="Geography filter">
            <span class="filter-label">Geography</span>
            <button class="chip" data-filter="geo" data-value="US">US</button>
            <button class="chip" data-filter="geo" data-value="dmv">DC/DMV</button>
            <button class="chip" data-filter="geo" data-value="nyc">NYC</button>
            <button class="chip" data-filter="geo" data-value="sf_bay">SF Bay</button>
            <button class="chip" data-filter="geo" data-value="boston">Boston</button>
            <button class="chip" data-filter="geo" data-value="mid_atlantic">Mid-Atlantic</button>
            <button class="chip" data-filter="geo" data-value="EU">EU</button>
            <button class="chip" data-filter="geo" data-value="europe">Europe</button>
            <button class="chip" data-filter="geo" data-value="Asia">Asia</button>
            <button class="chip" data-filter="geo" data-value="Global">Global</button>
          </div>
          <div class="filter-row" role="group" aria-label="Activity filter">
            <span class="filter-label">Activity</span>
            <select id="activityFilter" onchange="renderResults()" aria-label="Filter by activity recency">
              <option value="any">Any time</option>
              <option value="3">Last 3 months</option>
              <option value="6">Last 6 months</option>
              <option value="12">Last 12 months</option>
            </select>
          </div>
          <div class="filter-row" role="group" aria-label="Sort order">
            <span class="filter-label">Sort</span>
            <select id="sortSelect" onchange="renderResults()" aria-label="Sort investors by">
              <option value="relevance">Relevance</option>
              <option value="nameAZ">Name A → Z</option>
              <option value="nameZA">Name Z → A</option>
              <option value="recent">Recent Activity</option>
              <option value="checkSize">Check Size (High → Low)</option>
              <option value="checkSizeAsc">Check Size (Low → High)</option>
              <option value="location">Location</option>
              <option value="matchScore">Match Score (Best First)</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- MATCH SCORING PANEL -->
    <div class="match-panel" id="matchPanel">
      <div class="match-panel-header" onclick="toggleMatchPanel()">
        <span class="match-panel-toggle" id="matchToggleChevron" aria-hidden="true">▶</span>
        <h3>🎯 Match Score — Describe Your Startup</h3>
        <span class="match-panel-status" id="matchStatus"></span>
      </div>
      <div class="match-panel-body" id="matchPanelBody" style="display:none">
        <p class="match-hint">Tell us about your startup and we'll score each investor on how well they match your needs.</p>
        <div class="match-fields">
          <div class="match-field">
            <label>Stage</label>
            <select id="matchStage" onchange="computeMatchScores()">
              <option value="">Select...</option>
              <option value="Pre-Seed">Pre-Seed</option>
              <option value="Seed">Seed</option>
              <option value="Series A">Series A</option>
              <option value="Series B">Series B</option>
              <option value="Growth">Growth</option>
            </select>
          </div>
          <div class="match-field">
            <label>Sectors (select all that apply)</label>
            <div class="match-sector-chips" id="matchSectorChips">
              <button class="chip" onclick="toggleMatchSector(this,'SaaS')">SaaS</button>
              <button class="chip" onclick="toggleMatchSector(this,'Fintech')">Fintech</button>
              <button class="chip" onclick="toggleMatchSector(this,'HealthTech')">HealthTech</button>
              <button class="chip" onclick="toggleMatchSector(this,'AI/ML')">AI/ML</button>
              <button class="chip" onclick="toggleMatchSector(this,'Consumer')">Consumer</button>
              <button class="chip" onclick="toggleMatchSector(this,'Enterprise')">Enterprise</button>
              <button class="chip" onclick="toggleMatchSector(this,'Climate')">Climate</button>
              <button class="chip" onclick="toggleMatchSector(this,'Crypto')">Crypto</button>
              <button class="chip" onclick="toggleMatchSector(this,'Biotech')">Biotech</button>
              <button class="chip" onclick="toggleMatchSector(this,'DeepTech')">DeepTech</button>
            </div>
          </div>
          <div class="match-field">
            <label>Raise Amount</label>
            <select id="matchRaise" onchange="computeMatchScores()">
              <option value="">Select...</option>
              <option value="100000">~$100K</option>
              <option value="250000">~$250K</option>
              <option value="500000">~$500K</option>
              <option value="1000000">~$1M</option>
              <option value="2000000">~$2M</option>
              <option value="5000000">~$5M</option>
              <option value="10000000">~$10M</option>
              <option value="25000000">~$25M+</option>
            </select>
          </div>
          <div class="match-field">
            <label>Geography</label>
            <select id="matchGeo" onchange="computeMatchScores()">
              <option value="">Select...</option>
              <option value="US">US</option>
              <option value="EU">EU</option>
              <option value="Asia">Asia</option>
              <option value="Global">Global</option>
            </select>
          </div>
        </div>
        <div class="match-actions">
          <button class="btn-secondary" onclick="clearMatchProfile()">Clear</button>
        </div>
      </div>
    </div>

    <div class="results-info" aria-live="polite">
      <span><span id="resultsCount" role="status">0 investors</span><span id="filterBadge" class="filter-badge"></span><button id="clearFiltersBtn" class="clear-filters-btn" onclick="clearAllFilters()" style="display:none" aria-label="Clear all filters">Clear Filters ✕</button>
      <span class="view-switcher" id="viewSwitcher">
        <button class="active" data-view="grid" onclick="setView('grid')" title="Card View" aria-label="Card view"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="1" y="1" width="6" height="6" rx="1"/><rect x="9" y="1" width="6" height="6" rx="1"/><rect x="1" y="9" width="6" height="6" rx="1"/><rect x="9" y="9" width="6" height="6" rx="1"/></svg></button>
        <button data-view="map" onclick="setView('map')" title="Map View" aria-label="Map view"><svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M1 3l4.5-1.5 5 2L15 2v11l-4.5 1.5-5-2L1 14V3z"/><path d="M5.5 1.5V12M10.5 3.5V14"/></svg></button>
      </span>
      </span>
      <span class="export-controls">
        <button id="exportCsvBtn" class="btn-export" onclick="exportFiltered('csv')" title="Export filtered investors as CSV" aria-label="Export as CSV">⬇ CSV</button>
        <button id="exportJsonBtn" class="btn-export" onclick="exportFiltered('json')" title="Export filtered investors as JSON" aria-label="Export as JSON">⬇ JSON</button>
      </span>
    </div>
    <div class="map-container" id="mapContainer">
      <div class="map-svg-wrap" id="mapSvgWrap"></div>
      <div class="map-tooltip" id="mapTooltip"></div>
      <div class="map-legend">
        <div class="map-legend-item"><div class="map-legend-dot" style="background:#10b981"></div>Seed</div>
        <div class="map-legend-item"><div class="map-legend-dot" style="background:#6366f1"></div>Series A</div>
        <div class="map-legend-item"><div class="map-legend-dot" style="background:#a855f7"></div>Growth</div>
        <div class="map-legend-item"><div class="map-legend-dot" style="background:#8b8b9a"></div>Mixed</div>
      </div>
      <div class="map-hint">Click a cluster to filter investors by location</div>
    </div>
    <div class="results-grid" id="resultsGrid" role="list" aria-label="Investor results"></div>
    <div id="loadMoreContainer" class="load-more-container" style="display:none">
      <div id="showingCount" class="showing-count"></div>
      <button id="loadMoreBtn" class="btn-load-more" onclick="loadMore()">Load More</button>
    </div>
  </div>
</main>

<!-- SAVED -->
<section id="saved-section" aria-label="Saved investors">
  <div class="container">
    <h2>Investor Lists</h2>
    <p class="subtitle">Organize your investors into named lists for outreach. Right-click a tab to rename or delete.</p>
    <div class="list-tabs" id="listTabs"></div>
    <div class="saved-header-row">
      <span class="saved-list-info" id="savedListInfo"></span>
      <div class="saved-actions" id="savedActions" style="margin-bottom:0">
        <label class="bulk-select-all"><input type="checkbox" id="bulkToggle" onchange="toggleBulkMode(this.checked)"> Select</label>
        <button class="btn-secondary" onclick="exportCSV()" style="padding:8px 16px;font-size:0.82rem">↓ Export CSV</button>
        <button class="btn-secondary" onclick="clearCurrentList()" style="padding:8px 16px;font-size:0.82rem">Clear</button>
      </div>
    </div>
    <div class="bulk-bar" id="bulkBar">
      <label class="bulk-select-all"><input type="checkbox" id="bulkSelectAll" onchange="bulkSelectAll(this.checked)"> All</label>
      <span class="bulk-count" id="bulkCount">0 selected</span>
      <div class="bulk-actions">
        <button class="bulk-btn" onclick="bulkExport()">↓ Export Selected</button>
        <div class="bulk-move-dropdown">
          <button class="bulk-btn" onclick="toggleBulkMoveMenu(this)">⇄ Move/Copy to…</button>
        </div>
        <button class="bulk-btn danger" onclick="bulkRemove()">✕ Remove Selected</button>
      </div>
    </div>
    <div class="saved-tag-filter" id="savedTagFilter" style="display:none"></div>
    <div class="results-grid" id="savedGrid"></div>
    <div class="saved-empty" id="savedEmpty">No saved investors yet. Browse and save investors you're interested in.</div>
  </div>
</section>

<!-- COMPARE BAR -->
<div class="compare-bar" id="compareBar" role="region" aria-label="Compare investors toolbar">
  <div class="compare-bar-inner">
    <div class="avatars" id="compareAvatars"></div>
    <div class="bar-actions">
      <span class="compare-count" id="compareCount"></span>
      <button class="btn-primary" onclick="openCompare()" id="compareBtn" style="padding:10px 24px">Compare →</button>
      <button class="btn-secondary" onclick="clearCompare()" style="padding:10px 14px;font-size:0.8rem">Clear</button>
    </div>
  </div>
</div>

<!-- COMPARE MODAL -->
<div class="modal-overlay" id="compareOverlay" onclick="if(event.target===this)closeCompare()" role="dialog" aria-modal="true" aria-label="Investor comparison">
  <div class="compare-modal" id="compareModal"></div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()" role="dialog" aria-modal="true" aria-label="Investor profile">
  <div class="modal" id="modal"></div>
</div>

<!-- FOOTER -->
<footer role="contentinfo">
  <div class="inner">
    <div class="left">Built by <a href="https://ralcorn.com" target="_blank">Ralcorn Consulting</a> · Data sourced from public records</div>
    <div class="links">
      <a href="mailto:hello@matchcapital.ai">Contact</a>
    </div>
  </div>
</footer>

<script>
// ===== THEME =====
function getPreferredTheme(){
  const stored=localStorage.getItem('mc_theme');
  if(stored)return stored;
  return window.matchMedia('(prefers-color-scheme:light)').matches?'light':'dark';
}
function applyTheme(t){
  document.documentElement.setAttribute('data-theme',t);
  document.getElementById('themeToggle').textContent=t==='light'?'☀️':'🌙';
  localStorage.setItem('mc_theme',t);
}
function toggleTheme(){
  const current=document.documentElement.getAttribute('data-theme')||'dark';
  applyTheme(current==='dark'?'light':'dark');
}
// Apply immediately to avoid flash
(function(){
  const t=localStorage.getItem('mc_theme')||(window.matchMedia('(prefers-color-scheme:light)').matches?'light':'dark');
  document.documentElement.setAttribute('data-theme',t);
})();

// ===== SAMPLE DATA (fallback) =====
const SAMPLE_DATA=[];

let investors=[];
let activeFilters={stage:[],sector:[],type:[],geo:[],entity:[]};
const PAGE_SIZE=24;
let displayedCount=PAGE_SIZE;
let lastFiltered=[];

// ===== NAMED LISTS =====
function loadLists(){
  let lists=JSON.parse(localStorage.getItem('mc_lists')||'null');
  if(!lists){
    // Migrate from old mc_saved
    const old=JSON.parse(localStorage.getItem('mc_saved')||'[]');
    lists={Saved:old};
    localStorage.setItem('mc_lists',JSON.stringify(lists));
  }
  return lists;
}
let namedLists=loadLists();
let currentListName=Object.keys(namedLists)[0]||'Saved';

function saveLists(){localStorage.setItem('mc_lists',JSON.stringify(namedLists))}
function allSavedIds(){const s=new Set();Object.values(namedLists).forEach(l=>l.forEach(id=>s.add(id)));return s}
function listsForInvestor(id){return Object.entries(namedLists).filter(([,ids])=>ids.includes(id)).map(([n])=>n)}

// ===== COMPARE =====
let compareIds=[];

// ===== DATA NORMALIZATION =====
const STAGE_MAP={seed:'Seed','pre-seed':'Pre-Seed','pre_seed':'Pre-Seed',series_a:'Series A',series_b:'Series B',growth:'Growth'};
const SECTOR_MAP={saas:'SaaS',fintech:'Fintech',healthtech:'HealthTech',ai_ml:'AI/ML',consumer:'Consumer',enterprise:'Enterprise',climate:'Climate',crypto:'Crypto',biotech:'Biotech',deeptech:'DeepTech',edtech:'EdTech',hardware:'Hardware',marketplace:'Marketplace',govtech:'GovTech',cybersecurity:'Cybersecurity',cleantech:'Cleantech',proptech:'PropTech',defense:'Defense',logistics:'Logistics',energy:'Energy'};
const TYPE_MAP={vc:'VC',angel:'Angel',family_office:'Family Office',corp_vc:'Corp VC',angel_group:'Angel Group'};
const GEO_MAP={us:'US',eu:'EU',asia:'Asia',global:'Global'};

function normalizeInvestor(inv){
  inv.stages=(inv.stages||[]).map(s=>STAGE_MAP[s]||s);
  inv.sectors=(inv.sectors||[]).map(s=>SECTOR_MAP[s]||s);
  inv.type=TYPE_MAP[inv.type]||inv.type;
  inv.geography=(inv.geography||[]).map(g=>GEO_MAP[g]||g);
  // Normalize links
  if(!inv.links){
    inv.links={
      linkedin:inv.linkedIn||inv.linkedin||null,
      twitter:inv.twitter?(/^http/.test(inv.twitter)?inv.twitter:'https://twitter.com/'+inv.twitter.replace('@','')):null,
      website:inv.firmUrl||inv.website||null
    };
  }
  if(!inv.fundStatus)inv.fundStatus=inv.activelyDeploying?'Actively Deploying':'Unknown';
  if(!inv.title)inv.title=inv.type;
  return inv;
}

// ===== INIT =====
async function init(){
  // Show loading skeleton
  const grid=document.getElementById('resultsGrid');
  grid.innerHTML=Array(6).fill('<div class="skeleton-card"><div class="skeleton-circle"></div><div class="skeleton-line w60"></div><div class="skeleton-line w40"></div><div class="skeleton-line w80"></div><div class="skeleton-line w60"></div></div>').join('');
  try{const r=await fetch('data/investors.json');if(r.ok)investors=(await r.json()).map(normalizeInvestor);else throw new Error('Fetch failed')}catch(e){investors=[];grid.innerHTML='<div class="no-results"><div class="no-results-icon">⚠️</div>Failed to load investor data.<div class="no-results-hint">Please refresh the page or try again later.</div></div>';return}
  updateSavedCount();
  document.getElementById('investorCountHero').textContent=investors.length;
  updateChipCounts();
  applyTheme(getPreferredTheme());
  renderRecentlyViewed();
  handleHash();
  renderResults();
}

// ===== ROUTING =====
function handleHash(){
  const h=location.hash;
  if(h.startsWith('#investor=')){showSection('search');openProfileById(h.split('=')[1])}
  else if(h==='#saved')showSection('saved');
  else if(h==='#search')showSection('search');
  else showSection('hero');
}
window.addEventListener('hashchange',handleHash);
window.addEventListener('popstate',function(){
  const overlay=document.getElementById('modalOverlay');
  if(overlay.classList.contains('open')&&!location.hash.startsWith('#investor=')){
    overlay.classList.remove('animate-in');overlay.classList.add('animate-out');
    setTimeout(()=>{overlay.classList.remove('open','animate-out');document.body.style.overflow=''},300);
  } else { handleHash(); }
});

let _currentSection='hero';
function showSection(s){
  if(s===_currentSection)return;
  const ids=['hero','search-section','saved-section'];
  const sectionMap={hero:'hero',search:'search-section',saved:'saved-section'};
  const oldEl=document.getElementById(sectionMap[_currentSection]);
  const newEl=document.getElementById(sectionMap[s]);
  // Update nav active state
  document.querySelectorAll('.nav-links a, .nav-links button').forEach(el=>el.classList.remove('nav-active'));
  const navMap={hero:0,search:1,saved:2};
  const navEls=document.querySelectorAll('.nav-links a, .nav-links button');
  if(navEls[navMap[s]])navEls[navMap[s]].classList.add('nav-active');
  // Respect reduced motion
  const reducedMotion=window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  if(reducedMotion||!oldEl){
    ids.forEach(id=>{document.getElementById(id).style.display='none'});
    newEl.style.display='';
    if(s==='saved')renderSaved();
    if(s==='search')newEl.scrollIntoView({behavior:'auto'});
    _currentSection=s;
    return;
  }
  // Animate out old, then in new
  oldEl.classList.add('section-fade-out');
  oldEl.addEventListener('animationend',function handler(){
    oldEl.removeEventListener('animationend',handler);
    oldEl.classList.remove('section-fade-out');
    ids.forEach(id=>{document.getElementById(id).style.display='none'});
    if(s==='saved')renderSaved();
    newEl.style.display='';
    newEl.classList.add('section-transitioning');
    if(s==='search')newEl.scrollIntoView({behavior:'auto'});
    newEl.addEventListener('animationend',function h2(){
      newEl.removeEventListener('animationend',h2);
      newEl.classList.remove('section-transitioning');
    });
  });
  _currentSection=s;
}

// ===== FORMAT =====
function fmt(n){if(n>=1e6)return'$'+Math.round(n/1e6)+'M';if(n>=1e3)return'$'+Math.round(n/1e3)+'K';return'$'+n}
function initials(name){return name.split(' ').map(w=>w[0]).join('')}
function typeClass(t){return'type-'+t.toLowerCase().replace(/\s+/g,'-')}

// ===== FILTERS =====
document.querySelectorAll('.chip[data-filter]').forEach(c=>{
  c.setAttribute('role','checkbox');
  c.setAttribute('aria-checked','false');
  c.addEventListener('click',()=>{
    const f=c.dataset.filter,v=c.dataset.value;
    c.classList.toggle('active');
    const isActive=c.classList.contains('active');
    c.setAttribute('aria-checked',isActive);
    if(isActive)activeFilters[f].push(v);
    else activeFilters[f]=activeFilters[f].filter(x=>x!==v);
    // Clear preset highlight when manually changing filters
    if(activePreset){activePreset=null;document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'))}
    renderResults();
  });
});

const checkMin=document.getElementById('checkMin'),checkMax=document.getElementById('checkMax'),checkDisplay=document.getElementById('checkDisplay');
function updateCheckDisplay(){checkDisplay.textContent=fmt(+checkMin.value)+' – '+fmt(+checkMax.value)+(+checkMax.value>=25e6?'+':'')}
checkMin.addEventListener('input',()=>{if(+checkMin.value>+checkMax.value)checkMax.value=checkMin.value;updateCheckDisplay();renderResults()});
checkMax.addEventListener('input',()=>{if(+checkMax.value<+checkMin.value)checkMin.value=checkMax.value;updateCheckDisplay();renderResults()});

// ===== SEARCH =====
const searchInput=document.getElementById('searchInput'),clearBtn=document.getElementById('clearSearch');
let debounceTimer;
searchInput.addEventListener('input',()=>{
  clearBtn.classList.toggle('show',searchInput.value.length>0);
  // Show syntax help when input is focused and has content but no syntax yet
  const helpEl=document.getElementById('searchSyntaxHelp');
  const val=searchInput.value;
  const hasSyntax=/\w+:[<>]?\S+/.test(val);
  helpEl.classList.toggle('show',val.length>0&&val.length<3&&!hasSyntax);
  clearTimeout(debounceTimer);debounceTimer=setTimeout(renderResults,200);
});
searchInput.addEventListener('focus',()=>{
  const helpEl=document.getElementById('searchSyntaxHelp');
  if(!searchInput.value)helpEl.classList.add('show');
});
searchInput.addEventListener('blur',()=>{
  setTimeout(()=>document.getElementById('searchSyntaxHelp').classList.remove('show'),200);
});
// Click syntax examples to insert
document.querySelectorAll('.syntax-examples code').forEach(el=>{
  el.addEventListener('mousedown',e=>{
    e.preventDefault();
    const current=searchInput.value;
    searchInput.value=(current?current+' ':'')+el.textContent;
    searchInput.focus();
    clearBtn.classList.add('show');
    clearTimeout(debounceTimer);debounceTimer=setTimeout(renderResults,200);
  });
});
function clearSearch(){searchInput.value='';clearBtn.classList.remove('show');document.getElementById('syntaxActive').classList.remove('show');document.getElementById('syntaxActive').innerHTML='';renderResults()}

// ===== RENDER =====
// ===== ADVANCED SEARCH SYNTAX =====
// Parses queries like "climate stage:seed sector:ai check:>500k type:vc geo:us active:yes"
function getPortfolioCompanies(inv){
  const all=[];
  (inv.recentInvestments||[]).forEach(i=>all.push(i.company));
  (inv.portfolioHighlights||[]).forEach(p=>all.push(p.replace(/\s*\(.*\)/,'').trim()));
  return all;
}

function parseSearchQuery(raw){
  const syntaxPattern=/(\w+):([<>]?\S+)/gi;
  const structured={};
  let freeText=raw;
  let match;
  while((match=syntaxPattern.exec(raw))!==null){
    const key=match[1].toLowerCase();
    const val=match[2].toLowerCase();
    if(!structured[key])structured[key]=[];
    structured[key].push(val);
    freeText=freeText.replace(match[0],'');
  }
  freeText=freeText.trim().replace(/\s+/g,' ');
  return{structured,freeText};
}

function parseCheckAmount(s){
  s=s.replace(/[$,]/g,'').toLowerCase();
  const m=s.match(/^([<>]?)(\d+(?:\.\d+)?)(k|m)?$/);
  if(!m)return null;
  let num=parseFloat(m[2]);
  if(m[3]==='k')num*=1e3;
  if(m[3]==='m')num*=1e6;
  return{op:m[1]||'=',amount:num};
}

// Alias maps for flexible syntax matching
const SYNTAX_STAGE_ALIASES={'preseed':'Pre-Seed','pre-seed':'Pre-Seed','seed':'Seed','seriesa':'Series A','series-a':'Series A','a':'Series A','seriesb':'Series B','series-b':'Series B','b':'Series B','growth':'Growth'};
const SYNTAX_SECTOR_ALIASES={'saas':'SaaS','fintech':'Fintech','healthtech':'HealthTech','health':'HealthTech','ai':'AI/ML','ai/ml':'AI/ML','ml':'AI/ML','consumer':'Consumer','enterprise':'Enterprise','climate':'Climate','crypto':'Crypto','web3':'Crypto','biotech':'Biotech','deeptech':'DeepTech','deep':'DeepTech','edtech':'EdTech','hardware':'Hardware','marketplace':'Marketplace'};
const SYNTAX_TYPE_ALIASES={'vc':'VC','angel':'Angel','family':'Family Office','familyoffice':'Family Office','family-office':'Family Office','corp':'Corp VC','corpvc':'Corp VC','corp-vc':'Corp VC','corporate':'Corp VC','angelgroup':'Angel Group','angel-group':'Angel Group'};
const SYNTAX_GEO_ALIASES={'us':'US','usa':'US','eu':'EU','europe':'EU','asia':'Asia','global':'Global'};

function matchSyntaxFilter(inv,structured){
  // Stage filter from syntax
  if(structured.stage){
    const stages=structured.stage.map(s=>SYNTAX_STAGE_ALIASES[s.toLowerCase()]||s);
    if(!stages.some(s=>inv.stages.some(is=>is.toLowerCase()===s.toLowerCase())))return false;
  }
  // Sector filter from syntax
  if(structured.sector){
    const sectors=structured.sector.map(s=>SYNTAX_SECTOR_ALIASES[s.toLowerCase()]||s);
    if(!sectors.some(s=>inv.sectors.some(is=>is.toLowerCase()===s.toLowerCase())))return false;
  }
  // Type filter from syntax
  if(structured.type){
    const types=structured.type.map(t=>SYNTAX_TYPE_ALIASES[t.toLowerCase()]||t);
    if(!types.some(t=>inv.type.toLowerCase()===t.toLowerCase()))return false;
  }
  // Geo filter from syntax
  if(structured.geo||structured.geography||structured.location){
    const geos=[...(structured.geo||[]),...(structured.geography||[]),...(structured.location||[])].map(g=>SYNTAX_GEO_ALIASES[g.toLowerCase()]||g);
    if(!geos.some(g=>inv.geography.some(ig=>ig.toLowerCase()===g.toLowerCase())||inv.location.toLowerCase().includes(g.toLowerCase())))return false;
  }
  // Check size from syntax: check:>500k, check:<5m
  if(structured.check||structured.checksize){
    const checks=[...(structured.check||[]),...(structured.checksize||[])];
    for(const c of checks){
      const parsed=parseCheckAmount(c);
      if(!parsed)continue;
      if(parsed.op==='>'){if(inv.checkSize.max<parsed.amount)return false}
      else if(parsed.op==='<'){if(inv.checkSize.min>parsed.amount)return false}
      else{if(inv.checkSize.max<parsed.amount||inv.checkSize.min>parsed.amount)return false}
    }
  }
  // Active filter from syntax
  if(structured.active){
    const val=structured.active[0];
    if(val==='yes'||val==='true'||val==='1'){if(!inv.activelyDeploying)return false}
    if(val==='no'||val==='false'||val==='0'){if(inv.activelyDeploying)return false}
  }
  // Entity filter from syntax
  if(structured.entity){
    if(!structured.entity.some(e=>inv.entity.toLowerCase().startsWith(e.toLowerCase())))return false;
  }
  // Firm filter from syntax
  if(structured.firm){
    if(!structured.firm.some(f=>(inv.firm||'').toLowerCase().includes(f.toLowerCase())))return false;
  }
  // Portfolio filter from syntax
  if(structured.portfolio||structured.invested){
    const terms=[...(structured.portfolio||[]),...(structured.invested||[])];
    const allPortfolio=getPortfolioCompanies(inv);
    const matched=terms.filter(t=>allPortfolio.some(p=>p.toLowerCase().includes(t.toLowerCase())));
    if(!matched.length)return false;
    inv._portfolioMatch=matched.map(t=>allPortfolio.find(p=>p.toLowerCase().includes(t.toLowerCase()))||t);
  }
  return true;
}

function updateSyntaxIndicator(structured){
  const el=document.getElementById('syntaxActive');
  const keys=Object.keys(structured);
  if(!keys.length){el.classList.remove('show');el.innerHTML='';return}
  el.classList.add('show');
  el.innerHTML=keys.map(k=>`<span class="syntax-badge">${k}:${structured[k].join(',')}</span>`).join('');
}

function filterInvestors(){
  const raw=searchInput.value.toLowerCase();
  const {structured,freeText}=parseSearchQuery(raw);
  const cMin=+checkMin.value,cMax=+checkMax.value;
  const actMonths=document.getElementById('activityFilter').value;

  // Show/hide syntax help
  const helpEl=document.getElementById('searchSyntaxHelp');
  const hasSyntax=Object.keys(structured).length>0;
  helpEl.classList.toggle('show',raw.length>0&&!hasSyntax&&raw.includes(':')===false);
  updateSyntaxIndicator(structured);

  return investors.filter(inv=>{
    // Apply structured syntax filters
    if(hasSyntax&&!matchSyntaxFilter(inv,structured))return false;

    // Apply free text search (fuzzy) — includes portfolio companies
    if(freeText){
      const portfolioNames=getPortfolioCompanies(inv);
      const fields=[inv.name,inv.firm,inv.thesis,inv.location,...inv.sectors,...inv.stages,...inv.geography,inv.type].map(s=>(s||'').toLowerCase());
      const portfolioFields=portfolioNames.map(s=>s.toLowerCase());
      const allFields=[...fields,...portfolioFields];
      const words=freeText.split(/\s+/).filter(Boolean);
      const match=words.every(w=>allFields.some(f=>f.includes(w)));
      if(!match){
        const fuzzy=words.every(w=>{
          if(w.length<=3)return allFields.some(f=>f.includes(w));
          return allFields.some(f=>{
            for(let i=0;i<=f.length-w.length;i++){
              let diff=0;
              for(let j=0;j<w.length;j++){if(f[i+j]!==w[j])diff++;if(diff>1)break}
              if(diff<=1)return true;
            }
            return false;
          });
        });
        if(!fuzzy)return false;
      }
      // Track portfolio matches for badge display
      const portfolioMatches=portfolioNames.filter(p=>words.some(w=>p.toLowerCase().includes(w)));
      if(portfolioMatches.length)inv._portfolioMatch=portfolioMatches;
      else delete inv._portfolioMatch;
    } else { delete inv._portfolioMatch; }
    if(activeFilters.stage.length&&!activeFilters.stage.some(s=>inv.stages.includes(s)))return false;
    if(activeFilters.sector.length&&!activeFilters.sector.some(s=>inv.sectors.includes(s)))return false;
    if(activeFilters.type.length&&!activeFilters.type.includes(inv.type))return false;
    if(activeFilters.geo.length&&!activeFilters.geo.some(g=>inv.geography.includes(g)))return false;
    if(activeFilters.entity.length&&!activeFilters.entity.includes(inv.entity))return false;
    if(inv.checkSize.max<cMin||inv.checkSize.min>cMax)return false;
    if(actMonths!=='any'&&inv.lastActive){
      const cutoff=new Date();cutoff.setMonth(cutoff.getMonth()-parseInt(actMonths));
      const lastAct=new Date(inv.lastActive);
      if(lastAct<cutoff)return false;
    }
    return true;
  });
}

function sortInvestors(list){
  const s=document.getElementById('sortSelect').value;
  if(s==='matchScore')return[...list].sort((a,b)=>(b._matchScore||0)-(a._matchScore||0));
  if(s==='recent')return[...list].sort((a,b)=>new Date(b.lastActive)-new Date(a.lastActive));
  if(s==='checkSize')return[...list].sort((a,b)=>b.checkSize.max-a.checkSize.max);
  if(s==='checkSizeAsc')return[...list].sort((a,b)=>a.checkSize.min-b.checkSize.min);
  if(s==='nameAZ')return[...list].sort((a,b)=>a.name.localeCompare(b.name));
  if(s==='nameZA')return[...list].sort((a,b)=>b.name.localeCompare(a.name));
  if(s==='location')return[...list].sort((a,b)=>(a.location||'').localeCompare(b.location||''));
  return list;
}

// ===== MATCH SCORING =====
let matchProfile={stage:'',sectors:[],raise:'',geo:''};
let matchScoresActive=false;

function toggleMatchPanel(){
  const body=document.getElementById('matchPanelBody');
  const chev=document.getElementById('matchToggleChevron');
  const open=body.style.display==='none';
  body.style.display=open?'block':'none';
  chev.classList.toggle('open',open);
}

function toggleMatchSector(btn,sector){
  btn.classList.toggle('active');
  const idx=matchProfile.sectors.indexOf(sector);
  if(idx>=0)matchProfile.sectors.splice(idx,1);else matchProfile.sectors.push(sector);
  computeMatchScores();
}

function clearMatchProfile(){
  matchProfile={stage:'',sectors:[],raise:'',geo:''};
  document.getElementById('matchStage').value='';
  document.getElementById('matchRaise').value='';
  document.getElementById('matchGeo').value='';
  document.querySelectorAll('#matchSectorChips .chip').forEach(c=>c.classList.remove('active'));
  matchScoresActive=false;
  investors.forEach(inv=>inv._matchScore=0);
  document.getElementById('matchStatus').textContent='';
  renderResults();
}

function getMatchProfile(){
  return{
    stage:document.getElementById('matchStage').value,
    sectors:matchProfile.sectors,
    raise:+document.getElementById('matchRaise').value||0,
    geo:document.getElementById('matchGeo').value
  };
}

function computeMatchScores(){
  const p=getMatchProfile();
  const hasInput=p.stage||p.sectors.length||p.raise||p.geo;
  matchScoresActive=!!hasInput;
  if(!hasInput){
    investors.forEach(inv=>inv._matchScore=0);
    document.getElementById('matchStatus').textContent='';
    renderResults();return;
  }

  const stageMap={'Pre-Seed':'pre_seed','Seed':'seed','Series A':'series_a','Series B':'series_b','Growth':'growth'};
  const stageNorm=stageMap[p.stage]||p.stage.toLowerCase();

  investors.forEach(inv=>{
    let score=0,max=0;

    // Stage match (0-30 pts)
    if(p.stage){
      max+=30;
      const invStages=inv.stages.map(s=>s.toLowerCase().replace(/[\s-]/g,'_'));
      if(invStages.includes(stageNorm))score+=30;
      else{
        // Adjacent stage partial credit
        const order=['pre_seed','seed','series_a','series_b','growth'];
        const pi=order.indexOf(stageNorm);
        const closest=Math.min(...invStages.map(s=>Math.abs(order.indexOf(s)-pi)).filter(d=>d>0));
        if(closest===1)score+=15;
        else if(closest===2)score+=5;
      }
    }

    // Sector overlap (0-30 pts)
    if(p.sectors.length){
      max+=30;
      const invSectors=inv.sectors.map(s=>s.toLowerCase().replace(/[\/\s]/g,''));
      const pSectors=p.sectors.map(s=>s.toLowerCase().replace(/[\/\s]/g,''));
      const overlap=pSectors.filter(s=>invSectors.some(is=>is.includes(s)||s.includes(is))).length;
      score+=Math.min(30,Math.round((overlap/pSectors.length)*30));
    }

    // Check size / raise fit (0-25 pts)
    if(p.raise){
      max+=25;
      const min=inv.checkSize.min,mx=inv.checkSize.max;
      if(p.raise>=min&&p.raise<=mx)score+=25;
      else if(p.raise>=min*0.5&&p.raise<=mx*2)score+=15;
      else if(p.raise>=min*0.2&&p.raise<=mx*5)score+=5;
    }

    // Geography (0-15 pts)
    if(p.geo){
      max+=15;
      const invGeo=inv.geography.map(g=>g.toLowerCase());
      const pGeo=p.geo.toLowerCase();
      if(invGeo.includes(pGeo)||invGeo.includes('global'))score+=15;
      else if(pGeo==='global')score+=10;
    }

    inv._matchScore=max>0?Math.round((score/max)*100):0;
  });

  const matched=investors.filter(i=>i._matchScore>=50).length;
  document.getElementById('matchStatus').textContent=matched+' strong match'+(matched!==1?'es':'');

  // Auto-sort by match score
  document.getElementById('sortSelect').value='matchScore';
  renderResults();
}

function getActiveFilterCount(){
  let count=Object.values(activeFilters).reduce((a,b)=>a+b.length,0);
  if(+checkMin.value>0||+checkMax.value<25e6)count++;
  if(document.getElementById('activityFilter').value!=='any')count++;
  return count;
}

// ===== VIRTUAL SCROLLING =====
const CARD_HEIGHT_EST=320; // estimated card height in px
const CARD_GAP=16;
const VIRTUAL_BUFFER=6; // extra rows to render above/below viewport
let virtualScrollRAF=null;
let lastVirtualRange={start:-1,end:-1};

function getGridCols(){
  const w=window.innerWidth;
  if(w<=600)return 1;
  if(w<=900)return 2;
  return 3;
}

const MOBILE_PAGE_SIZE=20;
let mobileVisibleCount=MOBILE_PAGE_SIZE;
function isMobileView(){return window.innerWidth<768}
function hasActiveSearch(){return searchInput.value.trim().length>0}

function renderResults(resetPage=true){
  const filtered=sortInvestors(filterInvestors());
  lastFiltered=filtered;
  if(currentView==='map')renderMap();
  kbFocusIndex=-1;
  if(resetPage)mobileVisibleCount=MOBILE_PAGE_SIZE;
  document.getElementById('resultsCount').textContent=filtered.length+' investor'+(filtered.length!==1?'s':'');
  const fc=getActiveFilterCount();
  const badge=document.getElementById('filterBadge');
  const clearBtn=document.getElementById('clearFiltersBtn');
  badge.textContent=fc?' ('+fc+' filter'+(fc>1?'s':'')+' active)':'';
  clearBtn.style.display=fc?'inline-block':'none';
  updateFilterUI();
  const grid=document.getElementById('resultsGrid');
  const loadMoreContainer=document.getElementById('loadMoreContainer');
  if(!filtered.length){grid.innerHTML='<div class="no-results"><div class="no-results-icon">🔍</div>No investors match your filters.<div class="no-results-hint">Try removing some filters or broadening your search terms.<br><button class="btn-secondary" onclick="clearAllFilters()" style="margin-top:12px;padding:8px 20px">Clear All Filters</button></div></div>';loadMoreContainer.style.display='none';return}
  // On mobile, paginate unless searching
  const usePagination=isMobileView()&&!hasActiveSearch();
  const visible=usePagination?filtered.slice(0,mobileVisibleCount):filtered;
  grid.style.minHeight='';
  grid.innerHTML=visible.map((inv,i)=>cardHTML(inv,i)).join('');
  // Update load more UI
  if(usePagination&&mobileVisibleCount<filtered.length){
    loadMoreContainer.style.display='flex';
    document.getElementById('showingCount').textContent='Showing '+visible.length+' of '+filtered.length+' investors';
    document.getElementById('loadMoreBtn').style.display='';
  }else if(usePagination&&mobileVisibleCount>=filtered.length){
    loadMoreContainer.style.display='flex';
    document.getElementById('showingCount').textContent='Showing all '+filtered.length+' investors';
    document.getElementById('loadMoreBtn').style.display='none';
  }else{
    loadMoreContainer.style.display='none';
  }
  // Update visual charts if tab is visible
  if(document.getElementById('tabVisual')?.classList.contains('active'))renderVisualCharts();
}

function loadMore(){
  const prevCount=mobileVisibleCount;
  mobileVisibleCount+=MOBILE_PAGE_SIZE;
  renderResults(false);
  // Scroll to first new card
  const cards=document.querySelectorAll('#resultsGrid .investor-card');
  if(cards[prevCount]){
    setTimeout(()=>{cards[prevCount].scrollIntoView({behavior:'smooth',block:'start'})},50);
  }
}

function clearAllFilters(){
  activeFilters={stage:[],sector:[],type:[],geo:[],entity:[]};
  activePreset=null;
  document.querySelectorAll('.chip.active').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
  checkMin.value=0;checkMax.value=25e6;updateCheckDisplay();
  document.getElementById('activityFilter').value='any';
  searchInput.value='';clearBtn.classList.remove('show');
  renderResults();
}

// ===== EXPORT =====
function exportFiltered(format){
  if(!lastFiltered||!lastFiltered.length)return;
  const now=new Date();const dateStr=now.toISOString().slice(0,10);
  // Build filename context from active filters
  const parts=['match-capital'];
  if(activeFilters.stage.length)parts.push(activeFilters.stage.join('-').toLowerCase().replace(/\s+/g,'-'));
  if(activeFilters.sector.length)parts.push(activeFilters.sector.slice(0,2).join('-').toLowerCase().replace(/[\s/]+/g,'-'));
  if(activeFilters.type.length)parts.push(activeFilters.type.join('-').toLowerCase().replace(/\s+/g,'-'));
  if(parts.length===1)parts.push('all-investors');
  parts.push(dateStr);
  const filename=parts.join('-');

  let blob;
  if(format==='json'){
    blob=new Blob([JSON.stringify(lastFiltered,null,2)],{type:'application/json'});
    triggerDownload(blob,filename+'.json');
  }else{
    const headers=['Name','Firm','Title','Type','Stages','Sectors','Check Min','Check Max','Geography','Location','LinkedIn','Firm URL','Thesis'];
    const esc=v=>{const s=String(v??'');return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s.replace(/"/g,'""')+'"':s};
    const rows=lastFiltered.map(inv=>[
      esc(inv.name),esc(inv.firm),esc(inv.title||''),esc(inv.type),
      esc((inv.stages||[]).join('; ')),esc((inv.sectors||[]).join('; ')),
      inv.checkSize?inv.checkSize.min:'',inv.checkSize?inv.checkSize.max:'',
      esc((inv.geography||[]).join('; ')),esc(inv.location||''),
      esc(inv.linkedin||''),esc(inv.firmUrl||inv.website||''),esc(inv.thesis||'')
    ].join(','));
    const csv=headers.join(',')+'\n'+rows.join('\n');
    blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    triggerDownload(blob,filename+'.csv');
  }
}
function triggerDownload(blob,filename){
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== FILTER PRESETS =====
let activePreset=null;
const FILTER_PRESETS={
  dcSeed:{stage:['Seed'],geo:['dmv','mid_atlantic']},
  nycSeriesA:{stage:['Series A'],geo:['nyc']},
  govtechImpact:{sector:['GovTech','Cleantech','Climate']},
  earlyStage:{stage:['Pre-Seed','Seed']},
  growth:{stage:['Series B','Growth']},
  westCoast:{geo:['sf_bay']}
};
function togglePreset(name){
  if(activePreset===name){
    // Deactivate — clear filters set by preset
    activePreset=null;
    activeFilters={stage:[],sector:[],type:[],geo:[],entity:[]};
    syncChipsToFilters();
    document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'));
    renderResults();
    return;
  }
  // Activate preset
  activePreset=name;
  const preset=FILTER_PRESETS[name];
  activeFilters={stage:[],sector:[],type:[],geo:[],entity:[]};
  Object.entries(preset).forEach(([k,v])=>{activeFilters[k]=[...v]});
  syncChipsToFilters();
  document.querySelectorAll('.preset-btn').forEach(b=>{
    b.classList.toggle('active',b.dataset.preset===name);
  });
  renderResults();
}
function syncChipsToFilters(){
  document.querySelectorAll('.chip[data-filter]').forEach(c=>{
    const f=c.dataset.filter,v=c.dataset.value;
    const isActive=activeFilters[f]&&activeFilters[f].includes(v);
    c.classList.toggle('active',isActive);
    c.setAttribute('aria-checked',isActive);
  });
}

function cardHTML(inv,idx){
  const isCompared=compareIds.includes(inv.id);
  const sectorTags=inv.sectors.slice(0,3).map(s=>`<span class="tag-sector">${s}</span>`).join('');
  const overflow=inv.sectors.length>3?`<span class="tag-overflow">+${inv.sectors.length-3}</span>`:'';
  const delay=Math.min((idx||0)*0.05,0.8);
  const isOrg=inv.entity==='organization';
  const avatarClass=isOrg?'avatar avatar-org':'avatar';
  const avatarContent=inv.photo?`<img src="${inv.photo}" alt="${inv.name}" class="avatar-img" onerror="this.replaceWith(document.createTextNode('${isOrg?'🏢':initials(inv.name)}'))">`:(isOrg?'🏢':initials(inv.name));
  const firmLine=isOrg?(inv.memberCount?`<div class="firm"><span class="member-count-badge">👥 ${inv.memberCount} members</span></div>`:''):`<div class="firm">${inv.firm||''}</div>`;
  const matchBadge=matchScoresActive&&inv._matchScore>0?`<div class="match-score-badge ${inv._matchScore>=70?'score-high':inv._matchScore>=40?'score-med':'score-low'}">${inv._matchScore}% match</div>`:'';
  return`<div class="investor-card" onclick="openProfile('${inv.id}')" style="animation-delay:${delay}s" role="listitem" tabindex="0" aria-label="${inv.name}, ${inv.firm||inv.type}, ${inv.stages.join(', ')}${matchScoresActive?' Match score '+inv._matchScore+'%':''}" data-investor-id="${inv.id}" onkeydown="cardKeyHandler(event,'${inv.id}')">
    ${matchBadge}
    <button class="compare-btn ${isCompared?'selected':''}" onclick="event.stopPropagation();toggleCompare('${inv.id}')" aria-label="${isCompared?'Remove '+inv.name+' from comparison':'Add '+inv.name+' to comparison'}" aria-pressed="${isCompared}">
      ${isCompared?'✓':'＋'}
    </button>
    <div class="card-header">
      <div class="${avatarClass}">${avatarContent}</div>
      ${inv.activelyDeploying?'<div class="active-badge"><span class="dot"></span>Active</div>':''}
    </div>
    <div class="name">${inv.name}</div>
    ${firmLine}
    <div class="sector-tags">${sectorTags}${overflow}</div>
    <span class="type-badge ${typeClass(inv.type)}">${inv.type}</span>
    <div class="card-thesis">${inv.thesis}</div>
    <div class="tags">
      ${inv.stages.map(s=>`<span class="tag tag-stage">${s}</span>`).join('')}
    </div>
    <div class="check-size">💰 ${fmt(inv.checkSize.min)} – ${fmt(inv.checkSize.max)}</div>
    ${inv._portfolioMatch?`<div class="portfolio-match-badge">💼 Invested in: ${[...new Set(inv._portfolioMatch)].slice(0,3).join(', ')}</div>`:''}
    <div class="location">${inv.location}</div>
    <button class="find-similar-btn" onclick="openSimilarPanel('${inv.id}',event)" aria-label="Find investors similar to ${inv.name}">🔍 Find Similar</button>
  </div>`
}

// ===== PROFILE MODAL =====
function openProfileById(id){const inv=investors.find(i=>i.id===id);if(inv)openProfile(id)}

function getActivityStatus(lastActive){
  if(!lastActive)return{color:'gray',label:'Unknown'};
  const now=new Date(),last=new Date(lastActive);
  const months=(now-last)/(1000*60*60*24*30);
  if(months<=3)return{color:'green',label:'Active recently'};
  if(months<=6)return{color:'yellow',label:'Active 3-6mo ago'};
  return{color:'gray',label:'6+ months ago'};
}

function buildTimeline(inv){
  const investments=inv.recentInvestments||[];
  if(!investments.length) return '<p style="color:var(--text-dim);font-size:0.85rem">No recent investment data available.</p>';
  // Group by year, sort descending
  const byYear={};
  investments.forEach(i=>{const y=i.year||'Unknown';if(!byYear[y])byYear[y]=[];byYear[y].push(i)});
  const years=Object.keys(byYear).sort((a,b)=>b-a);
  const roundClass=r=>{const l=r.toLowerCase();if(l.includes('seed'))return'seed';if(l.includes('series a')||l==='a')return'series-a';if(l.includes('series b')||l==='b')return'series-b';if(l.includes('series c')||l.includes('growth')||l.includes('series d'))return'growth';return'series-a'};
  // Summary stats
  const uniqueYears=years.filter(y=>y!=='Unknown').length;
  const roundCounts={};investments.forEach(i=>{const r=i.round;roundCounts[r]=(roundCounts[r]||0)+1});
  const topRound=Object.entries(roundCounts).sort((a,b)=>b[1]-a[1])[0];
  const latestYear=years.find(y=>y!=='Unknown')||'—';
  let delay=0;
  let html='<div class="timeline-summary">';
  html+=`<div class="timeline-stat">📈 <span class="stat-val">${investments.length}</span> deals tracked</div>`;
  html+=`<div class="timeline-stat">📅 <span class="stat-val">${uniqueYears}</span> active years</div>`;
  if(topRound)html+=`<div class="timeline-stat">🎯 Most common: <span class="stat-val">${topRound[0]}</span></div>`;
  html+=`<div class="timeline-stat">🕐 Latest: <span class="stat-val">${latestYear}</span></div>`;
  html+='</div>';
  html+='<div class="activity-timeline" style="margin-top:14px">';
  years.forEach(year=>{
    byYear[year].forEach((inv,idx)=>{
      const rc=roundClass(inv.round);
      html+=`<div class="timeline-item year-${rc}" style="animation-delay:${delay*80}ms">`;
      html+=`<div class="timeline-dot"></div>`;
      if(idx===0) html+=`<div class="timeline-year-label">${year}</div>`;
      html+=`<div class="timeline-card"><span class="timeline-company">${inv.company}</span><span class="timeline-round round-${rc}">${inv.round}</span></div>`;
      html+='</div>';
      delay++;
    });
  });
  html+='</div>';
  return html;
}
function getPortfolioCount(inv){
  const all=new Set();
  (inv.recentInvestments||[]).forEach(i=>all.add(i.company));
  (inv.portfolioHighlights||[]).forEach(p=>{const name=p.replace(/\s*\(.*\)/,'').trim();all.add(name)});
  return all.size;
}

function isVerified(inv){return !!(inv.links.linkedin && inv.links.website)}

function findSimilarInvestors(inv, limit=5){
  const invGeoSet=new Set(inv.geography||[]);
  const invStageSet=new Set(inv.stages||[]);
  const invSectorSet=new Set(inv.sectors||[]);
  const invCheckMid=(inv.checkSize.min+inv.checkSize.max)/2;
  const invCheckRange=inv.checkSize.max-inv.checkSize.min||1;
  return investors.map(other=>{
    if(other.id===inv.id)return null;
    let score=0; const reasons=[];
    // Stage overlap (max 25pts)
    const stageOverlap=(other.stages||[]).filter(s=>invStageSet.has(s));
    const stageScore=invStageSet.size?Math.round((stageOverlap.length/invStageSet.size)*25):0;
    score+=stageScore;
    if(stageOverlap.length) reasons.push('Same stage: '+stageOverlap.join(', '));
    // Sector overlap (max 30pts)
    const sectorOverlap=(other.sectors||[]).filter(s=>invSectorSet.has(s));
    const sectorScore=invSectorSet.size?Math.round((sectorOverlap.length/invSectorSet.size)*30):0;
    score+=sectorScore;
    if(sectorOverlap.length) reasons.push('Similar sectors: '+sectorOverlap.slice(0,3).join(', '));
    // Check size similarity (max 20pts)
    const otherMid=(other.checkSize.min+other.checkSize.max)/2;
    const checkDiff=Math.abs(invCheckMid-otherMid);
    const maxCheck=Math.max(invCheckMid,otherMid)||1;
    const checkScore=Math.round(Math.max(0,(1-checkDiff/maxCheck))*20);
    score+=checkScore;
    if(checkScore>=14) reasons.push('Similar check size');
    // Geography overlap (max 15pts)
    const geoOverlap=(other.geography||[]).filter(g=>invGeoSet.has(g));
    const geoScore=invGeoSet.size?Math.round((geoOverlap.length/invGeoSet.size)*15):0;
    score+=geoScore;
    if(geoOverlap.length) reasons.push('Same region');
    // Investor type match (max 10pts)
    if(other.type===inv.type){score+=10;reasons.push('Same type: '+inv.type);}
    if(score<15)return null;
    return{...other,_simScore:score,_simReasons:reasons};
  }).filter(Boolean).sort((a,b)=>b._simScore-a._simScore).slice(0,limit);
}

function openSimilarPanel(investorId, evt){
  if(evt){evt.stopPropagation();evt.preventDefault();}
  const inv=investors.find(i=>i.id===investorId);if(!inv)return;
  const similar=findSimilarInvestors(inv,15);
  const html=`
    <button class="modal-close" onclick="closeSimilarPanel()" aria-label="Close">×</button>
    <div class="similar-panel-header">
      <h2>Investors similar to ${inv.name}</h2>
      <p style="color:var(--text-muted);font-size:0.85rem;margin-top:4px">${similar.length} matches found based on stage, sector, check size, geography & type</p>
    </div>
    <div class="similar-panel-list">
      ${similar.length?similar.map(s=>`
        <div class="similar-panel-item" onclick="closeSimilarPanel();openProfile('${s.id}')">
          <div class="sim-panel-left">
            <div class="sim-avatar">${s.photo?`<img src="${s.photo}" alt="${s.name}" class="sim-avatar-img" onerror="this.replaceWith(document.createTextNode('${initials(s.name)}'))">`:initials(s.name)}</div>
            <div>
              <div class="sim-name">${s.name}</div>
              <div class="sim-firm">${s.firm||''}</div>
              <div class="sim-reasons">${s._simReasons.slice(0,3).join(' · ')}</div>
            </div>
          </div>
          <div class="sim-score-badge">${s._simScore}<span class="sim-score-label">/ 100</span></div>
        </div>`).join(''):'<p style="color:var(--text-dim);text-align:center;padding:40px">No similar investors found.</p>'}
    </div>`;
  let panel=document.getElementById('similarPanel');
  if(!panel){
    panel=document.createElement('div');panel.id='similarPanel';
    panel.innerHTML='<div class="similar-panel-overlay" onclick="closeSimilarPanel()"></div><div class="similar-panel-content"></div>';
    document.body.appendChild(panel);
  }
  panel.querySelector('.similar-panel-content').innerHTML=html;
  panel.classList.add('open');
  document.body.style.overflow='hidden';
}
function closeSimilarPanel(){
  const panel=document.getElementById('similarPanel');
  if(panel){panel.classList.remove('open');document.body.style.overflow='';}
}

function toggleModalListDropdown(e,id){
  e.stopPropagation();
  const dd=document.getElementById('modalListDD-'+id);
  dd.classList.toggle('show');
  if(dd.classList.contains('show'))renderModalListDD(dd,id);
}
function renderModalListDD(dd,investorId){
  dd.innerHTML=Object.keys(namedLists).map(name=>{
    const isIn=(namedLists[name]||[]).includes(investorId);
    return`<label class="modal-list-dd-item" onclick="event.stopPropagation()"><input type="checkbox" ${isIn?'checked':''} onchange="toggleInListDD('${investorId}','${name.replace(/'/g,"\\'")}')"> ${name}</label>`;
  }).join('');
}
function toggleInListDD(investorId,listName){
  if(!namedLists[listName])namedLists[listName]=[];
  const list=namedLists[listName];
  const idx=list.indexOf(investorId);
  if(idx>=0)list.splice(idx,1);else list.push(investorId);
  saveLists();updateSavedCount();
}

function openProfile(id){
  history.pushState({investor:id},'','#investor='+id);
  const inv=investors.find(i=>i.id===id);if(!inv)return;
  trackView(id);
  const activity=getActivityStatus(inv.lastActive);
  const portfolioCount=getPortfolioCount(inv);
  const verified=false;
  const similar=findSimilarInvestors(inv);

  const isOrg=inv.entity==='organization';
  const modalAvatarClass=isOrg?'modal-avatar avatar-org':'modal-avatar';
  const modalAvatarContent=inv.photo?`<img src="${inv.photo}" alt="${inv.name}" class="modal-avatar-img" onerror="this.replaceWith(document.createTextNode('${isOrg?'🏢':initials(inv.name)}'))">`:(isOrg?'🏢':initials(inv.name));
  const firmLine=isOrg?(inv.title?`<div class="firm">${inv.title}</div>`:''):`<div class="firm">${inv.title} · ${inv.firm}</div>`;
  document.getElementById('modal').innerHTML=`
    <button class="modal-close" onclick="closeModal()" aria-label="Close profile">×</button>
    <div class="modal-header">
      <div class="${modalAvatarClass}">${modalAvatarContent}</div>
      <div class="modal-header-info">
        <h2>${inv.name}${verified?'<span class="verified-badge">✓ Verified</span>':''}</h2>
        ${firmLine}
        <div class="badges">
          <span class="type-badge ${typeClass(inv.type)}">${inv.type}</span>
          <span style="display:flex;align-items:center;gap:5px;font-size:0.8rem;color:var(--text-muted)"><span class="activity-dot ${activity.color}"></span>${activity.label}</span>
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
          <div class="modal-list-dropdown">
            <button class="btn-secondary" style="padding:8px 14px;font-size:0.82rem" onclick="toggleModalListDropdown(event,'${id}')">📋 Add to List</button>
            <div class="modal-list-dd-content" id="modalListDD-${id}"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-body">
      ${matchScoresActive&&inv._matchScore>0?`
      <div class="match-score-modal ${inv._matchScore>=70?'score-high':inv._matchScore>=40?'score-med':'score-low'}">
        <div class="match-score-number">${inv._matchScore}%</div>
        <div class="match-score-details">
          <strong>Match Score</strong> — Based on your startup profile
          <div class="match-score-bar"><div class="match-score-bar-fill" style="width:${inv._matchScore}%;background:${inv._matchScore>=70?'#10b981':inv._matchScore>=40?'#eab308':'#f87171'}"></div></div>
        </div>
      </div>`:''}
      <div class="social-proof">
        <div class="proof-item">📊 <span class="proof-val">${portfolioCount}</span> portfolio companies</div>
        <div class="proof-item">💰 <span class="proof-val">${fmt(inv.checkSize.min)}–${fmt(inv.checkSize.max)}</span> checks</div>
        <div class="proof-item">🌍 ${inv.geography.join(', ')}</div>
        ${inv.activelyDeploying?'<div class="proof-item" style="color:var(--green)">🟢 Actively Deploying</div>':''}
      </div>

      <div class="outreach-cta" onclick="toggleOutreach(this)" id="outreach-cta-${id}">
        <div class="cta-icon">✉️</div>
        <div class="cta-text"><strong>Draft Outreach Email</strong><span>Generate a personalized cold email for ${inv.name}</span></div>
        <div class="cta-arrow">›</div>
      </div>
      <div class="outreach-panel" id="outreach-panel-${id}">
        <div class="outreach-inner">
          <div class="outreach-form">
            <label>Your Name</label>
            <input type="text" id="outreach-name-${id}" placeholder="Jane Smith" value="${getOutreachField('name')}">
            <label>Your Company</label>
            <input type="text" id="outreach-company-${id}" placeholder="Acme Inc." value="${getOutreachField('company')}">
            <label>One-liner (what you're building)</label>
            <input type="text" id="outreach-oneliner-${id}" placeholder="AI-powered grant writing for nonprofits" value="${getOutreachField('oneliner')}">
            <label>Why this investor? (optional)</label>
            <textarea id="outreach-why-${id}" rows="2" placeholder="e.g. Their portfolio company X is in a similar space...">${getOutreachField('why')}</textarea>
            <label>Tone</label>
            <div class="outreach-tone-chips" id="outreach-tone-${id}">
              <span class="tone-chip active" data-tone="professional" onclick="selectTone(this)">Professional</span>
              <span class="tone-chip" data-tone="warm" onclick="selectTone(this)">Warm & Friendly</span>
              <span class="tone-chip" data-tone="bold" onclick="selectTone(this)">Bold & Direct</span>
              <span class="tone-chip" data-tone="brief" onclick="selectTone(this)">Ultra-Brief</span>
            </div>
            <div class="outreach-actions">
              <button class="btn-generate" onclick="generateOutreach('${id}')">✨ Generate Email</button>
            </div>
          </div>
          <div id="outreach-result-${id}"></div>
        </div>
      </div>

      ${isOrg&&(inv.keyPeople&&inv.keyPeople.length||inv.memberCount)?`
      <div class="modal-section">
        ${inv.memberCount?`<div style="margin-bottom:8px"><span class="member-count-badge">👥 ${inv.memberCount} members</span></div>`:''}
        ${inv.keyPeople&&inv.keyPeople.length?`<h3>Key People</h3><ul class="key-people-list">${inv.keyPeople.map(p=>'<li>'+p+'</li>').join('')}</ul>`:''}
      </div>`:''}

      <div class="modal-section"><h3>Investment Thesis</h3><p>${inv.thesis}</p></div>

      <hr class="modal-divider">

      <div class="profile-grid">
        <div class="profile-col">
          <div class="modal-section"><h3>Focus Areas</h3>
            <div class="modal-tags">
              ${inv.stages.map(s=>`<span class="tag tag-stage">${s}</span>`).join('')}
              ${inv.sectors.map(s=>`<span class="tag tag-sector">${s}</span>`).join('')}
              ${inv.geography.map(g=>`<span class="tag">${g}</span>`).join('')}
            </div>
          </div>
          <div class="modal-section"><h3>Check Size</h3><p style="font-size:1.1rem;font-weight:600;color:var(--text)">${fmt(inv.checkSize.min)} – ${fmt(inv.checkSize.max)}</p></div>
          <div class="modal-section"><h3>Portfolio Highlights</h3>
            <div class="modal-tags">${inv.portfolioHighlights.map(p=>`<span class="tag">${p}</span>`).join('')}</div>
          </div>
          <div class="modal-section"><h3>Links</h3>
            <div class="modal-links-row">
              ${inv.links.linkedin?`<a href="${inv.links.linkedin}" target="_blank" title="LinkedIn">💼</a>`:''}
              ${inv.links.twitter?`<a href="${inv.links.twitter}" target="_blank" title="Twitter">🐦</a>`:''}
              ${inv.links.website?`<a href="${inv.links.website}" target="_blank" title="Website">🌐</a>`:''}
            </div>
          </div>
        </div>
        <div class="profile-col">
          <div class="modal-section"><h3>Fund Info</h3>
            <div class="fund-info">
              <div class="fund-info-item"><div class="label">Fund Size</div><div class="value">${inv.fundSize}</div></div>
              <div class="fund-info-item"><div class="label">Status</div><div class="value">${inv.fundStatus}</div></div>
            </div>
          </div>
          <div class="modal-section"><h3>Activity Timeline</h3>
            ${buildTimeline(inv)}
          </div>
        </div>
      </div>

      ${similar.length?`
      <hr class="modal-divider">
      <div class="modal-section"><h3>Similar Investors</h3>
        <div class="similar-grid">
          ${similar.map(s=>`<div class="similar-card" onclick="closeModal();setTimeout(()=>openProfile('${s.id}'),200)">
              <div class="sim-card-top">
                <div class="sim-avatar">${s.photo?`<img src="${s.photo}" alt="${s.name}" class="sim-avatar-img" onerror="this.replaceWith(document.createTextNode('${initials(s.name)}'))">`:initials(s.name)}</div>
                <div class="sim-score-pill">${s._simScore}%</div>
              </div>
              <div class="sim-name">${s.name}</div>
              <div class="sim-firm">${s.firm||''}</div>
              <div class="sim-overlap">${s._simReasons.slice(0,2).join(' · ')}</div>
              <span class="sim-link">View Profile →</span>
            </div>`).join('')}
        </div>
        <button class="btn-secondary" style="margin-top:12px;width:100%" onclick="closeSimilarPanel();closeModal();setTimeout(()=>openSimilarPanel('${id}'),250)">See All Similar Investors →</button>
      </div>`:''}

      <hr class="modal-divider">
      <div class="modal-section"><h3>Share</h3>
        <div class="share-buttons">
          <button class="share-btn" onclick="copyProfileLink(this,'${inv.id}')">📋 Copy Link</button>
          <button class="share-btn" onclick="shareOnTwitter('${inv.name.replace(/'/g,"\\'")}','${inv.id}')">𝕏 Share on X</button>
        </div>
      </div>
      ${notesTagsModalHTML(id)}
      <div style="text-align:center;margin-top:12px">
        <p style="font-size:0.8rem;color:var(--text-dim)">Are you ${inv.name}? <a href="mailto:hello@matchcapital.ai?subject=Claim Profile: ${encodeURIComponent(inv.name)}" style="color:var(--accent)">Claim this profile</a></p>
      </div>
    </div>`;
  const overlay=document.getElementById('modalOverlay');
  overlay.classList.remove('animate-out');
  overlay.classList.add('open');
  document.body.style.overflow='hidden';
  requestAnimationFrame(()=>requestAnimationFrame(()=>{overlay.classList.add('animate-in');const closeBtn=document.querySelector('#modal .modal-close');if(closeBtn)closeBtn.focus()}));
}

function closeModal(){
  const overlay=document.getElementById('modalOverlay');
  overlay.classList.remove('animate-in');
  overlay.classList.add('animate-out');
  setTimeout(()=>{
    overlay.classList.remove('open','animate-out');
    document.body.style.overflow='';
  },300);
  if(location.hash.startsWith('#investor='))history.pushState(null,'','#search');
}
// ===== KEYBOARD NAVIGATION =====
let kbFocusIndex=-1;

function cardKeyHandler(e,id){
  if(e.key==='Enter'||e.key===' '){e.preventDefault();openProfile(id)}
  if(e.key==='c'||e.key==='C'){e.preventDefault();toggleCompare(id)}
}

function getVisibleCards(){return[...document.querySelectorAll('#resultsGrid .investor-card')]}
// When keyboard navigating beyond visible cards, force re-render to include target
function ensureCardVisible(idx){
  if(idx<0||idx>=lastFiltered.length)return;
  const cols=getGridCols();
  const rowHeight=CARD_HEIGHT_EST+CARD_GAP;
  const targetRow=Math.floor(idx/cols);
  const targetTop=document.getElementById('resultsGrid').getBoundingClientRect().top+window.scrollY+targetRow*rowHeight;
  window.scrollTo({top:targetTop-window.innerHeight/2,behavior:'smooth'});
}

function setKbFocus(idx){
  if(!lastFiltered.length)return;
  kbFocusIndex=Math.max(0,Math.min(idx,lastFiltered.length-1));
  // Ensure the card is rendered by scrolling to it
  ensureCardVisible(kbFocusIndex);
  // After scroll and re-render, find and focus the card
  requestAnimationFrame(()=>{
    const cards=getVisibleCards();
    const targetId=lastFiltered[kbFocusIndex]?.id;
    cards.forEach(c=>c.classList.remove('kb-focused'));
    const card=cards.find(c=>c.dataset.investorId===targetId);
    if(card){card.classList.add('kb-focused');card.focus({preventScroll:true})}
  });
}

document.addEventListener('keydown',e=>{
  // Escape closes modals/panels
  if(e.key==='Escape'){
    const compareOpen=document.getElementById('compareOverlay').classList.contains('open');
    const modalOpen=document.getElementById('modalOverlay').classList.contains('open');
    if(modalOpen){closeModal();return}
    if(compareOpen){closeCompare();return}
    // Escape from search clears it
    if(document.activeElement===document.getElementById('searchInput')){
      if(searchInput.value){clearSearch()}else{searchInput.blur()}
      return;
    }
  }

  // Arrow key navigation through cards (only when not in input/select/modal)
  const tag=document.activeElement?.tagName;
  const inInput=tag==='INPUT'||tag==='SELECT'||tag==='TEXTAREA';
  const modalOpen=document.getElementById('modalOverlay').classList.contains('open')||document.getElementById('compareOverlay').classList.contains('open');
  if(modalOpen)return;

  const cards=getVisibleCards();
  if(!cards.length)return;

  if(e.key==='ArrowRight'||e.key==='ArrowDown'){
    if(inInput&&e.key==='ArrowDown'&&tag!=='SELECT'){}else if(!inInput){
      e.preventDefault();
      setKbFocus(kbFocusIndex+1);
    }
  }
  if(e.key==='ArrowLeft'||e.key==='ArrowUp'){
    if(!inInput){
      e.preventDefault();
      setKbFocus(kbFocusIndex-1);
    }
  }
  // Slash to focus search
  if(e.key==='/'&&!inInput){
    e.preventDefault();
    document.getElementById('searchInput').focus();
  }
  if(e.key==='?'&&!inInput&&window.innerWidth>=768){
    e.preventDefault();
    toggleShortcutsModal();
  }
});

function toggleShortcutsModal(){
  const o=document.getElementById('shortcutsOverlay');
  o.classList.toggle('open');
}

// ===== SAVE DROPDOWN =====
function toggleSaveDropdown(e,id){
  e.stopPropagation();
  const dd=document.getElementById('saveDropdown-'+id);
  if(dd.style.display==='none'){renderSaveDropdown(dd,id);dd.style.display='block'}
  else dd.style.display='none';
}
function renderSaveDropdown(dd,investorId){
  const inLists=listsForInvestor(investorId);
  dd.innerHTML=Object.keys(namedLists).map(name=>{
    const isIn=inLists.includes(name);
    return`<div class="save-dropdown-item ${isIn?'in-list':''}" onclick="event.stopPropagation();toggleInList('${investorId}','${name.replace(/'/g,"\\'")}',this.parentElement)">${isIn?'✓ ':''} ${name}</div>`;
  }).join('')+`<div class="save-dropdown-item create" onclick="event.stopPropagation();showNewListInput(this.parentElement,'${investorId}')">+ Create new list</div>`;
}
function toggleInList(investorId,listName,dd){
  if(!namedLists[listName])namedLists[listName]=[];
  const list=namedLists[listName];
  const idx=list.indexOf(investorId);
  if(idx>=0)list.splice(idx,1);else list.push(investorId);
  saveLists();updateSavedCount();renderSaveDropdown(dd,investorId);
}
function showNewListInput(dd,investorId){
  // Remove existing input if any
  const existing=dd.querySelector('.new-list-input');if(existing)return existing.focus();
  const input=document.createElement('input');input.className='new-list-input';input.placeholder='List name...';
  dd.appendChild(input);input.focus();
  input.addEventListener('keydown',e=>{
    if(e.key==='Enter'&&input.value.trim()){
      const name=input.value.trim();
      if(!namedLists[name])namedLists[name]=[];
      namedLists[name].push(investorId);
      saveLists();updateSavedCount();renderSaveDropdown(dd,investorId);
    }
    if(e.key==='Escape'){input.remove()}
  });
}
// Close dropdowns on outside click
document.addEventListener('click',()=>{document.querySelectorAll('.save-dropdown').forEach(d=>d.style.display='none')});

function updateSavedCount(){
  const total=allSavedIds().size;
  document.getElementById('savedCount').textContent=total;
}

// ===== RENDER SAVED / LISTS =====
function renderSaved(){
  renderListTabs();
  // Clear bulk selections that are no longer in current list
  const ids=namedLists[currentListName]||[];
  bulkSelected.forEach(id=>{if(!ids.includes(id))bulkSelected.delete(id)});
  let saved=investors.filter(i=>ids.includes(i.id));
  const grid=document.getElementById('savedGrid');
  const empty=document.getElementById('savedEmpty');
  const info=document.getElementById('savedListInfo');
  // Tag filter
  renderSavedTagFilter(ids);
  if(savedTagFilter){
    const allTags=loadInvestorTags();
    saved=saved.filter(inv=>(allTags[inv.id]||[]).includes(savedTagFilter));
  }
  info.textContent=saved.length?saved.length+' investor'+(saved.length!==1?'s':'')+' in "'+currentListName+'"'+(savedTagFilter?' · filtered by "'+savedTagFilter+'"':''):'';
  if(!saved.length){grid.innerHTML='';empty.style.display='';empty.textContent=savedTagFilter?'No investors with tag "'+savedTagFilter+'" in this list.':'No investors in "'+currentListName+'" yet. Browse and save investors to get started.';return}
  empty.style.display='none';
  grid.innerHTML=saved.map((inv,i)=>savedCardHTML(inv,i)).join('');
  // Restore bulk mode visual state
  if(bulkMode){
    document.getElementById('saved-section').classList.add('bulk-mode');
    document.getElementById('bulkBar').classList.add('visible');
    updateBulkCount();
  }
}
function savedCardHTML(inv,idx){
  // Like cardHTML but with move/remove controls + notes/tags + bulk checkbox
  let html=cardHTML(inv,idx);
  // Inject bulk checkbox + move button after compare-btn
  const bulkCb=`<input type="checkbox" class="bulk-checkbox" onclick="toggleBulkCard(this,'${inv.id}',event)" ${bulkSelected.has(inv.id)?'checked':''}>`; 
  const moveBtn=`<div class="card-move-btn" onclick="event.stopPropagation();toggleCardMoveMenu(this,'${inv.id}')">⇄ Lists</div>`;
  html=html.replace('</button>\n    <div class="card-header">',`</button>\n    ${bulkCb}\n    ${moveBtn}\n    <div class="card-header">`);
  // Mark as selected if in bulk set
  if(bulkSelected.has(inv.id))html=html.replace('class="investor-card"','class="investor-card bulk-selected"');
  // Append notes/tags bar before closing div
  const ntHTML=notesTagsHTML(inv.id);
  if(ntHTML)html=html.replace(/<\/div>$/,ntHTML+'</div>');
  return html;
}
function toggleCardMoveMenu(btn,investorId){
  // Close any open menus
  document.querySelectorAll('.card-move-menu').forEach(m=>m.remove());
  const menu=document.createElement('div');
  menu.className='card-move-menu';
  const lists=Object.keys(namedLists);
  menu.innerHTML=lists.map(name=>{
    const isIn=(namedLists[name]||[]).includes(investorId);
    return`<div class="card-move-menu-item ${isIn?'in-list':''}" onclick="event.stopPropagation();toggleInListAndRefresh('${investorId}','${name.replace(/'/g,"\\'")}')">
      ${isIn?'✓':'○'} ${name}</div>`;
  }).join('')+`<div class="card-move-menu-item remove" onclick="event.stopPropagation();removeFromCurrentList('${investorId}')">✕ Remove from "${currentListName}"</div>`;
  btn.style.position='relative';
  btn.appendChild(menu);
  const close=e=>{if(!btn.contains(e.target)){menu.remove();document.removeEventListener('click',close)}};
  setTimeout(()=>document.addEventListener('click',close),0);
}
function toggleInListAndRefresh(investorId,listName){
  if(!namedLists[listName])namedLists[listName]=[];
  const list=namedLists[listName];
  const idx=list.indexOf(investorId);
  if(idx>=0)list.splice(idx,1);else list.push(investorId);
  saveLists();updateSavedCount();renderSaved();
}
function removeFromCurrentList(investorId){
  const list=namedLists[currentListName]||[];
  const idx=list.indexOf(investorId);
  if(idx>=0){list.splice(idx,1);saveLists();updateSavedCount();renderSaved()}
}
function renderListTabs(){
  const tabs=document.getElementById('listTabs');
  tabs.innerHTML=Object.entries(namedLists).map(([name,ids])=>{
    const esc=name.replace(/'/g,"\\'");
    return`<button class="list-tab ${name===currentListName?'active':''}" onclick="currentListName='${esc}';renderSaved()" oncontextmenu="event.preventDefault();showListTabMenu(event,'${esc}')">${name} <span class="count">${ids.length}</span></button>`;
  }).join('')+`<button class="list-tab" onclick="promptNewList()" style="border-style:dashed">+ New List</button>`;
}
function showListTabMenu(e,listName){
  document.querySelectorAll('.list-tab-menu').forEach(m=>m.remove());
  const menu=document.createElement('div');
  menu.className='list-tab-menu';
  menu.style.left=e.pageX+'px';menu.style.top=e.pageY+'px';menu.style.position='fixed';
  let items=`<div class="list-tab-menu-item" onclick="renameList('${listName.replace(/'/g,"\\'")}')">✏️ Rename</div>`;
  items+=`<div class="list-tab-menu-item" onclick="duplicateList('${listName.replace(/'/g,"\\'")}')">📋 Duplicate</div>`;
  if(listName!=='Saved')items+=`<div class="list-tab-menu-item danger" onclick="deleteNamedList('${listName.replace(/'/g,"\\'")}')">🗑 Delete</div>`;
  menu.innerHTML=items;
  document.body.appendChild(menu);
  const close=()=>{menu.remove();document.removeEventListener('click',close)};
  setTimeout(()=>document.addEventListener('click',close),0);
}
function renameList(oldName){
  document.querySelectorAll('.list-tab-menu').forEach(m=>m.remove());
  const newName=prompt('Rename "'+oldName+'" to:',oldName);
  if(!newName||!newName.trim()||newName.trim()===oldName)return;
  const trimmed=newName.trim();
  if(namedLists[trimmed]){alert('A list named "'+trimmed+'" already exists.');return}
  // Preserve order
  const entries=Object.entries(namedLists);
  const newLists={};
  entries.forEach(([k,v])=>{newLists[k===oldName?trimmed:k]=v});
  namedLists=newLists;
  if(currentListName===oldName)currentListName=trimmed;
  saveLists();renderSaved();
}
function duplicateList(name){
  document.querySelectorAll('.list-tab-menu').forEach(m=>m.remove());
  let newName=name+' (copy)';let i=2;
  while(namedLists[newName]){newName=name+' (copy '+i+')';i++}
  namedLists[newName]=[...(namedLists[name]||[])];
  saveLists();currentListName=newName;renderSaved();
}
function deleteNamedList(name){
  document.querySelectorAll('.list-tab-menu').forEach(m=>m.remove());
  if(!confirm('Delete list "'+name+'"?'))return;
  delete namedLists[name];saveLists();
  if(currentListName===name)currentListName=Object.keys(namedLists)[0]||'Saved';
  updateSavedCount();renderSaved();
}
function promptNewList(){
  const name=prompt('New list name:');
  if(name&&name.trim()&&!namedLists[name.trim()]){
    namedLists[name.trim()]=[];saveLists();currentListName=name.trim();renderSaved();updateSavedCount();
  }
}

function exportCSV(){
  const ids=namedLists[currentListName]||[];
  const saved=investors.filter(i=>ids.includes(i.id));if(!saved.length)return;
  const rows=[['Name','Title','Firm','Type','Stages','Sectors','Check Min','Check Max','Location','Active','Website','Notes','Tags']];
  saved.forEach(i=>{const note=getInvestorNote(i.id);const tags=getInvestorTags(i.id).map(t=>t.name).join('; ');rows.push([i.name,i.title,i.firm,i.type,i.stages.join('; '),i.sectors.join('; '),i.checkSize.min,i.checkSize.max,i.location,i.activelyDeploying,i.links.website||'',note,tags])});
  const csv=rows.map(r=>r.map(c=>'"'+(c+'').replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='match-capital-'+currentListName.toLowerCase().replace(/\s+/g,'-')+'.csv';a.click();
}

function clearCurrentList(){
  if(!confirm('Clear all investors from "'+currentListName+'"?'))return;
  namedLists[currentListName]=[];saveLists();updateSavedCount();renderSaved();
}

// ===== BULK ACTIONS =====
let bulkMode=false;
let bulkSelected=new Set();

function toggleBulkMode(on){
  bulkMode=on;
  bulkSelected.clear();
  const section=document.getElementById('saved-section');
  const bar=document.getElementById('bulkBar');
  if(on){section.classList.add('bulk-mode');bar.classList.add('visible')}
  else{section.classList.remove('bulk-mode');bar.classList.remove('visible')}
  document.getElementById('bulkSelectAll').checked=false;
  updateBulkCount();
  // Update card visual states
  document.querySelectorAll('#savedGrid .investor-card').forEach(c=>{
    c.classList.remove('bulk-selected');
    const cb=c.querySelector('.bulk-checkbox');
    if(cb)cb.checked=false;
  });
}

function toggleBulkCard(checkbox,investorId,ev){
  ev.stopPropagation();
  if(checkbox.checked)bulkSelected.add(investorId);
  else bulkSelected.delete(investorId);
  const card=checkbox.closest('.investor-card');
  if(card)card.classList.toggle('bulk-selected',checkbox.checked);
  updateBulkCount();
}

function bulkSelectAll(checked){
  document.querySelectorAll('#savedGrid .investor-card').forEach(c=>{
    const id=c.getAttribute('data-investor-id');
    const cb=c.querySelector('.bulk-checkbox');
    if(id&&cb){
      cb.checked=checked;
      if(checked)bulkSelected.add(id);else bulkSelected.delete(id);
      c.classList.toggle('bulk-selected',checked);
    }
  });
  updateBulkCount();
}

function updateBulkCount(){
  const n=bulkSelected.size;
  document.getElementById('bulkCount').textContent=n+' selected';
  document.getElementById('bulkSelectAll').checked=n>0&&n===document.querySelectorAll('#savedGrid .investor-card').length;
}

function bulkExport(){
  if(!bulkSelected.size){alert('Select investors first');return}
  const saved=investors.filter(i=>bulkSelected.has(i.id));
  const rows=[['Name','Title','Firm','Type','Stages','Sectors','Check Min','Check Max','Location','Active','Website','Notes','Tags']];
  saved.forEach(i=>{const note=getInvestorNote(i.id);const tags=getInvestorTags(i.id).map(t=>t.name).join('; ');rows.push([i.name,i.title,i.firm,i.type,i.stages.join('; '),i.sectors.join('; '),i.checkSize.min,i.checkSize.max,i.location,i.activelyDeploying,i.links.website||'',note,tags])});
  const csv=rows.map(r=>r.map(c=>'"'+(c+'').replace(/"/g,'""')+'"').join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='match-capital-selected-'+bulkSelected.size+'.csv';a.click();
}

function bulkRemove(){
  if(!bulkSelected.size)return;
  if(!confirm('Remove '+bulkSelected.size+' investor'+(bulkSelected.size>1?'s':'')+' from "'+currentListName+'"?'))return;
  const list=namedLists[currentListName]||[];
  namedLists[currentListName]=list.filter(id=>!bulkSelected.has(id));
  bulkSelected.clear();
  saveLists();updateSavedCount();renderSaved();
  // Keep bulk mode on but reset
  document.getElementById('bulkToggle').checked=true;
  toggleBulkMode(true);
}

function toggleBulkMoveMenu(btn){
  // Remove existing menus
  document.querySelectorAll('.bulk-move-menu').forEach(m=>m.remove());
  if(!bulkSelected.size){alert('Select investors first');return}
  const menu=document.createElement('div');
  menu.className='bulk-move-menu';
  const lists=Object.keys(namedLists).filter(n=>n!==currentListName);
  if(!lists.length){menu.innerHTML='<div class="bulk-move-menu-item" style="color:var(--text-dim)">No other lists</div>'}
  else{menu.innerHTML=lists.map(name=>`<div class="bulk-move-menu-item" onclick="bulkMoveTo('${name.replace(/'/g,"\\'")}',false)">Copy to "${name}"</div><div class="bulk-move-menu-item" onclick="bulkMoveTo('${name.replace(/'/g,"\\'")}',true)">Move to "${name}"</div>`).join('<div style="border-top:1px solid var(--border);margin:2px 0"></div>')}
  btn.parentElement.appendChild(menu);
  const close=e=>{if(!btn.parentElement.contains(e.target)){menu.remove();document.removeEventListener('click',close)}};
  setTimeout(()=>document.addEventListener('click',close),0);
}

function bulkMoveTo(targetList,removeFromCurrent){
  const target=namedLists[targetList]||[];
  bulkSelected.forEach(id=>{if(!target.includes(id))target.push(id)});
  namedLists[targetList]=target;
  if(removeFromCurrent){
    namedLists[currentListName]=(namedLists[currentListName]||[]).filter(id=>!bulkSelected.has(id));
  }
  const action=removeFromCurrent?'Moved':'Copied';
  const n=bulkSelected.size;
  bulkSelected.clear();
  document.querySelectorAll('.bulk-move-menu').forEach(m=>m.remove());
  saveLists();updateSavedCount();renderSaved();
  document.getElementById('bulkToggle').checked=true;
  toggleBulkMode(true);
}

// ===== COMPARE =====
function toggleCompare(id){
  const idx=compareIds.indexOf(id);
  if(idx>=0)compareIds.splice(idx,1);
  else if(compareIds.length<3)compareIds.push(id);
  else{alert('Maximum 3 investors for comparison');return}
  updateCompareBar();renderResults();
  // Also re-render saved if visible
  if(document.getElementById('saved-section').style.display!=='none')renderSaved();
}
function updateCompareBar(){
  const bar=document.getElementById('compareBar');
  const avatarsEl=document.getElementById('compareAvatars');
  if(!compareIds.length){bar.classList.remove('show');return}
  bar.classList.add('show');
  avatarsEl.innerHTML=compareIds.map(id=>{
    const inv=investors.find(i=>i.id===id);
    return`<div class="mini-chip"><div class="mini-avatar">${inv.photo?`<img src="${inv.photo}" alt="${inv.name}" class="mini-avatar-img" onerror="this.replaceWith(document.createTextNode('${initials(inv.name)}'))">`:initials(inv.name)}</div><span class="mini-name">${inv.name.split(' ')[0]}</span><span class="mini-remove" onclick="event.stopPropagation();toggleCompare('${id}')">✕</span></div>`;
  }).join('');
  document.getElementById('compareCount').textContent=compareIds.length+'/3';
}
function clearCompare(){compareIds=[];updateCompareBar();renderResults()}

function allMatch(invs,getter){
  const vals=invs.map(getter);
  const norm=vals.map(v=>Array.isArray(v)?v.slice().sort().join('|'):String(v));
  return norm.every(n=>n===norm[0]);
}
function arrOverlap(invs,getter){
  const sets=invs.map(i=>new Set(getter(i)));
  return[...sets[0]].filter(v=>sets.every(s=>s.has(v)));
}

function openCompare(){
  if(compareIds.length<2){alert('Select at least 2 investors to compare');return}
  const invs=compareIds.map(id=>investors.find(i=>i.id===id));

  function matchClass(invs,getter){return allMatch(invs,getter)?'match':''}
  function tagWithMatch(items,allItems,cls){
    const common=new Set(allItems);
    return items.map(s=>{
      const isMatch=common.has(s);
      return`<span class="tag ${cls}" style="margin:2px">${isMatch?'<span class="match-icon">●</span>':''}${s}</span>`;
    }).join('');
  }

  const stageOverlap=arrOverlap(invs,i=>i.stages);
  const sectorOverlap=arrOverlap(invs,i=>i.sectors);
  const geoOverlap=arrOverlap(invs,i=>i.geography);

  const rows=[
    {label:'Thesis',render:inv=>`<td>${inv.thesis}</td>`},
    {label:'Stages',render:inv=>{const cls=stageOverlap.length?'':'';return`<td>${inv.stages.map(s=>`<span class="tag tag-stage" style="margin:2px">${stageOverlap.includes(s)?'<span class="match-icon">●</span>':''}${s}</span>`).join('')}</td>`}},
    {label:'Sectors',render:inv=>`<td>${inv.sectors.map(s=>`<span class="tag tag-sector" style="margin:2px">${sectorOverlap.includes(s)?'<span class="match-icon">●</span>':''}${s}</span>`).join('')}</td>`},
    {label:'Check Size',render:inv=>`<td class="${matchClass(invs,i=>fmt(i.checkSize.min)+'-'+fmt(i.checkSize.max))}">${fmt(inv.checkSize.min)} – ${fmt(inv.checkSize.max)}</td>`},
    {label:'Fund Size',render:inv=>`<td class="${matchClass(invs,i=>i.fundSize)}">${inv.fundSize}</td>`},
    {label:'Location',render:inv=>`<td class="${matchClass(invs,i=>i.location)}">${inv.location}</td>`},
    {label:'Geography',render:inv=>`<td>${inv.geography.map(g=>`<span class="tag" style="margin:2px">${geoOverlap.includes(g)?'<span class="match-icon">●</span>':''}${g}</span>`).join('')}</td>`},
    {label:'Deploying',render:inv=>`<td class="${matchClass(invs,i=>i.activelyDeploying)}">${inv.activelyDeploying?'<span style="color:var(--green)">✓ Active</span>':'<span style="color:var(--text-dim)">Inactive</span>'}</td>`},
    {label:'Recent Deals',render:inv=>`<td>${inv.recentInvestments.slice(0,4).map(i=>`<div style="margin-bottom:4px">${i.company} <span style="color:var(--text-dim);font-size:0.78rem">${i.round} · ${i.year}</span></div>`).join('')}</td>`},
    {label:'Links',render:inv=>`<td>${[inv.links.linkedin?'<a href="'+inv.links.linkedin+'" target="_blank">LinkedIn</a>':null,inv.links.twitter?'<a href="'+inv.links.twitter+'" target="_blank">Twitter</a>':null,inv.links.website?'<a href="'+inv.links.website+'" target="_blank">Website</a>':null].filter(Boolean).join(' · ')||'—'}</td>`}
  ];

  // Similarity summary
  const similarities=[];
  if(stageOverlap.length)similarities.push(stageOverlap.join(', '));
  if(sectorOverlap.length)similarities.push(sectorOverlap.join(', '));
  if(allMatch(invs,i=>i.location))similarities.push(invs[0].location);
  const simHTML=similarities.length?`<div style="margin-bottom:20px;padding:12px 16px;background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);border-radius:var(--radius-sm);font-size:0.82rem;color:var(--text-muted)"><span style="color:var(--green);font-weight:600">● Shared:</span> ${similarities.join(' · ')}</div>`:'';

  let html=`<button class="modal-close" onclick="closeCompare()" style="position:absolute;top:16px;right:16px;font-size:1.5rem;color:var(--text-dim);z-index:1;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%">×</button>`;
  html+=`<h2 style="margin-bottom:8px;font-size:1.3rem;font-weight:700">Investor Comparison</h2>`;
  html+=`<p style="font-size:0.82rem;color:var(--text-dim);margin-bottom:16px">Comparing ${invs.length} investors · <span style="color:var(--green)">●</span> = shared attributes</p>`;
  html+=simHTML;
  html+=`<table class="compare-table"><thead><tr><th></th>`;
  invs.forEach(inv=>{
    const io=inv.entity==='organization';
    html+=`<td class="header-cell"><div class="avatar${io?' avatar-org':''}" style="margin:0 auto;width:48px;height:48px;border-radius:${io?'8px':'50%'};background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;overflow:hidden">${inv.photo?`<img src="${inv.photo}" alt="${inv.name}" style="width:100%;height:100%;object-fit:cover;border-radius:inherit" onerror="this.replaceWith(document.createTextNode('${io?'🏢':initials(inv.name)}'))">`:io?'🏢':initials(inv.name)}</div><div class="name">${inv.name}</div><div class="firm">${io?(inv.title||''):(inv.firm||'')}</div><span class="type-badge ${typeClass(inv.type)}" style="margin-top:6px">${inv.type}</span><br><button class="compare-remove" onclick="removeFromCompare('${inv.id}')">✕ Remove</button></td>`;
  });
  html+=`</tr></thead><tbody>`;
  rows.forEach(row=>{
    html+=`<tr><th>${row.label}</th>`;
    invs.forEach(inv=>{html+=row.render(inv)});
    html+=`</tr>`;
  });
  html+=`</tbody></table>`;
  html+=`<div class="compare-export"><button onclick="copyCompareText(this)">📋 Copy as Text</button><button onclick="exportCompareImage()">📸 Export as Image</button></div>`;
  document.getElementById('compareModal').innerHTML=html;
  const compareOvl=document.getElementById('compareOverlay');
  compareOvl.classList.add('open');
  document.body.style.overflow='hidden';
  requestAnimationFrame(()=>requestAnimationFrame(()=>compareOvl.classList.add('animate-in')));
}

function copyCompareText(btn){
  const invs=compareIds.map(id=>investors.find(i=>i.id===id));
  const fields=['Name','Firm','Type','Stages','Sectors','Check Size','Fund Size','Location','Geography','Active'];
  let text='INVESTOR COMPARISON\n'+'='.repeat(40)+'\n\n';
  invs.forEach((inv,idx)=>{
    text+=`[${idx+1}] ${inv.name}\n`;
    text+=`Firm: ${inv.firm||'—'}\nType: ${inv.type}\n`;
    text+=`Stages: ${inv.stages.join(', ')}\nSectors: ${inv.sectors.join(', ')}\n`;
    text+=`Check Size: ${fmt(inv.checkSize.min)} – ${fmt(inv.checkSize.max)}\n`;
    text+=`Fund Size: ${inv.fundSize}\nLocation: ${inv.location}\n`;
    text+=`Geography: ${inv.geography.join(', ')}\n`;
    text+=`Active: ${inv.activelyDeploying?'Yes':'No'}\n`;
    text+=`Thesis: ${inv.thesis}\n\n`;
  });
  navigator.clipboard.writeText(text).then(()=>{
    btn.classList.add('copied');btn.innerHTML='✓ Copied!';
    setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML='📋 Copy as Text'},2000);
  });
}

function exportCompareImage(){
  const modal=document.getElementById('compareModal');
  // Use canvas to render - simple screenshot via html2canvas-like approach
  // Since we can't load external libs, we'll create a styled SVG foreignObject
  const table=modal.querySelector('.compare-table');
  if(!table)return;
  // Fallback: copy as text and notify
  const invs=compareIds.map(id=>investors.find(i=>i.id===id));
  // Build a self-contained HTML doc for rendering
  const styles=document.querySelector('style').textContent;
  const tableHTML=table.outerHTML;
  const blob=new Blob([`<!DOCTYPE html><html><head><meta charset="utf-8"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"><style>${styles}body{background:#09090b;font-family:'Inter',sans-serif;padding:32px;color:#e4e4e7}.compare-table{max-width:100%}</style></head><body><h2 style="color:#e4e4e7;margin-bottom:16px;font-size:1.3rem">Match Capital — Investor Comparison</h2>${tableHTML}<p style="color:#52525b;font-size:0.75rem;margin-top:16px">Generated from hq.ralcorporation.com</p></body></html>`],{type:'text/html'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='match-capital-comparison.html';
  a.click();
  URL.revokeObjectURL(a.href);
}
function removeFromCompare(id){
  compareIds=compareIds.filter(x=>x!==id);
  if(compareIds.length<2){closeCompare();updateCompareBar();renderResults();return}
  openCompare();updateCompareBar();renderResults();
}
function closeCompare(){const o=document.getElementById('compareOverlay');o.classList.remove('animate-in','open');document.body.style.overflow=''}

// ===== ANALYTICS =====
function switchAnalyticsTab(tab,btn){
  document.querySelectorAll('.analytics-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.analytics-tab-content').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(tab==='summary'?'tabSummary':'tabVisual').classList.add('active');
  if(tab==='visual')renderVisualCharts();
}

function toggleAnalytics(){
  const panel=document.getElementById('analyticsPanel');
  const chevron=document.getElementById('analyticsChevron');
  const toggle=document.querySelector('.analytics-toggle');
  const isOpen=panel.classList.toggle('open');
  chevron.classList.toggle('open',isOpen);
  toggle.setAttribute('aria-expanded',isOpen);
  if(isOpen&&!panel.dataset.rendered){renderAnalytics();panel.dataset.rendered='1'}
}

function getAnalyticsData(data){
  const total=data.length;
  const typeCounts={};data.forEach(i=>{typeCounts[i.type]=(typeCounts[i.type]||0)+1});
  const stageCounts={};data.forEach(i=>i.stages.forEach(s=>{stageCounts[s]=(stageCounts[s]||0)+1}));
  const geoCounts={};data.forEach(i=>i.geography.forEach(g=>{geoCounts[g]=(geoCounts[g]||0)+1}));
  const sectorCounts={};data.forEach(i=>i.sectors.forEach(s=>{sectorCounts[s]=(sectorCounts[s]||0)+1}));
  const avgMin=total?Math.round(data.reduce((a,i)=>a+i.checkSize.min,0)/total):0;
  const avgMax=total?Math.round(data.reduce((a,i)=>a+i.checkSize.max,0)/total):0;
  const activeCount=data.filter(i=>i.activelyDeploying).length;
  return{total,typeCounts,stageCounts,geoCounts,sectorCounts,avgMin,avgMax,activeCount};
}

function renderAnalytics(){
  const d=getAnalyticsData(investors);

  document.getElementById('statsCounters').innerHTML=`
    <div class="stat-card"><div class="stat-value">${d.total}</div><div class="stat-label">Total Investors</div></div>
    <div class="stat-card"><div class="stat-value">${d.activeCount}</div><div class="stat-label">Actively Deploying</div></div>
    <div class="stat-card"><div class="stat-value">${fmt(d.avgMin)}</div><div class="stat-label">Avg Min Check</div></div>
    <div class="stat-card"><div class="stat-value">${fmt(d.avgMax)}</div><div class="stat-label">Avg Max Check</div></div>
  `;

  const typeOrder=['VC','Angel','Family Office','Corp VC','Angel Group'];
  const typeColors={'VC':'fill-vc','Angel':'fill-angel','Family Office':'fill-family-office','Corp VC':'fill-corp-vc','Angel Group':'fill-angel-group'};
  const stageOrder=['Pre-Seed','Seed','Series A','Series B','Growth'];

  function barsHTML(data,order,fillClass,maxVal){
    return order.filter(k=>data[k]).map(k=>{
      const pct=Math.round((data[k]/maxVal)*100);
      const cls=typeof fillClass==='object'?fillClass[k]:fillClass;
      return`<div class="bar-row"><span class="bar-label">${k}</span><div class="bar-track"><div class="bar-fill ${cls}" style="width:${pct}%"></div></div><span class="bar-count">${data[k]}</span></div>`;
    }).join('');
  }

  const maxType=Math.max(...Object.values(d.typeCounts),1);
  const maxStage=Math.max(...Object.values(d.stageCounts),1);
  const geoOrder=Object.keys(d.geoCounts).sort((a,b)=>d.geoCounts[b]-d.geoCounts[a]);
  const maxGeo=Math.max(...Object.values(d.geoCounts),1);
  const locCounts={};investors.forEach(i=>{const loc=(i.location||'').split(',')[0].trim();if(loc)locCounts[loc]=(locCounts[loc]||0)+1});
  const topLocs=Object.entries(locCounts).sort((a,b)=>b[1]-a[1]).slice(0,6);

  document.getElementById('analyticsGrid').innerHTML=`
    <div class="analytics-card"><h4>By Type</h4>${barsHTML(d.typeCounts,typeOrder,typeColors,maxType)}</div>
    <div class="analytics-card"><h4>By Stage</h4>${barsHTML(d.stageCounts,stageOrder,'fill-stage',maxStage)}</div>
    <div class="analytics-card"><h4>By Geography</h4>${barsHTML(d.geoCounts,geoOrder,'fill-geo',maxGeo)}</div>
    <div class="analytics-card"><h4>Top Locations</h4>${topLocs.map(([loc,n])=>`<div class="bar-row"><span class="bar-label" style="min-width:100px">${loc}</span><div class="bar-track"><div class="bar-fill fill-stage" style="width:${Math.round(n/topLocs[0][1]*100)}%"></div></div><span class="bar-count">${n}</span></div>`).join('')}</div>
  `;
}

// ===== VISUAL CHARTS =====
const GEO_LABELS={us:'United States',global:'Global',eu:'Europe/EU',mid_atlantic:'Mid-Atlantic',dmv:'DC/DMV',asia:'Asia',boston:'Boston',europe:'Europe',sf_bay:'SF Bay Area',nyc:'NYC'};
const SECTOR_DISPLAY={SaaS:'SaaS',Fintech:'Fintech',HealthTech:'Health',['AI/ML']:'AI/ML',Consumer:'Consumer',Enterprise:'Enterprise',Climate:'Climate',Crypto:'Crypto',Biotech:'Biotech',DeepTech:'Deep',EdTech:'EdTech',Hardware:'HW',Marketplace:'Mktpl',GovTech:'Gov',Cybersecurity:'Cyber',Cleantech:'Clean',PropTech:'Prop',Defense:'Defense',Logistics:'Logis',Energy:'Energy'};

function renderVisualCharts(){
  const data=lastFiltered&&lastFiltered.length?lastFiltered:investors;
  const d=getAnalyticsData(data);
  const isFiltered=lastFiltered&&lastFiltered.length&&lastFiltered.length!==investors.length;

  // Stats counters for visual tab
  document.getElementById('vizStatsCounters').innerHTML=`
    <div class="stat-card"><div class="stat-value">${d.total}</div><div class="stat-label">${isFiltered?'Filtered':'Total'} Investors</div></div>
    <div class="stat-card"><div class="stat-value">${Object.keys(d.sectorCounts).length}</div><div class="stat-label">Sectors</div></div>
    <div class="stat-card"><div class="stat-value">${Object.keys(d.geoCounts).length}</div><div class="stat-label">Regions</div></div>
    <div class="stat-card"><div class="stat-value">${d.activeCount}</div><div class="stat-label">Active</div></div>
  `;

  renderSectorHeatmap(d.sectorCounts);
  renderGeoChart(d.geoCounts);
  renderStageChart(d.stageCounts);
}

function renderSectorHeatmap(sectorCounts){
  const container=document.getElementById('heatmapContainer');
  // Sort sectors by count, take top ones
  const sorted=Object.entries(sectorCounts).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length){container.innerHTML='<div style="color:var(--text-dim);font-size:0.8rem">No sector data</div>';return}
  const maxCount=sorted[0][1];
  // Grid: aim for ~5 columns
  const cols=Math.min(sorted.length,window.innerWidth<768?3:5);
  let html=`<div class="heatmap-grid" style="grid-template-columns:repeat(${cols},1fr)">`;
  sorted.forEach(([sector,count])=>{
    const intensity=maxCount>0?count/maxCount:0;
    const isActive=activeFilters.sector.includes(sector);
    const isDark=document.documentElement.getAttribute('data-theme')!=='light';
    let bg;
    if(isDark){
      const r=Math.round(99+intensity*0);const g=Math.round(102-intensity*40);const b=Math.round(241);
      bg=`rgba(${r},${g},${b},${0.06+intensity*0.84})`;
    }else{
      bg=`rgba(79,70,229,${0.04+intensity*0.76})`;
    }
    const label=SECTOR_DISPLAY[sector]||sector.slice(0,6);
    html+=`<div class="heatmap-cell${isActive?' active-filter':''}" style="background:${bg}" title="${sector}: ${count} investors" onclick="vizFilterSector('${sector.replace(/'/g,"\\'")}')">${label}<br>${count}</div>`;
  });
  html+=`</div>`;
  html+=`<div class="heatmap-legend"><span>Few</span><div class="heatmap-legend-bar"></div><span>Many</span></div>`;
  container.innerHTML=html;
}

function renderGeoChart(geoCounts){
  const container=document.getElementById('geoChartContainer');
  const sorted=Object.entries(geoCounts).sort((a,b)=>b[1]-a[1]);
  if(!sorted.length){container.innerHTML='<div style="color:var(--text-dim);font-size:0.8rem">No geo data</div>';return}
  const maxVal=sorted[0][1];
  let html='';
  sorted.forEach(([geo,count])=>{
    const pct=Math.round((count/maxVal)*100);
    const isActive=activeFilters.geo.includes(geo);
    const label=GEO_LABELS[geo]||geo;
    html+=`<div class="hbar-row${isActive?' active-filter':''}" onclick="vizFilterGeo('${geo}')">
      <span class="hbar-label">${label}</span>
      <div class="hbar-track"><div class="hbar-fill fill-geo" style="width:${pct}%">${count}</div></div>
    </div>`;
  });
  container.innerHTML=html;
}

function renderStageChart(stageCounts){
  const container=document.getElementById('stageChartContainer');
  const stageOrder=['Pre-Seed','Seed','Series A','Series B','Growth'];
  const stages=stageOrder.filter(s=>stageCounts[s]);
  if(!stages.length){container.innerHTML='<div style="color:var(--text-dim);font-size:0.8rem">No stage data</div>';return}
  const maxVal=Math.max(...stages.map(s=>stageCounts[s]),1);
  let html='';
  stages.forEach(stage=>{
    const count=stageCounts[stage];
    const pct=Math.round((count/maxVal)*100);
    const isActive=activeFilters.stage.includes(stage);
    html+=`<div class="hbar-row${isActive?' active-filter':''}" onclick="vizFilterStage('${stage}')">
      <span class="hbar-label">${stage}</span>
      <div class="hbar-track"><div class="hbar-fill fill-stage" style="width:${pct}%">${count}</div></div>
    </div>`;
  });
  container.innerHTML=html;
}

function vizFilterSector(sector){
  const chip=document.querySelector(`.chip[data-filter="sector"][data-value="${sector}"]`);
  if(chip){chip.click();return}
  // If no chip exists, toggle manually
  const idx=activeFilters.sector.indexOf(sector);
  if(idx>=0)activeFilters.sector.splice(idx,1);else activeFilters.sector.push(sector);
  renderResults();
}
function vizFilterGeo(geo){
  const chip=document.querySelector(`.chip[data-filter="geo"][data-value="${geo}"]`);
  if(chip){chip.click();return}
  const idx=activeFilters.geo.indexOf(geo);
  if(idx>=0)activeFilters.geo.splice(idx,1);else activeFilters.geo.push(geo);
  renderResults();
}
function vizFilterStage(stage){
  const chip=document.querySelector(`.chip[data-filter="stage"][data-value="${stage}"]`);
  if(chip){chip.click();return}
  const idx=activeFilters.stage.indexOf(stage);
  if(idx>=0)activeFilters.stage.splice(idx,1);else activeFilters.stage.push(stage);
  renderResults();
}

// ===== ONBOARDING =====
function initOnboarding(){
  const banner=document.getElementById('onboardingBanner');
  if(localStorage.getItem('mc_onboarding_dismissed')==='1'){banner.style.display='none';return}
  if(localStorage.getItem('mc_onboarding_collapsed')==='1')banner.classList.add('collapsed');
}
function toggleOnboarding(){document.getElementById('onboardingBanner').classList.toggle('collapsed');localStorage.setItem('mc_onboarding_collapsed',document.getElementById('onboardingBanner').classList.contains('collapsed')?'1':'0')}
function dismissOnboarding(){document.getElementById('onboardingBanner').style.display='none';localStorage.setItem('mc_onboarding_dismissed','1')}

// ===== SHARE =====
// --- Outreach Email Generator ---
function getOutreachField(field){
  try{const d=JSON.parse(localStorage.getItem('mc_outreach')||'{}');return d[field]||''}catch{return''}
}
function saveOutreachFields(id){
  const data={
    name:(document.getElementById('outreach-name-'+id)||{}).value||'',
    company:(document.getElementById('outreach-company-'+id)||{}).value||'',
    oneliner:(document.getElementById('outreach-oneliner-'+id)||{}).value||'',
    why:(document.getElementById('outreach-why-'+id)||{}).value||''
  };
  localStorage.setItem('mc_outreach',JSON.stringify(data));
}
function toggleOutreach(el){
  const panel=el.nextElementSibling;
  el.classList.toggle('open');
  panel.classList.toggle('open');
}
function selectTone(chip){
  chip.parentElement.querySelectorAll('.tone-chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
}
function generateOutreach(id){
  const inv=investors.find(i=>i.id===id);if(!inv)return;
  saveOutreachFields(id);
  const senderName=(document.getElementById('outreach-name-'+id)||{}).value||'[Your Name]';
  const company=(document.getElementById('outreach-company-'+id)||{}).value||'[Your Company]';
  const oneliner=(document.getElementById('outreach-oneliner-'+id)||{}).value||'[what you\'re building]';
  const why=(document.getElementById('outreach-why-'+id)||{}).value||'';
  const toneChip=document.querySelector('#outreach-tone-'+id+' .tone-chip.active');
  const tone=toneChip?toneChip.dataset.tone:'professional';

  const firstName=inv.name.split(' ')[0];
  const sectors=inv.sectors.slice(0,3).join(', ');
  const stages=inv.stages.join('/');
  const checkRange=fmt(inv.checkSize.min)+'–'+fmt(inv.checkSize.max);
  const portfolio=inv.portfolioHighlights.slice(0,2).join(' and ');

  let subject,body;
  const whyLine=why?'\n\n'+why:'';

  if(tone==='professional'){
    subject=company+' — '+stages+' Round ('+sectors+')';
    body=`Hi ${firstName},

I'm ${senderName}, founder of ${company} — ${oneliner}.

I came across your investment profile and noticed strong alignment: you invest in ${sectors} at the ${stages} stage, and your work with ${portfolio} caught my attention.${whyLine}

We're raising a round in the ${checkRange} range and I'd love to share a brief overview. Would you be open to a 15-minute call this week?

Best regards,
${senderName}`;
  } else if(tone==='warm'){
    subject='Quick hello from '+senderName+' ('+company+')';
    body=`Hey ${firstName}! 👋

I'm ${senderName} — building ${company} (${oneliner}).

I've been following your investments in ${sectors}, especially ${portfolio}, and it really resonated with what we're working on.${whyLine}

We're currently raising (${checkRange} range) and I think there could be a great fit. Would love to chat if you have 15 minutes sometime!

Cheers,
${senderName}`;
  } else if(tone==='bold'){
    subject=company+': '+oneliner;
    body=`${firstName} —

${company}. ${oneliner}. ${stages} stage, raising ${checkRange}.

You back ${sectors} companies like ${portfolio}. We're building in the same space with serious traction.${whyLine}

15 minutes. Happy to send a deck first if you prefer.

${senderName}`;
  } else { // brief
    subject=stages+' opportunity — '+company;
    body=`Hi ${firstName},

${senderName} here, building ${company} (${oneliner}). Raising ${checkRange} at ${stages}. Your ${sectors} focus is a strong fit.${whyLine}

Open to a quick call?

${senderName}`;
  }

  const resultDiv=document.getElementById('outreach-result-'+id);
  resultDiv.innerHTML=`
    <div class="outreach-output">
      <button class="copy-email-btn" onclick="copyOutreach(this,'${id}')">📋 Copy</button>
      <div style="margin-bottom:10px"><strong style="color:var(--text)">Subject:</strong> ${escapeHTML(subject)}</div>
      <div>${escapeHTML(body)}</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <a href="mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}" class="btn-generate" style="text-decoration:none;font-size:0.8rem;padding:8px 16px;display:inline-flex;align-items:center;gap:6px">📧 Open in Mail App</a>
      ${inv.links.linkedin?`<a href="${inv.links.linkedin}" target="_blank" class="btn-generate" style="text-decoration:none;font-size:0.8rem;padding:8px 16px;display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#0077b5,#00a0dc)">💼 LinkedIn Profile</a>`:''}
      ${inv.links.twitter?`<a href="${inv.links.twitter}" target="_blank" class="btn-generate" style="text-decoration:none;font-size:0.8rem;padding:8px 16px;display:inline-flex;align-items:center;gap:6px;background:linear-gradient(135deg,#1d9bf0,#1a8cd8)">𝕏 Twitter/X</a>`:''}
    </div>`;

  // Track outreach generation
  const history=JSON.parse(localStorage.getItem('mc_outreach_history')||'[]');
  history.unshift({investorId:id,investorName:inv.name,tone,date:new Date().toISOString()});
  if(history.length>50)history.length=50;
  localStorage.setItem('mc_outreach_history',JSON.stringify(history));
}
function copyOutreach(btn,id){
  const output=btn.parentElement;
  const text=output.innerText.replace('📋 Copy','').trim();
  navigator.clipboard.writeText(text).then(()=>{btn.textContent='✓ Copied!';setTimeout(()=>{btn.textContent='📋 Copy'},2000)});
}
function escapeHTML(str){return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function copyProfileLink(btn,id){
  const url=window.location.origin+window.location.pathname+'#investor='+id;
  navigator.clipboard.writeText(url).then(()=>{btn.classList.add('copied');btn.innerHTML='✓ Copied!';setTimeout(()=>{btn.classList.remove('copied');btn.innerHTML='📋 Copy Link'},2000)});
}
function shareOnTwitter(name,id){
  const url=window.location.origin+window.location.pathname+'#investor='+id;
  const text='Check out '+name+' on Match Capital — investor discovery for founders';
  window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent(text)+'&url='+encodeURIComponent(url),'_blank','width=550,height=420');
}

// ===== FILTER BAR =====
let filtersOpen=true;
function toggleFilterSection(){
  filtersOpen=!filtersOpen;
  document.getElementById('filtersCollapsible').classList.toggle('collapsed',!filtersOpen);
  document.getElementById('filterToggleChevron').classList.toggle('open',filtersOpen);
}

// Sticky detection
const filterBarEl=document.getElementById('filterBar');
if(filterBarEl&&window.IntersectionObserver){
  const sentinel=document.createElement('div');
  sentinel.style.height='1px';sentinel.style.marginBottom='-1px';
  filterBarEl.parentNode.insertBefore(sentinel,filterBarEl);
  new IntersectionObserver(([e])=>{filterBarEl.classList.toggle('stuck',!e.isIntersecting)},{threshold:[1]}).observe(sentinel);
}

// Investor counts per chip
function updateChipCounts(){
  if(!investors.length)return;
  const counts={stage:{},sector:{},type:{},geo:{},entity:{}};
  investors.forEach(inv=>{
    inv.stages.forEach(s=>{counts.stage[s]=(counts.stage[s]||0)+1});
    inv.sectors.forEach(s=>{counts.sector[s]=(counts.sector[s]||0)+1});
    counts.type[inv.type]=(counts.type[inv.type]||0)+1;
    inv.geography.forEach(g=>{counts.geo[g]=(counts.geo[g]||0)+1});
    counts.entity[inv.entity]=(counts.entity[inv.entity]||0)+1;
  });
  document.querySelectorAll('.chip[data-filter]').forEach(chip=>{
    const f=chip.dataset.filter,v=chip.dataset.value;
    const c=counts[f]?.[v]||0;
    let span=chip.querySelector('.chip-count');
    if(!span){span=document.createElement('span');span.className='chip-count';chip.appendChild(span)}
    span.textContent='('+c+')';
  });
}

// Active chips & badge
function updateFilterUI(){
  const fc=getActiveFilterCount();
  const badge=document.getElementById('filterCountBadge');
  const clearBtn=document.getElementById('filterBarClear');
  badge.textContent=fc;
  badge.classList.toggle('hidden',fc===0);
  clearBtn.classList.toggle('hidden',fc===0);

  // Build active chips
  const container=document.getElementById('activeChips');
  let chips=[];
  Object.entries(activeFilters).forEach(([key,vals])=>{
    const labels={stage:'Stage',sector:'Sector',type:'Type',geo:'Geo',entity:'Entity'};
    const geoLabels={dmv:'DC/DMV',nyc:'NYC',sf_bay:'SF Bay',boston:'Boston',mid_atlantic:'Mid-Atlantic',europe:'Europe'};
    vals.forEach(v=>{
      const display=key==='geo'?(geoLabels[v]||v):v;
      chips.push(`<span class="active-chip">${labels[key]}: ${display} <span class="chip-x" onclick="removeFilter('${key}','${v.replace(/'/g,"\\'")}')" title="Remove">×</span></span>`);
    });
  });
  if(+checkMin.value>0)chips.push(`<span class="active-chip">Min: ${fmt(+checkMin.value)} <span class="chip-x" onclick="checkMin.value=0;updateCheckDisplay();renderResults()" title="Remove">×</span></span>`);
  if(+checkMax.value<25e6)chips.push(`<span class="active-chip">Max: ${fmt(+checkMax.value)} <span class="chip-x" onclick="checkMax.value=25e6;updateCheckDisplay();renderResults()" title="Remove">×</span></span>`);
  const actVal=document.getElementById('activityFilter').value;
  if(actVal!=='any')chips.push(`<span class="active-chip">Activity: Last ${actVal}mo <span class="chip-x" onclick="document.getElementById('activityFilter').value='any';renderResults()" title="Remove">×</span></span>`);
  container.innerHTML=chips.join('');
}

function removeFilter(key,value){
  activeFilters[key]=activeFilters[key].filter(v=>v!==value);
  // Deactivate matching chip button
  document.querySelectorAll(`.chip[data-filter="${key}"][data-value="${value}"]`).forEach(c=>{c.classList.remove('active');c.setAttribute('aria-checked','false')});
  if(activePreset){activePreset=null;document.querySelectorAll('.preset-btn.active').forEach(b=>b.classList.remove('active'))}
  renderResults();
}

// ===== RECENTLY VIEWED =====
const MAX_RECENT=10;
function loadRecentlyViewed(){return JSON.parse(localStorage.getItem('mc_recent')||'[]')}
function saveRecentlyViewed(list){localStorage.setItem('mc_recent',JSON.stringify(list))}
function trackView(id){
  let recent=loadRecentlyViewed();
  recent=recent.filter(r=>r.id!==id);
  recent.unshift({id,ts:Date.now()});
  if(recent.length>MAX_RECENT)recent=recent.slice(0,MAX_RECENT);
  saveRecentlyViewed(recent);
  renderRecentlyViewed();
}
function clearRecentlyViewed(){saveRecentlyViewed([]);renderRecentlyViewed()}
function removeFromRecent(e,id){
  e.stopPropagation();
  let recent=loadRecentlyViewed().filter(r=>r.id!==id);
  saveRecentlyViewed(recent);
  renderRecentlyViewed();
}
function timeAgo(ts){
  const diff=Date.now()-ts;
  const mins=Math.floor(diff/60000);
  if(mins<1)return'Just now';
  if(mins<60)return mins+'m ago';
  const hrs=Math.floor(mins/60);
  if(hrs<24)return hrs+'h ago';
  const days=Math.floor(hrs/24);
  return days+'d ago';
}
function renderRecentlyViewed(){
  const recent=loadRecentlyViewed();
  const container=document.getElementById('recentlyViewed');
  const scroll=document.getElementById('rvScroll');
  const count=document.getElementById('rvCount');
  if(!recent.length||!investors.length){container.classList.remove('show');return}
  // Filter to valid investors only
  const valid=recent.filter(r=>investors.find(i=>i.id===r.id));
  if(!valid.length){container.classList.remove('show');return}
  container.classList.add('show');
  count.textContent='('+valid.length+')';
  scroll.innerHTML=valid.map(r=>{
    const inv=investors.find(i=>i.id===r.id);
    if(!inv)return'';
    const isOrg=inv.entity==='organization';
    return`<div class="rv-card" onclick="openProfile('${inv.id}')">
      <button class="rv-remove" onclick="removeFromRecent(event,'${inv.id}')" aria-label="Remove from recent">×</button>
      <div class="rv-avatar${isOrg?' avatar-org':''}">${inv.photo?`<img src="${inv.photo}" alt="${inv.name}" class="rv-avatar-img" onerror="this.replaceWith(document.createTextNode('${isOrg?'🏢':initials(inv.name)}'))">`:isOrg?'🏢':initials(inv.name)}</div>
      <div class="rv-name">${inv.name}</div>
      <div class="rv-firm">${inv.firm||inv.type}</div>
      <div class="rv-time">${timeAgo(r.ts)}</div>
    </div>`;
  }).join('');
}

// ===== QUICK NOTES & TAGS =====
const TAG_COLORS=['red','orange','yellow','green','blue','purple','pink'];
function loadInvestorNotes(){return JSON.parse(localStorage.getItem('mc_notes')||'{}')}
function saveInvestorNotes(notes){localStorage.setItem('mc_notes',JSON.stringify(notes))}
function loadInvestorTags(){return JSON.parse(localStorage.getItem('mc_tags')||'{}')}
function saveInvestorTags(tags){localStorage.setItem('mc_tags',JSON.stringify(tags))}
function loadTagDefs(){return JSON.parse(localStorage.getItem('mc_tag_defs')||'[]')}
function saveTagDefs(defs){localStorage.setItem('mc_tag_defs',JSON.stringify(defs))}

// Get tags for an investor: [{name,color}]
function getInvestorTags(id){
  const tags=loadInvestorTags();
  const defs=loadTagDefs();
  return(tags[id]||[]).map(tname=>defs.find(d=>d.name===tname)).filter(Boolean);
}
function getInvestorNote(id){return(loadInvestorNotes())[id]||''}

function setInvestorNote(id,text){
  const notes=loadInvestorNotes();
  if(text.trim())notes[id]=text.trim();
  else delete notes[id];
  saveInvestorNotes(notes);
}

function addTagToInvestor(id,tagName){
  const tags=loadInvestorTags();
  if(!tags[id])tags[id]=[];
  if(!tags[id].includes(tagName))tags[id].push(tagName);
  saveInvestorTags(tags);
}
function removeTagFromInvestor(id,tagName){
  const tags=loadInvestorTags();
  if(!tags[id])return;
  tags[id]=tags[id].filter(t=>t!==tagName);
  if(!tags[id].length)delete tags[id];
  saveInvestorTags(tags);
}

function addTagDef(name,color){
  const defs=loadTagDefs();
  if(defs.find(d=>d.name===name))return false;
  defs.push({name,color});
  saveTagDefs(defs);
  return true;
}
function removeTagDef(name){
  let defs=loadTagDefs();
  defs=defs.filter(d=>d.name!==name);
  saveTagDefs(defs);
  // Remove from all investors
  const tags=loadInvestorTags();
  Object.keys(tags).forEach(id=>{tags[id]=tags[id].filter(t=>t!==name);if(!tags[id].length)delete tags[id]});
  saveInvestorTags(tags);
}

// Render note/tag bar on saved cards
function notesTagsHTML(investorId){
  const note=getInvestorNote(investorId);
  const tags=getInvestorTags(investorId);
  if(!note&&!tags.length)return'';
  let html='<div class="card-notes-bar">';
  if(tags.length)html+='<div class="card-user-tags">'+tags.map(t=>`<span class="user-tag user-tag-${t.color}">${t.name}</span>`).join('')+'</div>';
  if(note)html+=`<div class="card-note-preview">📝 ${note}</div>`;
  html+='</div>';
  return html;
}

// Notes/tags section in profile modal
function notesTagsModalHTML(investorId){
  const note=getInvestorNote(investorId);
  const itags=loadInvestorTags()[investorId]||[];
  const defs=loadTagDefs();
  let newColor='blue';

  let html=`<div class="notes-section">
    <h3><span class="notes-icon">📝</span> Your Notes & Tags</h3>
    <textarea class="note-textarea" id="noteText-${investorId}" placeholder="Add private notes about this investor... (e.g., intro via Sarah, follow up after demo day)"
      oninput="noteChanged('${investorId}')">${note}</textarea>
    <div class="note-save-hint" id="noteHint-${investorId}">✓ Saved</div>
    <div class="tag-editor">
      <div class="tag-editor-label">Tags</div>
      <div class="tag-editor-list" id="tagList-${investorId}">`;
  defs.forEach(d=>{
    const isOn=itags.includes(d.name);
    html+=`<span class="user-tag user-tag-${d.color} ${isOn?'selected':''}" onclick="toggleTagOnInvestor('${investorId}','${d.name.replace(/'/g,"\\'")}')">${d.name}${isOn?' ✓':''}<span class="tag-x" onclick="event.stopPropagation();deleteTagDef('${investorId}','${d.name.replace(/'/g,"\\'")}')">×</span></span>`;
  });
  html+=`</div>
      <div class="tag-add-row">
        <input class="tag-add-input" id="tagInput-${investorId}" placeholder="New tag..." onkeydown="if(event.key==='Enter')addNewTag('${investorId}')">
        <div class="tag-color-picker" id="tagColorPicker-${investorId}">
          ${TAG_COLORS.map(c=>`<div class="tag-color-dot tag-color-dot-${c} ${c==='blue'?'selected':''}" onclick="selectTagColor('${investorId}','${c}')" data-color="${c}"></div>`).join('')}
        </div>
        <button class="tag-add-btn" onclick="addNewTag('${investorId}')">+ Add</button>
      </div>
    </div>
  </div>`;
  return html;
}

let noteDebounce={};
function noteChanged(investorId){
  clearTimeout(noteDebounce[investorId]);
  noteDebounce[investorId]=setTimeout(()=>{
    const text=document.getElementById('noteText-'+investorId).value;
    setInvestorNote(investorId,text);
    const hint=document.getElementById('noteHint-'+investorId);
    hint.classList.add('show');
    setTimeout(()=>hint.classList.remove('show'),1500);
  },500);
}

function getSelectedTagColor(investorId){
  const picker=document.getElementById('tagColorPicker-'+investorId);
  const sel=picker?.querySelector('.selected');
  return sel?.dataset.color||'blue';
}
function selectTagColor(investorId,color){
  const picker=document.getElementById('tagColorPicker-'+investorId);
  picker.querySelectorAll('.tag-color-dot').forEach(d=>d.classList.toggle('selected',d.dataset.color===color));
}

function addNewTag(investorId){
  const input=document.getElementById('tagInput-'+investorId);
  const name=input.value.trim();
  if(!name)return;
  const color=getSelectedTagColor(investorId);
  addTagDef(name,color);
  addTagToInvestor(investorId,name);
  input.value='';
  // Re-render tag list in modal
  refreshModalTags(investorId);
}

function toggleTagOnInvestor(investorId,tagName){
  const tags=loadInvestorTags();
  const current=tags[investorId]||[];
  if(current.includes(tagName))removeTagFromInvestor(investorId,tagName);
  else addTagToInvestor(investorId,tagName);
  refreshModalTags(investorId);
}

function deleteTagDef(investorId,tagName){
  if(!confirm('Delete tag "'+tagName+'" from all investors?'))return;
  removeTagDef(tagName);
  refreshModalTags(investorId);
}

function refreshModalTags(investorId){
  const container=document.getElementById('tagList-'+investorId);
  if(!container)return;
  const itags=loadInvestorTags()[investorId]||[];
  const defs=loadTagDefs();
  container.innerHTML=defs.map(d=>{
    const isOn=itags.includes(d.name);
    return`<span class="user-tag user-tag-${d.color} ${isOn?'selected':''}" onclick="toggleTagOnInvestor('${investorId}','${d.name.replace(/'/g,"\\'")}')">${d.name}${isOn?' ✓':''}<span class="tag-x" onclick="event.stopPropagation();deleteTagDef('${investorId}','${d.name.replace(/'/g,"\\'")}')">×</span></span>`;
  }).join('');
}

// Saved view tag filter state
let savedTagFilter=null;

function renderSavedTagFilter(savedInvestorIds){
  const container=document.getElementById('savedTagFilter');
  const defs=loadTagDefs();
  const allTags=loadInvestorTags();
  // Only show tags that appear on saved investors
  const usedTags=new Set();
  savedInvestorIds.forEach(id=>{(allTags[id]||[]).forEach(t=>usedTags.add(t))});
  const relevantDefs=defs.filter(d=>usedTags.has(d.name));
  if(!relevantDefs.length){container.style.display='none';return}
  container.style.display='flex';
  container.innerHTML='<span class="saved-tag-filter-label">Filter by tag:</span>'+
    relevantDefs.map(d=>`<span class="user-tag user-tag-${d.color} ${savedTagFilter===d.name?'filter-active':''}" onclick="toggleSavedTagFilter('${d.name.replace(/'/g,"\\'")}')">${d.name}</span>`).join('')+
    (savedTagFilter?'<span class="user-tag" onclick="toggleSavedTagFilter(null)" style="cursor:pointer;opacity:0.6">✕ Clear</span>':'');
}

function toggleSavedTagFilter(tagName){
  savedTagFilter=savedTagFilter===tagName?null:tagName;
  renderSaved();
}

// ===== PWA =====
let deferredInstallPrompt=null;
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').then(reg=>{
    // Check for updates every 30 min
    setInterval(()=>reg.update(),1800000);
    reg.addEventListener('updatefound',()=>{
      const nw=reg.installing;
      nw.addEventListener('statechange',()=>{
        if(nw.state==='installed'&&navigator.serviceWorker.controller){
          showOfflineToast('Update available — refresh to get the latest version.');
        }
      });
    });
  }).catch(e=>console.warn('SW registration failed:',e));
}
window.addEventListener('beforeinstallprompt',e=>{
  e.preventDefault();
  deferredInstallPrompt=e;
  showInstallBanner();
});
window.addEventListener('appinstalled',()=>{
  deferredInstallPrompt=null;
  hideInstallBanner();
});

function showInstallBanner(){
  if(document.getElementById('pwa-install-banner'))return;
  const b=document.createElement('div');
  b.id='pwa-install-banner';
  b.innerHTML=`<div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
    <span style="font-size:20px">📱</span>
    <span style="flex:1;min-width:180px"><strong>Install Match Capital</strong> for quick access &amp; offline use</span>
    <button onclick="pwaInstall()" style="padding:8px 20px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;font-size:14px">Install</button>
    <button onclick="hideInstallBanner()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;font-size:14px">Later</button>
  </div>`;
  Object.assign(b.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',
    background:'var(--card)',border:'1px solid var(--border)',borderRadius:'16px',padding:'16px 20px',
    zIndex:'10001',maxWidth:'480px',width:'calc(100% - 32px)',boxShadow:'0 8px 32px rgba(0,0,0,0.3)',
    animation:'slideUp .3s ease'});
  // On mobile, position at bottom edge
  if(window.innerWidth<=600){Object.assign(b.style,{bottom:'0',left:'0',right:'0',transform:'none',width:'100%',maxWidth:'100%',borderRadius:'16px 16px 0 0'})}
  document.body.appendChild(b);
}
function hideInstallBanner(){
  const b=document.getElementById('pwa-install-banner');
  if(b)b.remove();
}
function pwaInstall(){
  if(!deferredInstallPrompt)return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(()=>{deferredInstallPrompt=null;hideInstallBanner()});
}
function showOfflineToast(msg){
  const t=document.createElement('div');
  t.textContent=msg;
  Object.assign(t.style,{position:'fixed',bottom:'20px',left:'50%',transform:'translateX(-50%)',
    background:'var(--card)',border:'1px solid var(--accent)',borderRadius:'12px',padding:'12px 20px',
    zIndex:'10001',color:'var(--text)',fontSize:'14px',boxShadow:'0 4px 16px rgba(0,0,0,0.3)'});
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),6000);
}

// Offline indicator
window.addEventListener('online',()=>showOfflineToast('You\u2019re back online!'));
window.addEventListener('offline',()=>showOfflineToast('You\u2019re offline — cached data still available.'));

// ===== MOBILE: COLLAPSE FILTERS BY DEFAULT =====
(function(){
  if(window.innerWidth<=600){
    filtersOpen=false;
    var fc=document.getElementById('filtersCollapsible');
    var ch=document.getElementById('filterToggleChevron');
    if(fc)fc.classList.add('collapsed');
    if(ch)ch.classList.remove('open');
  }
})();

// ===== MAP VIEW =====
const CITY_COORDS={
  'New York':{lat:40.7,lng:-74},'NYC':{lat:40.7,lng:-74},
  'San Francisco':{lat:37.8,lng:-122.4},'SF':{lat:37.8,lng:-122.4},
  'Boston':{lat:42.4,lng:-71.1},'Washington':{lat:38.9,lng:-77},'DC':{lat:38.9,lng:-77},
  'Los Angeles':{lat:34.1,lng:-118.2},'LA':{lat:34.1,lng:-118.2},
  'Austin':{lat:30.3,lng:-97.7},'Chicago':{lat:41.9,lng:-87.6},
  'Seattle':{lat:47.6,lng:-122.3},'Miami':{lat:25.8,lng:-80.2},
  'Denver':{lat:39.7,lng:-105},'Boulder':{lat:40,lng:-105.3},
  'Atlanta':{lat:33.7,lng:-84.4},'Menlo Park':{lat:37.45,lng:-122.18},
  'Palo Alto':{lat:37.44,lng:-122.16},'Mountain View':{lat:37.39,lng:-122.08},
  'Santa Clara':{lat:37.35,lng:-121.95},'Oakland':{lat:37.8,lng:-122.27},
  'San Diego':{lat:32.7,lng:-117.2},'Salt Lake City':{lat:40.76,lng:-111.89},
  'Provo':{lat:40.23,lng:-111.66},'McLean':{lat:38.93,lng:-77.18},
  'Alexandria':{lat:38.8,lng:-77.05},'College Park':{lat:38.98,lng:-76.94},
  'Owings Mills':{lat:39.42,lng:-76.78},'Potomac':{lat:39.02,lng:-77.2},
  'Northern Virginia':{lat:38.85,lng:-77.3},'Virginia':{lat:37.5,lng:-78.5},
  'Newton':{lat:42.34,lng:-71.21},'Lynnwood':{lat:47.82,lng:-122.32},
  'Holbrook':{lat:40.79,lng:-73.08},
  'London':{lat:51.5,lng:-0.12},'Paris':{lat:48.86,lng:2.35},'Berlin':{lat:52.52,lng:13.4},
  'Singapore':{lat:1.35,lng:103.82},'Hong Kong':{lat:22.3,lng:114.17},
  'Copenhagen':{lat:55.68,lng:12.57},'Stockholm':{lat:59.33,lng:18.07},
  'Mumbai':{lat:19.08,lng:72.88},'Bangalore':{lat:12.97,lng:77.59},
  'Buenos Aires':{lat:-34.6,lng:-58.38},'Amsterdam':{lat:52.37,lng:4.9}
};
function locationToCity(loc){
  if(!loc)return null;
  const parts=loc.split('/').map(s=>s.trim());
  const results=[];
  for(const p of parts){
    const city=p.split(',')[0].trim().replace(/^(LYNNWOOD|BOSTON|MIAMI|HOLBROOK|NEWTON|SAN FRANCISCO).*$/i,m=>m.split(',')[0].trim());
    const normalized=city.charAt(0).toUpperCase()+city.slice(1).toLowerCase();
    // Try exact match first
    for(const[k,v] of Object.entries(CITY_COORDS)){
      if(city.toLowerCase()===k.toLowerCase()||normalized===k){results.push({city:k,...v,origLoc:p.trim()});break}
    }
  }
  return results.length?results:null;
}
function clusterInvestors(investorList){
  const clusters={};
  for(const inv of investorList){
    const cities=locationToCity(inv.location);
    if(!cities)continue;
    for(const c of cities){
      const key=c.city;
      if(!clusters[key])clusters[key]={city:key,lat:c.lat,lng:c.lng,investors:[],origLoc:c.origLoc};
      clusters[key].investors.push(inv);
    }
  }
  // Merge nearby clusters (within ~0.5 deg) into the larger one
  const arr=Object.values(clusters);
  const merged=[];
  const used=new Set();
  arr.sort((a,b)=>b.investors.length-a.investors.length);
  for(let i=0;i<arr.length;i++){
    if(used.has(i))continue;
    const c={...arr[i],investors:[...arr[i].investors]};
    for(let j=i+1;j<arr.length;j++){
      if(used.has(j))continue;
      const d=Math.abs(c.lat-arr[j].lat)+Math.abs(c.lng-arr[j].lng);
      if(d<0.5){c.investors.push(...arr[j].investors);used.add(j)}
    }
    merged.push(c);used.add(i);
  }
  return merged;
}
function getClusterColor(investors){
  const stages={seed:0,series_a:0,growth:0};
  for(const inv of investors){
    if(inv.stages)for(const s of inv.stages){
      if(s==='seed'||s==='pre_seed')stages.seed++;
      else if(s==='series_a')stages.series_a++;
      else if(s==='series_b'||s==='growth'||s==='late_stage')stages.growth++;
    }
  }
  const max=Math.max(stages.seed,stages.series_a,stages.growth);
  if(max===0)return '#8b8b9a';
  if(stages.seed===max)return '#10b981';
  if(stages.series_a===max)return '#6366f1';
  return '#a855f7';
}
// US-focused Albers projection (approximate)
function projectGeo(lat,lng,w,h){
  // Simple Mercator-ish for US, with padding
  // Map bounds: lat 24-50, lng -125 to -66
  const usOnly=lng>=-130&&lng<=-60&&lat>=24&&lat<=50;
  if(!usOnly)return null; // skip non-US for the US map
  const x=((lng+125)/(125-66))*w;
  const y=((50-lat)/(50-24))*h;
  return{x,y};
}
let currentView='grid';
function setView(view){
  currentView=view;
  document.querySelectorAll('.view-switcher button').forEach(b=>b.classList.toggle('active',b.dataset.view===view));
  document.getElementById('mapContainer').classList.toggle('active',view==='map');
  document.getElementById('resultsGrid').style.display=view==='grid'?'':'none';
  const lmc=document.getElementById('loadMoreContainer');
  if(lmc)lmc.style.display=view==='grid'?'':'none';
  if(view==='map')renderMap();
}
function renderMap(){
  const wrap=document.getElementById('mapSvgWrap');
  const filtered=getFilteredInvestors?getFilteredInvestors():investors;
  const clusters=clusterInvestors(filtered);
  const W=900,H=500;
  // Build SVG
  let svg=`<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg" style="overflow:visible">`;
  // US outline (simplified)
  svg+=`<rect x="0" y="0" width="${W}" height="${H}" fill="var(--bg-subtle)" rx="12"/>`;
  // Simple US boundary path (very simplified)
  svg+=`<path d="M60,120 L120,100 L200,95 L280,80 L340,85 L380,100 L420,90 L480,95 L540,100 L600,110 L660,95 L720,100 L780,90 L830,110 L840,140 L845,180 L830,220 L810,260 L780,300 L740,340 L700,360 L660,380 L600,390 L540,380 L480,370 L420,360 L380,380 L340,400 L300,390 L260,370 L220,340 L180,300 L140,260 L100,230 L70,190 L55,160 Z" fill="var(--border)" opacity="0.3" stroke="var(--text-dim)" stroke-width="0.5" stroke-opacity="0.3"/>`;

  const maxCount=Math.max(...clusters.map(c=>c.investors.length),1);
  const clusterData=[];
  for(const cluster of clusters){
    const pos=projectGeo(cluster.lat,cluster.lng,W,H);
    if(!pos)continue;
    const count=cluster.investors.length;
    const r=Math.max(14,Math.min(40,10+Math.sqrt(count/maxCount)*30));
    const color=getClusterColor(cluster.investors);
    const idx=clusterData.length;
    clusterData.push(cluster);
    svg+=`<g class="map-cluster" data-idx="${idx}" onmouseenter="showMapTooltip(event,${idx})" onmouseleave="hideMapTooltip()" onclick="filterByCluster(${idx})">`;
    svg+=`<circle cx="${pos.x}" cy="${pos.y}" r="${r}" fill="${color}" opacity="0.85"/>`;
    svg+=`<circle cx="${pos.x}" cy="${pos.y}" r="${r}" fill="none" stroke="${color}" stroke-width="2" opacity="0.4"/>`;
    if(count>1)svg+=`<text x="${pos.x}" y="${pos.y}" font-size="${r>20?13:11}">${count}</text>`;
    else svg+=`<text x="${pos.x}" y="${pos.y}" font-size="9">${cluster.investors[0].name.split(' ')[0]}</text>`;
    svg+=`</g>`;
  }
  svg+=`</svg>`;
  wrap.innerHTML=svg;
  window._mapClusters=clusterData;
}
function showMapTooltip(evt,idx){
  const cluster=window._mapClusters[idx];
  if(!cluster)return;
  const tt=document.getElementById('mapTooltip');
  const names=cluster.investors.slice(0,5).map(i=>i.name).join(', ');
  const more=cluster.investors.length>5?` +${cluster.investors.length-5} more`:'';
  tt.innerHTML=`<div class="tt-city">${cluster.city}</div><div class="tt-count">${cluster.investors.length} investor${cluster.investors.length>1?'s':''}</div><div class="tt-names">${names}${more}</div>`;
  tt.classList.add('visible');
  const wrap=document.getElementById('mapSvgWrap');
  const rect=wrap.getBoundingClientRect();
  const x=evt.clientX-rect.left+10;
  const y=evt.clientY-rect.top-10;
  tt.style.left=Math.min(x,rect.width-250)+'px';
  tt.style.top=y+'px';
}
function hideMapTooltip(){document.getElementById('mapTooltip').classList.remove('visible')}
function filterByCluster(idx){
  const cluster=window._mapClusters[idx];
  if(!cluster)return;
  // Find matching geography chip or set search
  const cityLower=cluster.city.toLowerCase();
  const locTerms=cluster.investors.map(i=>i.location).filter(Boolean);
  // Try to find a geo chip
  const geoChips=document.querySelectorAll('[data-filter="geography"] .chip');
  let matched=false;
  geoChips.forEach(chip=>{
    const val=chip.dataset.value||'';
    if(val&&locTerms.some(l=>l.toLowerCase().includes(val.toLowerCase()))){
      if(!chip.classList.contains('active'))chip.click();
      matched=true;
    }
  });
  if(!matched){
    // Fall back to search
    const searchInput=document.getElementById('searchInput');
    if(searchInput){searchInput.value=cluster.city;searchInput.dispatchEvent(new Event('input'))}
  }
  setView('grid');
}
// Expose filtered list for map
window.getFilteredInvestors=function(){return lastFiltered||investors};

// ===== MOBILE SWIPE GESTURES =====
const dismissedIds=new Set();
let swipeUndoTimeout=null;

function isTouchDevice(){return 'ontouchstart' in window || navigator.maxTouchPoints>0}

function attachSwipeHandlers(){
  if(!isTouchDevice()||window.innerWidth>768)return;
  document.querySelectorAll('#resultsGrid .investor-card').forEach(card=>{
    if(card._swipeAttached)return;
    card._swipeAttached=true;
    // Add swipe indicator overlays
    if(!card.querySelector('.swipe-indicator')){
      card.insertAdjacentHTML('afterbegin','<div class="swipe-indicator save">✓ Save</div><div class="swipe-indicator dismiss">✕ Skip</div>');
    }
    let startX=0,startY=0,dx=0,isSwipe=false,locked=false;
    card.addEventListener('touchstart',e=>{
      if(e.touches.length!==1)return;
      startX=e.touches[0].clientX;startY=e.touches[0].clientY;dx=0;isSwipe=false;locked=false;
    },{passive:true});
    card.addEventListener('touchmove',e=>{
      if(e.touches.length!==1||locked)return;
      const cx=e.touches[0].clientX,cy=e.touches[0].clientY;
      const diffX=cx-startX,diffY=cy-startY;
      // Lock direction after 10px movement
      if(!isSwipe&&Math.abs(diffX)<10&&Math.abs(diffY)<10)return;
      if(!isSwipe){
        if(Math.abs(diffY)>Math.abs(diffX)){locked=true;return} // vertical scroll
        isSwipe=true;card.classList.add('swiping');
      }
      e.preventDefault();
      dx=diffX;
      const pct=Math.min(Math.abs(dx)/150,1);
      const rotate=dx*0.05;
      card.style.transform=`translateX(${dx}px) rotate(${rotate}deg)`;
      const saveInd=card.querySelector('.swipe-indicator.save');
      const dismissInd=card.querySelector('.swipe-indicator.dismiss');
      if(dx>30){saveInd.style.opacity=pct;dismissInd.style.opacity=0}
      else if(dx<-30){dismissInd.style.opacity=pct;saveInd.style.opacity=0}
      else{saveInd.style.opacity=0;dismissInd.style.opacity=0}
    },{passive:false});
    card.addEventListener('touchend',()=>{
      if(!isSwipe){card.classList.remove('swiping');return}
      const threshold=80;
      const investorId=card.getAttribute('data-investor-id');
      if(dx>threshold){
        // Swipe right = save
        card.classList.remove('swiping');card.classList.add('swipe-exit-right');
        const listName=currentListName||Object.keys(namedLists)[0]||'Saved';
        if(!namedLists[listName])namedLists[listName]=[];
        if(!namedLists[listName].includes(investorId)){
          namedLists[listName].push(investorId);saveLists();updateSavedCount();
        }
        showSwipeToast('Saved to "'+listName+'"',investorId,'save');
        setTimeout(()=>{card.style.display='none'},300);
      }else if(dx<-threshold){
        // Swipe left = dismiss
        card.classList.remove('swiping');card.classList.add('swipe-exit-left');
        dismissedIds.add(investorId);
        showSwipeToast('Skipped',investorId,'dismiss');
        setTimeout(()=>{card.style.display='none'},300);
      }else{
        // Snap back
        card.classList.remove('swiping');
        card.style.transition='transform 0.3s ease, opacity 0.3s ease';
        card.style.transform='';
        const saveInd=card.querySelector('.swipe-indicator.save');
        const dismissInd=card.querySelector('.swipe-indicator.dismiss');
        if(saveInd)saveInd.style.opacity=0;if(dismissInd)dismissInd.style.opacity=0;
        setTimeout(()=>{card.style.transition=''},300);
      }
    },{passive:true});
  });
}

function showSwipeToast(msg,investorId,type){
  const existing=document.querySelector('.swipe-undo-toast');if(existing)existing.remove();
  clearTimeout(swipeUndoTimeout);
  const toast=document.createElement('div');toast.className='swipe-undo-toast';
  toast.innerHTML=`<span>${type==='save'?'✓':'✕'} ${msg}</span><button onclick="undoSwipe('${investorId}','${type}')">Undo</button>`;
  document.body.appendChild(toast);
  swipeUndoTimeout=setTimeout(()=>{toast.remove()},4000);
  removeSwipeHint();
}

function undoSwipe(investorId,type){
  const toast=document.querySelector('.swipe-undo-toast');if(toast)toast.remove();
  clearTimeout(swipeUndoTimeout);
  if(type==='save'){
    const listName=currentListName||Object.keys(namedLists)[0]||'Saved';
    const list=namedLists[listName]||[];
    const idx=list.indexOf(investorId);if(idx>=0)list.splice(idx,1);
    saveLists();updateSavedCount();
  }else{
    dismissedIds.delete(investorId);
  }
  renderResults(false);
}

// Inject swipe hint above results grid
function addSwipeHint(){
  if(!isTouchDevice()||window.innerWidth>768||localStorage.getItem('mc_swipe_hint_seen'))return;
  const grid=document.getElementById('resultsGrid');
  if(grid&&!document.getElementById('swipeHint')){
    grid.insertAdjacentHTML('beforebegin','<div class="swipe-hint" id="swipeHint"><span>👈 Swipe left to skip</span><span>•</span><span>Swipe right to save 👉</span></div>');
  }
}

// Patch renderResults to attach swipe handlers and filter dismissed
const _origRenderResults=renderResults;
// We can't reassign const, so we hook via a MutationObserver on the grid
const _swipeObserver=new MutationObserver(()=>{
  // Hide dismissed cards
  document.querySelectorAll('#resultsGrid .investor-card').forEach(card=>{
    const id=card.getAttribute('data-investor-id');
    if(dismissedIds.has(id))card.style.display='none';
  });
  attachSwipeHandlers();
});
document.addEventListener('DOMContentLoaded',()=>{
  const grid=document.getElementById('resultsGrid');
  if(grid){
    _swipeObserver.observe(grid,{childList:true});
    addSwipeHint();
  }
});
// Also hook after init since DOMContentLoaded may have fired
setTimeout(()=>{
  const grid=document.getElementById('resultsGrid');
  if(grid){_swipeObserver.observe(grid,{childList:true});addSwipeHint()}
  attachSwipeHandlers();
},500);

// Hide swipe hint after first swipe
let _swipeHintRemoved=false;
function removeSwipeHint(){
  if(_swipeHintRemoved)return;_swipeHintRemoved=true;
  const hint=document.getElementById('swipeHint');
  if(hint){hint.style.transition='opacity 0.3s';hint.style.opacity='0';setTimeout(()=>hint.remove(),300)}
  localStorage.setItem('mc_swipe_hint_seen','1');
}

// ===== GO =====
initOnboarding();
init();
</script>
</body>
</html>
